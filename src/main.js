"use strict";var yt=Object.create;var Ee=Object.defineProperty;var gt=Object.getOwnPropertyDescriptor;var bt=Object.getOwnPropertyNames;var xt=Object.getPrototypeOf,vt=Object.prototype.hasOwnProperty;var wt=(p,a)=>()=>(a||p((a={exports:{}}).exports,a),a.exports),St=(p,a)=>{for(var m in a)Ee(p,m,{get:a[m],enumerable:!0})},Ve=(p,a,m,l)=>{if(a&&typeof a=="object"||typeof a=="function")for(let v of bt(a))!vt.call(p,v)&&v!==m&&Ee(p,v,{get:()=>a[v],enumerable:!(l=gt(a,v))||l.enumerable});return p};var kt=(p,a,m)=>(m=p!=null?yt(xt(p)):{},Ve(a||!p||!p.__esModule?Ee(m,"default",{value:p,enumerable:!0}):m,p)),Et=p=>Ve(Ee({},"__esModule",{value:!0}),p);var mt=wt((Vi,ut)=>{"use strict";var Ct=Object.create,Te=Object.defineProperty,Pt=Object.getOwnPropertyDescriptor,Tt=Object.getOwnPropertyNames,Ot=Object.getPrototypeOf,Lt=Object.prototype.hasOwnProperty,z=(p,a)=>()=>(a||p((a={exports:{}}).exports,a),a.exports),Nt=(p,a)=>{for(var m in a)Te(p,m,{get:a[m],enumerable:!0})},Qe=(p,a,m,l)=>{if(a&&typeof a=="object"||typeof a=="function")for(let v of Tt(a))!Lt.call(p,v)&&v!==m&&Te(p,v,{get:()=>a[v],enumerable:!(l=Pt(a,v))||l.enumerable});return p},ne=(p,a,m)=>(m=p!=null?Ct(Ot(p)):{},Qe(a||!p||!p.__esModule?Te(m,"default",{value:p,enumerable:!0}):m,p)),jt=p=>Qe(Te({},"__esModule",{value:!0}),p),It=z((p,a)=>{"use strict";function m(y,s,d="  ",e=""){return i(y,s,d===!1?"":d,e,[]);function i(u,o,c,k,_){let t=k+c;switch(u=o?o(u):u,typeof u){case"string":return JSON.stringify(u);case"number":return Object.is(u,-0)?"-0":String(u);case"boolean":case"undefined":return String(u);case"function":return u.toString()}if(u===null)return"null";if(u instanceof RegExp)return u.toString();if(u instanceof Date)return`new Date(${u.getTime()})`;if(u instanceof Set)return`new Set(${i(Array.from(u.values()),o,c,t,_)})`;if(u instanceof Map)return`new Map(${i(Array.from(u.entries()),o,c,t,_)})`;if(_.indexOf(u)>=0)return"{$circularReference:1}";_.push(u);function r(f){return c.slice(1)+f.join(","+(c&&`
`)+t)+(c?" ":"")}if(Array.isArray(u))return`[${r(u.map(f=>i(f,o,c,t,_.slice())))}]`;let S=Object.keys(u);return S.length?`{${r(S.map(f=>(v(f)?f:JSON.stringify(f))+":"+i(u[f],o,c,t,_.slice())))}}`:"{}"}}var l=/^(abstract|boolean|break|byte|case|catch|char|class|const|continue|debugger|default|delete|do|double|else|enum|export|extends|false|final|finally|float|for|function|goto|if|implements|import|in|instanceof|int|interface|long|native|new|null|package|private|protected|public|return|short|static|super|switch|synchronized|this|throw|throws|transient|true|try|typeof|undefined|var|void|volatile|while|with)$/;function v(y){return/^([a-z_$][0-9a-z_$]*|[0-9]+)$/gi.test(y)&&!l.test(y)}a.exports=m}),Ut=z((p,a)=>{"use strict";function m(){this._types=Object.create(null),this._extensions=Object.create(null);for(let l=0;l<arguments.length;l++)this.define(arguments[l]);this.define=this.define.bind(this),this.getType=this.getType.bind(this),this.getExtension=this.getExtension.bind(this)}m.prototype.define=function(l,v){for(let y in l){let s=l[y].map(function(d){return d.toLowerCase()});y=y.toLowerCase();for(let d=0;d<s.length;d++){let e=s[d];if(e[0]!=="*"){if(!v&&e in this._types)throw new Error('Attempt to change mapping for "'+e+'" extension from "'+this._types[e]+'" to "'+y+'". Pass `force=true` to allow this, otherwise remove "'+e+'" from the list of extensions for "'+y+'".');this._types[e]=y}}if(v||!this._extensions[y]){let d=s[0];this._extensions[y]=d[0]!=="*"?d:d.substr(1)}}},m.prototype.getType=function(l){l=String(l);let v=l.replace(/^.*[/\\]/,"").toLowerCase(),y=v.replace(/^.*\./,"").toLowerCase(),s=v.length<l.length;return(y.length<v.length-1||!s)&&this._types[y]||null},m.prototype.getExtension=function(l){return l=/^\s*([^;\s]*)/.test(l)&&RegExp.$1,l&&this._extensions[l.toLowerCase()]||null},a.exports=m}),Mt=z((p,a)=>{a.exports={"application/andrew-inset":["ez"],"application/applixware":["aw"],"application/atom+xml":["atom"],"application/atomcat+xml":["atomcat"],"application/atomdeleted+xml":["atomdeleted"],"application/atomsvc+xml":["atomsvc"],"application/atsc-dwd+xml":["dwd"],"application/atsc-held+xml":["held"],"application/atsc-rsat+xml":["rsat"],"application/bdoc":["bdoc"],"application/calendar+xml":["xcs"],"application/ccxml+xml":["ccxml"],"application/cdfx+xml":["cdfx"],"application/cdmi-capability":["cdmia"],"application/cdmi-container":["cdmic"],"application/cdmi-domain":["cdmid"],"application/cdmi-object":["cdmio"],"application/cdmi-queue":["cdmiq"],"application/cu-seeme":["cu"],"application/dash+xml":["mpd"],"application/davmount+xml":["davmount"],"application/docbook+xml":["dbk"],"application/dssc+der":["dssc"],"application/dssc+xml":["xdssc"],"application/ecmascript":["es","ecma"],"application/emma+xml":["emma"],"application/emotionml+xml":["emotionml"],"application/epub+zip":["epub"],"application/exi":["exi"],"application/express":["exp"],"application/fdt+xml":["fdt"],"application/font-tdpfr":["pfr"],"application/geo+json":["geojson"],"application/gml+xml":["gml"],"application/gpx+xml":["gpx"],"application/gxf":["gxf"],"application/gzip":["gz"],"application/hjson":["hjson"],"application/hyperstudio":["stk"],"application/inkml+xml":["ink","inkml"],"application/ipfix":["ipfix"],"application/its+xml":["its"],"application/java-archive":["jar","war","ear"],"application/java-serialized-object":["ser"],"application/java-vm":["class"],"application/javascript":["js","mjs"],"application/json":["json","map"],"application/json5":["json5"],"application/jsonml+json":["jsonml"],"application/ld+json":["jsonld"],"application/lgr+xml":["lgr"],"application/lost+xml":["lostxml"],"application/mac-binhex40":["hqx"],"application/mac-compactpro":["cpt"],"application/mads+xml":["mads"],"application/manifest+json":["webmanifest"],"application/marc":["mrc"],"application/marcxml+xml":["mrcx"],"application/mathematica":["ma","nb","mb"],"application/mathml+xml":["mathml"],"application/mbox":["mbox"],"application/mediaservercontrol+xml":["mscml"],"application/metalink+xml":["metalink"],"application/metalink4+xml":["meta4"],"application/mets+xml":["mets"],"application/mmt-aei+xml":["maei"],"application/mmt-usd+xml":["musd"],"application/mods+xml":["mods"],"application/mp21":["m21","mp21"],"application/mp4":["mp4s","m4p"],"application/msword":["doc","dot"],"application/mxf":["mxf"],"application/n-quads":["nq"],"application/n-triples":["nt"],"application/node":["cjs"],"application/octet-stream":["bin","dms","lrf","mar","so","dist","distz","pkg","bpk","dump","elc","deploy","exe","dll","deb","dmg","iso","img","msi","msp","msm","buffer"],"application/oda":["oda"],"application/oebps-package+xml":["opf"],"application/ogg":["ogx"],"application/omdoc+xml":["omdoc"],"application/onenote":["onetoc","onetoc2","onetmp","onepkg"],"application/oxps":["oxps"],"application/p2p-overlay+xml":["relo"],"application/patch-ops-error+xml":["xer"],"application/pdf":["pdf"],"application/pgp-encrypted":["pgp"],"application/pgp-signature":["asc","sig"],"application/pics-rules":["prf"],"application/pkcs10":["p10"],"application/pkcs7-mime":["p7m","p7c"],"application/pkcs7-signature":["p7s"],"application/pkcs8":["p8"],"application/pkix-attr-cert":["ac"],"application/pkix-cert":["cer"],"application/pkix-crl":["crl"],"application/pkix-pkipath":["pkipath"],"application/pkixcmp":["pki"],"application/pls+xml":["pls"],"application/postscript":["ai","eps","ps"],"application/provenance+xml":["provx"],"application/pskc+xml":["pskcxml"],"application/raml+yaml":["raml"],"application/rdf+xml":["rdf","owl"],"application/reginfo+xml":["rif"],"application/relax-ng-compact-syntax":["rnc"],"application/resource-lists+xml":["rl"],"application/resource-lists-diff+xml":["rld"],"application/rls-services+xml":["rs"],"application/route-apd+xml":["rapd"],"application/route-s-tsid+xml":["sls"],"application/route-usd+xml":["rusd"],"application/rpki-ghostbusters":["gbr"],"application/rpki-manifest":["mft"],"application/rpki-roa":["roa"],"application/rsd+xml":["rsd"],"application/rss+xml":["rss"],"application/rtf":["rtf"],"application/sbml+xml":["sbml"],"application/scvp-cv-request":["scq"],"application/scvp-cv-response":["scs"],"application/scvp-vp-request":["spq"],"application/scvp-vp-response":["spp"],"application/sdp":["sdp"],"application/senml+xml":["senmlx"],"application/sensml+xml":["sensmlx"],"application/set-payment-initiation":["setpay"],"application/set-registration-initiation":["setreg"],"application/shf+xml":["shf"],"application/sieve":["siv","sieve"],"application/smil+xml":["smi","smil"],"application/sparql-query":["rq"],"application/sparql-results+xml":["srx"],"application/srgs":["gram"],"application/srgs+xml":["grxml"],"application/sru+xml":["sru"],"application/ssdl+xml":["ssdl"],"application/ssml+xml":["ssml"],"application/swid+xml":["swidtag"],"application/tei+xml":["tei","teicorpus"],"application/thraud+xml":["tfi"],"application/timestamped-data":["tsd"],"application/toml":["toml"],"application/trig":["trig"],"application/ttml+xml":["ttml"],"application/ubjson":["ubj"],"application/urc-ressheet+xml":["rsheet"],"application/urc-targetdesc+xml":["td"],"application/voicexml+xml":["vxml"],"application/wasm":["wasm"],"application/widget":["wgt"],"application/winhlp":["hlp"],"application/wsdl+xml":["wsdl"],"application/wspolicy+xml":["wspolicy"],"application/xaml+xml":["xaml"],"application/xcap-att+xml":["xav"],"application/xcap-caps+xml":["xca"],"application/xcap-diff+xml":["xdf"],"application/xcap-el+xml":["xel"],"application/xcap-ns+xml":["xns"],"application/xenc+xml":["xenc"],"application/xhtml+xml":["xhtml","xht"],"application/xliff+xml":["xlf"],"application/xml":["xml","xsl","xsd","rng"],"application/xml-dtd":["dtd"],"application/xop+xml":["xop"],"application/xproc+xml":["xpl"],"application/xslt+xml":["*xsl","xslt"],"application/xspf+xml":["xspf"],"application/xv+xml":["mxml","xhvml","xvml","xvm"],"application/yang":["yang"],"application/yin+xml":["yin"],"application/zip":["zip"],"audio/3gpp":["*3gpp"],"audio/adpcm":["adp"],"audio/amr":["amr"],"audio/basic":["au","snd"],"audio/midi":["mid","midi","kar","rmi"],"audio/mobile-xmf":["mxmf"],"audio/mp3":["*mp3"],"audio/mp4":["m4a","mp4a"],"audio/mpeg":["mpga","mp2","mp2a","mp3","m2a","m3a"],"audio/ogg":["oga","ogg","spx","opus"],"audio/s3m":["s3m"],"audio/silk":["sil"],"audio/wav":["wav"],"audio/wave":["*wav"],"audio/webm":["weba"],"audio/xm":["xm"],"font/collection":["ttc"],"font/otf":["otf"],"font/ttf":["ttf"],"font/woff":["woff"],"font/woff2":["woff2"],"image/aces":["exr"],"image/apng":["apng"],"image/avif":["avif"],"image/bmp":["bmp"],"image/cgm":["cgm"],"image/dicom-rle":["drle"],"image/emf":["emf"],"image/fits":["fits"],"image/g3fax":["g3"],"image/gif":["gif"],"image/heic":["heic"],"image/heic-sequence":["heics"],"image/heif":["heif"],"image/heif-sequence":["heifs"],"image/hej2k":["hej2"],"image/hsj2":["hsj2"],"image/ief":["ief"],"image/jls":["jls"],"image/jp2":["jp2","jpg2"],"image/jpeg":["jpeg","jpg","jpe"],"image/jph":["jph"],"image/jphc":["jhc"],"image/jpm":["jpm"],"image/jpx":["jpx","jpf"],"image/jxr":["jxr"],"image/jxra":["jxra"],"image/jxrs":["jxrs"],"image/jxs":["jxs"],"image/jxsc":["jxsc"],"image/jxsi":["jxsi"],"image/jxss":["jxss"],"image/ktx":["ktx"],"image/ktx2":["ktx2"],"image/png":["png"],"image/sgi":["sgi"],"image/svg+xml":["svg","svgz"],"image/t38":["t38"],"image/tiff":["tif","tiff"],"image/tiff-fx":["tfx"],"image/webp":["webp"],"image/wmf":["wmf"],"message/disposition-notification":["disposition-notification"],"message/global":["u8msg"],"message/global-delivery-status":["u8dsn"],"message/global-disposition-notification":["u8mdn"],"message/global-headers":["u8hdr"],"message/rfc822":["eml","mime"],"model/3mf":["3mf"],"model/gltf+json":["gltf"],"model/gltf-binary":["glb"],"model/iges":["igs","iges"],"model/mesh":["msh","mesh","silo"],"model/mtl":["mtl"],"model/obj":["obj"],"model/step+xml":["stpx"],"model/step+zip":["stpz"],"model/step-xml+zip":["stpxz"],"model/stl":["stl"],"model/vrml":["wrl","vrml"],"model/x3d+binary":["*x3db","x3dbz"],"model/x3d+fastinfoset":["x3db"],"model/x3d+vrml":["*x3dv","x3dvz"],"model/x3d+xml":["x3d","x3dz"],"model/x3d-vrml":["x3dv"],"text/cache-manifest":["appcache","manifest"],"text/calendar":["ics","ifb"],"text/coffeescript":["coffee","litcoffee"],"text/css":["css"],"text/csv":["csv"],"text/html":["html","htm","shtml"],"text/jade":["jade"],"text/jsx":["jsx"],"text/less":["less"],"text/markdown":["markdown","md"],"text/mathml":["mml"],"text/mdx":["mdx"],"text/n3":["n3"],"text/plain":["txt","text","conf","def","list","log","in","ini"],"text/richtext":["rtx"],"text/rtf":["*rtf"],"text/sgml":["sgml","sgm"],"text/shex":["shex"],"text/slim":["slim","slm"],"text/spdx":["spdx"],"text/stylus":["stylus","styl"],"text/tab-separated-values":["tsv"],"text/troff":["t","tr","roff","man","me","ms"],"text/turtle":["ttl"],"text/uri-list":["uri","uris","urls"],"text/vcard":["vcard"],"text/vtt":["vtt"],"text/xml":["*xml"],"text/yaml":["yaml","yml"],"video/3gpp":["3gp","3gpp"],"video/3gpp2":["3g2"],"video/h261":["h261"],"video/h263":["h263"],"video/h264":["h264"],"video/iso.segment":["m4s"],"video/jpeg":["jpgv"],"video/jpm":["*jpm","jpgm"],"video/mj2":["mj2","mjp2"],"video/mp2t":["ts"],"video/mp4":["mp4","mp4v","mpg4"],"video/mpeg":["mpeg","mpg","mpe","m1v","m2v"],"video/ogg":["ogv"],"video/quicktime":["qt","mov"],"video/webm":["webm"]}}),At=z((p,a)=>{"use strict";var m=Ut();a.exports=new m(Mt())}),Rt=z((p,a)=>{"use strict";var m=Object.create,l=Object.defineProperty,v=Object.getOwnPropertyDescriptor,y=Object.getOwnPropertyNames,s=Object.getPrototypeOf,d=Object.prototype.hasOwnProperty,e=(h,w)=>{for(var g in w)l(h,g,{get:w[g],enumerable:!0})},i=(h,w,g,n)=>{if(w&&typeof w=="object"||typeof w=="function")for(let C of y(w))!d.call(h,C)&&C!==g&&l(h,C,{get:()=>w[C],enumerable:!(n=v(w,C))||n.enumerable});return h},u=(h,w,g)=>(g=h!=null?m(s(h)):{},i(w||!h||!h.__esModule?l(g,"default",{value:h,enumerable:!0}):g,h)),o=h=>i(l({},"__esModule",{value:!0}),h),c={};e(c,{ChatType:()=>r,MsgType:()=>S,SendType:()=>f,r:()=>t}),a.exports=o(c);var k=u(require("node:path")),_=()=>{let h={"payload/sendMsg":{msgId:"0",elements:[]},"peer/private":{chatType:1,guildId:"",peerUid:"",peerUin:""},"peer/group":{chatType:2,guildId:"",peerUid:"",peerUin:""}},w=(g,n)=>Object.assign({},h[g],n);return Object.defineProperties(w,Object.fromEntries(Object.entries({reg:h,peerPrivate:g=>w("peer/private",{peerUin:g}),peerGroup:g=>w("peer/group",{peerUin:g}),text:g=>({elementId:"",elementType:1,textElement:{content:g,atUid:"",atNtUid:"",atTinyUid:"",atType:0}}),at:(g,n)=>({elementId:"",elementType:1,textElement:{content:`@${g}`,atUid:n==="all"?"all":"",atNtUin:n==="all"?void 0:n,atNtUid:n==="all"?"all":void 0,atTinyUid:"",atType:n==="all"?1:2}}),remoteImage:(g,n)=>({elementId:"",elementType:2,extBufForUI:"",picElement:{fileName:k.default.basename(g.ntFilePath),fileSize:String(g.fileSize),fileSubId:"",fileUuid:"",md5HexStr:g.md5,original:!0,picHeight:g.imageInfo.height,picWidth:g.imageInfo.width,picType:n,picSubType:0,sourcePath:g.ntFilePath,summary:"",thumbFileSize:0}})}).map(([g,n])=>[g,{value:n}])))},t=_(),r=(h=>(h[h.Private=1]="Private",h[h.Group=2]="Group",h))(r||{}),S=(h=>(h[h.Normal=2]="Normal",h[h.Value3=3]="Value3",h[h.System=5]="System",h[h.Ptt=6]="Ptt",h[h.Video=7]="Video",h[h.Value8=8]="Value8",h[h.WithRecords=9]="WithRecords",h[h.Wallet=10]="Wallet",h[h.Ark=11]="Ark",h[h.Vaule17=17]="Vaule17",h))(S||{}),f=(h=>(h[h.Normal=0]="Normal",h[h.System=3]="System",h))(f||{})}),ze=z((p,a)=>{"use strict";function m(t){if(t.length===0)return;let r=Object.create(null),S=0;for(;S<t.length;++S){let g=t.charCodeAt(S);if(u[g]!==1){if(g!==47||S===0)return;break}}if(S===t.length)return;let f=t.slice(0,S).toLowerCase(),h=++S;for(;S<t.length;++S){let g=t.charCodeAt(S);if(u[g]!==1){if(S===h||l(t,S,r)===void 0)return;break}}if(S===h)return;let w=t.slice(h,S).toLowerCase();return{type:f,subtype:w,params:r}}function l(t,r,S){for(;r<t.length;){for(;r<t.length;++r){let n=t.charCodeAt(r);if(n!==32&&n!==9)break}if(r===t.length)break;if(t.charCodeAt(r++)!==59)return;for(;r<t.length;++r){let n=t.charCodeAt(r);if(n!==32&&n!==9)break}if(r===t.length)return;let f,h=r;for(;r<t.length;++r){let n=t.charCodeAt(r);if(u[n]!==1){if(n!==61)return;break}}if(r===t.length||(f=t.slice(h,r),++r,r===t.length))return;let w="",g;if(t.charCodeAt(r)===34){g=++r;let n=!1;for(;r<t.length;++r){let C=t.charCodeAt(r);if(C===92){n?(g=r,n=!1):(w+=t.slice(g,r),n=!0);continue}if(C===34){if(n){g=r,n=!1;continue}w+=t.slice(g,r);break}if(n&&(g=r-1,n=!1),o[C]!==1)return}if(r===t.length)return;++r}else{for(g=r;r<t.length;++r){let n=t.charCodeAt(r);if(u[n]!==1){if(r===g)return;break}}w=t.slice(g,r)}f=f.toLowerCase(),S[f]===void 0&&(S[f]=w)}return S}function v(t,r){if(t.length===0)return;let S=Object.create(null),f=0;for(;f<t.length;++f){let h=t.charCodeAt(f);if(u[h]!==1){if(y(t,f,S,r)===void 0)return;break}}return{type:t.slice(0,f).toLowerCase(),params:S}}function y(t,r,S,f){for(;r<t.length;){for(;r<t.length;++r){let b=t.charCodeAt(r);if(b!==32&&b!==9)break}if(r===t.length)break;if(t.charCodeAt(r++)!==59)return;for(;r<t.length;++r){let b=t.charCodeAt(r);if(b!==32&&b!==9)break}if(r===t.length)return;let h,w=r;for(;r<t.length;++r){let b=t.charCodeAt(r);if(u[b]!==1){if(b===61)break;return}}if(r===t.length)return;let g="",n,C;if(h=t.slice(w,r),h.charCodeAt(h.length-1)===42){let b=++r;for(;r<t.length;++r){let I=t.charCodeAt(r);if(c[I]!==1){if(I!==39)return;break}}if(r===t.length)return;for(C=t.slice(b,r),++r;r<t.length&&t.charCodeAt(r)!==39;++r);if(r===t.length||(++r,r===t.length))return;n=r;let N=0;for(;r<t.length;++r){let I=t.charCodeAt(r);if(k[I]!==1){if(I===37){let B,A;if(r+2<t.length&&(B=_[t.charCodeAt(r+1)])!==-1&&(A=_[t.charCodeAt(r+2)])!==-1){let P=(B<<4)+A;g+=t.slice(n,r),g+=String.fromCharCode(P),r+=2,n=r+1,P>=128?N=2:N===0&&(N=1);continue}return}break}}if(g+=t.slice(n,r),g=e(g,C,N),g===void 0)return}else{if(++r,r===t.length)return;if(t.charCodeAt(r)===34){n=++r;let b=!1;for(;r<t.length;++r){let N=t.charCodeAt(r);if(N===92){b?(n=r,b=!1):(g+=t.slice(n,r),b=!0);continue}if(N===34){if(b){n=r,b=!1;continue}g+=t.slice(n,r);break}if(b&&(n=r-1,b=!1),o[N]!==1)return}if(r===t.length)return;++r}else{for(n=r;r<t.length;++r){let b=t.charCodeAt(r);if(u[b]!==1){if(r===n)return;break}}g=t.slice(n,r)}if(g=f(g,2),g===void 0)return}h=h.toLowerCase(),S[h]===void 0&&(S[h]=g)}return S}function s(t){let r;for(;;)switch(t){case"utf-8":case"utf8":return d.utf8;case"latin1":case"ascii":case"us-ascii":case"iso-8859-1":case"iso8859-1":case"iso88591":case"iso_8859-1":case"windows-1252":case"iso_8859-1:1987":case"cp1252":case"x-cp1252":return d.latin1;case"utf16le":case"utf-16le":case"ucs2":case"ucs-2":return d.utf16le;case"base64":return d.base64;default:if(r===void 0){r=!0,t=t.toLowerCase();continue}return d.other.bind(t)}}var d={utf8:(t,r)=>{if(t.length===0)return"";if(typeof t=="string"){if(r<2)return t;t=Buffer.from(t,"latin1")}return t.utf8Slice(0,t.length)},latin1:(t,r)=>t.length===0?"":typeof t=="string"?t:t.latin1Slice(0,t.length),utf16le:(t,r)=>t.length===0?"":(typeof t=="string"&&(t=Buffer.from(t,"latin1")),t.ucs2Slice(0,t.length)),base64:(t,r)=>t.length===0?"":(typeof t=="string"&&(t=Buffer.from(t,"latin1")),t.base64Slice(0,t.length)),other:(t,r)=>{if(t.length===0)return"";typeof t=="string"&&(t=Buffer.from(t,"latin1"));try{return new TextDecoder(p).decode(t)}catch{}}};function e(t,r,S){let f=s(r);if(f)return f(t,S)}function i(t){if(typeof t!="string")return"";for(let r=t.length-1;r>=0;--r)switch(t.charCodeAt(r)){case 47:case 92:return t=t.slice(r+1),t===".."||t==="."?"":t}return t===".."||t==="."?"":t}var u=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,1,1,1,1,1,0,0,1,1,0,1,1,0,1,1,1,1,1,1,1,1,1,1,0,0,0,0,0,0,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,0,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,1,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],o=[0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],c=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,1,1,1,1,0,0,0,0,1,0,1,0,0,1,1,1,1,1,1,1,1,1,1,0,0,0,0,0,0,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,0,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],k=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,1,1,0,1,0,0,0,0,1,0,1,1,0,1,1,1,1,1,1,1,1,1,1,0,0,0,0,0,0,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,0,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,1,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],_=[-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,0,1,2,3,4,5,6,7,8,9,-1,-1,-1,-1,-1,-1,-1,10,11,12,13,14,15,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,10,11,12,13,14,15,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1];a.exports={basename:i,convertToUTF8:e,getDecoder:s,parseContentType:m,parseDisposition:v}}),Bt=z((p,a)=>{"use strict";function m(s,d,e,i,u){for(let o=0;o<u;++o)if(s[d+o]!==e[i+o])return!1;return!0}var l=class{constructor(s,d){if(typeof d!="function")throw new Error("Missing match callback");if(typeof s=="string")s=Buffer.from(s);else if(!Buffer.isBuffer(s))throw new Error(`Expected Buffer for needle, got ${typeof s}`);let e=s.length;if(this.maxMatches=1/0,this.matches=0,this._cb=d,this._lookbehindSize=0,this._needle=s,this._bufPos=0,this._lookbehind=Buffer.allocUnsafe(e),this._occ=[e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e],e>1)for(let i=0;i<e-1;++i)this._occ[s[i]]=e-1-i}reset(){this.matches=0,this._lookbehindSize=0,this._bufPos=0}push(s,d){let e;Buffer.isBuffer(s)||(s=Buffer.from(s,"latin1"));let i=s.length;for(this._bufPos=d||0;e!==i&&this.matches<this.maxMatches;)e=v(this,s);return e}destroy(){let s=this._lookbehindSize;s&&this._cb(!1,this._lookbehind,0,s,!1),this.reset()}};function v(s,d){let e=d.length,i=s._needle,u=i.length,o=-s._lookbehindSize,c=u-1,k=i[c],_=e-u,t=s._occ,r=s._lookbehind;if(o<0){for(;o<0&&o<=_;){let f=o+c,h=f<0?r[s._lookbehindSize+f]:d[f];if(h===k&&y(s,d,o,c))return s._lookbehindSize=0,++s.matches,o>-s._lookbehindSize?s._cb(!0,r,0,s._lookbehindSize+o,!1):s._cb(!0,void 0,0,0,!0),s._bufPos=o+u;o+=t[h]}for(;o<0&&!y(s,d,o,e-o);)++o;if(o<0){let f=s._lookbehindSize+o;return f>0&&s._cb(!1,r,0,f,!1),s._lookbehindSize-=f,r.copy(r,0,f,s._lookbehindSize),r.set(d,s._lookbehindSize),s._lookbehindSize+=e,s._bufPos=e,e}s._cb(!1,r,0,s._lookbehindSize,!1),s._lookbehindSize=0}o+=s._bufPos;let S=i[0];for(;o<=_;){let f=d[o+c];if(f===k&&d[o]===S&&m(i,0,d,o,c))return++s.matches,o>0?s._cb(!0,d,s._bufPos,o,!0):s._cb(!0,void 0,0,0,!0),s._bufPos=o+u;o+=t[f]}for(;o<e;){if(d[o]!==S||!m(d,o,i,0,e-o)){++o;continue}d.copy(r,0,o,e),s._lookbehindSize=e-o;break}return o>0&&s._cb(!1,d,s._bufPos,o<e?o:e,!0),s._bufPos=e,e}function y(s,d,e,i){let u=s._lookbehind,o=s._lookbehindSize,c=s._needle;for(let k=0;k<i;++k,++e)if((e<0?u[o+e]:d[e])!==c[k])return!1;return!0}a.exports=l}),Wt=z((p,a)=>{"use strict";var{Readable:m,Writable:l}=require("stream"),v=Bt(),{basename:y,convertToUTF8:s,getDecoder:d,parseContentType:e,parseDisposition:i}=ze(),u=Buffer.from(`\r
`),o=Buffer.from("\r"),c=Buffer.from("-");function k(){}var _=2e3,t=16*1024,r=0,S=1,f=2,h=class{constructor(P){this.header=Object.create(null),this.pairCount=0,this.byteCount=0,this.state=r,this.name="",this.value="",this.crlf=0,this.cb=P}reset(){this.header=Object.create(null),this.pairCount=0,this.byteCount=0,this.state=r,this.name="",this.value="",this.crlf=0}push(P,T,R){let U=T;for(;T<R;)switch(this.state){case r:{let q=!1;for(;T<R;++T){if(this.byteCount===t)return-1;++this.byteCount;let V=P[T];if(B[V]!==1){if(V!==58||(this.name+=P.latin1Slice(U,T),this.name.length===0))return-1;++T,q=!0,this.state=S;break}}if(!q){this.name+=P.latin1Slice(U,T);break}}case S:{let q=!1;for(;T<R;++T){if(this.byteCount===t)return-1;++this.byteCount;let V=P[T];if(V!==32&&V!==9){U=T,q=!0,this.state=f;break}}if(!q)break}case f:switch(this.crlf){case 0:for(;T<R;++T){if(this.byteCount===t)return-1;++this.byteCount;let q=P[T];if(A[q]!==1){if(q!==13)return-1;++this.crlf;break}}this.value+=P.latin1Slice(U,T++);break;case 1:if(this.byteCount===t||(++this.byteCount,P[T++]!==10))return-1;++this.crlf;break;case 2:{if(this.byteCount===t)return-1;++this.byteCount;let q=P[T];q===32||q===9?(U=T,this.crlf=0):(++this.pairCount<_&&(this.name=this.name.toLowerCase(),this.header[this.name]===void 0?this.header[this.name]=[this.value]:this.header[this.name].push(this.value)),q===13?(++this.crlf,++T):(U=T,this.crlf=0,this.state=r,this.name="",this.value=""));break}case 3:{if(this.byteCount===t||(++this.byteCount,P[T++]!==10))return-1;let q=this.header;return this.reset(),this.cb(q),T}}break}return T}},w=class extends m{constructor(P,T){super(P),this.truncated=!1,this._readcb=null,this.once("end",()=>{if(this._read(),--T._fileEndsLeft===0&&T._finalcb){let R=T._finalcb;T._finalcb=null,process.nextTick(R)}})}_read(P){let T=this._readcb;T&&(this._readcb=null,T())}},g={push:(P,T)=>{},destroy:()=>{}};function n(P,T){let R=P._writecb;P._writecb=null,T?P.destroy(T):R&&R()}function C(P,T){return P}var b=class extends l{constructor(P){let T={autoDestroy:!0,emitClose:!0,highWaterMark:typeof P.highWaterMark=="number"?P.highWaterMark:void 0};if(super(T),!P.conType.params||typeof P.conType.params.boundary!="string")throw new Error("Multipart: Boundary not found");let R=P.conType.params.boundary,U=typeof P.defParamCharset=="string"&&P.defParamCharset?d(P.defParamCharset):C,q=P.defCharset||"utf8",V=P.preservePath,le={autoDestroy:!0,emitClose:!0,highWaterMark:typeof P.fileHwm=="number"?P.fileHwm:void 0},H=P.limits,Y=H&&typeof H.fieldSize=="number"?H.fieldSize:1*1024*1024,ce=H&&typeof H.fileSize=="number"?H.fileSize:1/0,je=H&&typeof H.files=="number"?H.files:1/0,Ie=H&&typeof H.fields=="number"?H.fields:1/0,ve=H&&typeof H.parts=="number"?H.parts:1/0,be=-1,we=0,Se=0,te=!1;this._fileEndsLeft=0,this._fileStream=void 0,this._complete=!1;let pe=0,re,se=0,de,fe,x,E,L=!1,j=!1,O=!1;this._hparser=null;let $=new h(Q=>{this._hparser=null,te=!1,x="text/plain",de=q,fe="7bit",E=void 0,L=!1;let K;if(!Q["content-disposition"]){te=!0;return}let M=i(Q["content-disposition"][0],U);if(!M||M.type!=="form-data"){te=!0;return}if(M.params&&(M.params.name&&(E=M.params.name),M.params["filename*"]?K=M.params["filename*"]:M.params.filename&&(K=M.params.filename),K!==void 0&&!V&&(K=y(K))),Q["content-type"]){let X=e(Q["content-type"][0]);X&&(x=`${X.type}/${X.subtype}`,X.params&&typeof X.params.charset=="string"&&(de=X.params.charset.toLowerCase()))}if(Q["content-transfer-encoding"]&&(fe=Q["content-transfer-encoding"][0].toLowerCase()),x==="application/octet-stream"||K!==void 0){if(Se===je){j||(j=!0,this.emit("filesLimit")),te=!0;return}if(++Se,this.listenerCount("file")===0){te=!0;return}pe=0,this._fileStream=new w(le,this),++this._fileEndsLeft,this.emit("file",E,this._fileStream,{filename:K,encoding:fe,mimeType:x})}else{if(we===Ie){O||(O=!0,this.emit("fieldsLimit")),te=!0;return}if(++we,this.listenerCount("field")===0){te=!0;return}re=[],se=0}}),J=0,oe=(Q,K,M,X,he)=>{e:for(;K;){if(this._hparser!==null){let W=this._hparser.push(K,M,X);if(W===-1){this._hparser=null,$.reset(),this.emit("error",new Error("Malformed part header"));break}M=W}if(M===X)break;if(J!==0){if(J===1){switch(K[M]){case 45:J=2,++M;break;case 13:J=3,++M;break;default:J=0}if(M===X)return}if(J===2){if(J=0,K[M]===45){this._complete=!0,this._bparser=g;return}let W=this._writecb;this._writecb=k,oe(!1,c,0,1,!1),this._writecb=W}else if(J===3)if(J=0,K[M]===10){if(++M,be>=ve||(this._hparser=$,M===X))break;continue e}else{let W=this._writecb;this._writecb=k,oe(!1,o,0,1,!1),this._writecb=W}}if(!te){if(this._fileStream){let W,F=Math.min(X-M,ce-pe);he?W=K.slice(M,M+F):(W=Buffer.allocUnsafe(F),K.copy(W,0,M,M+F)),pe+=W.length,pe===ce?(W.length>0&&this._fileStream.push(W),this._fileStream.emit("limit"),this._fileStream.truncated=!0,te=!0):this._fileStream.push(W)||(this._writecb&&(this._fileStream._readcb=this._writecb),this._writecb=null)}else if(re!==void 0){let W,F=Math.min(X-M,Y-se);he?W=K.slice(M,M+F):(W=Buffer.allocUnsafe(F),K.copy(W,0,M,M+F)),se+=F,re.push(W),se===Y&&(te=!0,L=!0)}}break}if(Q){if(J=1,this._fileStream)this._fileStream.push(null),this._fileStream=null;else if(re!==void 0){let W;switch(re.length){case 0:W="";break;case 1:W=s(re[0],de,0);break;default:W=s(Buffer.concat(re,se),de,0)}re=void 0,se=0,this.emit("field",E,W,{nameTruncated:!1,valueTruncated:L,encoding:fe,mimeType:x})}++be===ve&&this.emit("partsLimit")}};this._bparser=new v(`\r
--${R}`,oe),this._writecb=null,this._finalcb=null,this.write(u)}static detect(P){return P.type==="multipart"&&P.subtype==="form-data"}_write(P,T,R){this._writecb=R,this._bparser.push(P,0),this._writecb&&n(this)}_destroy(P,T){this._hparser=null,this._bparser=g,P||(P=I(this));let R=this._fileStream;R&&(this._fileStream=null,R.destroy(P)),T(P)}_final(P){if(this._bparser.destroy(),!this._complete)return P(new Error("Unexpected end of form"));this._fileEndsLeft?this._finalcb=N.bind(null,this,P):N(this,P)}};function N(P,T,R){if(R)return T(R);R=I(P),T(R)}function I(P){if(P._hparser)return new Error("Malformed part header");let T=P._fileStream;if(T&&(P._fileStream=null,T.destroy(new Error("Unexpected end of file"))),!P._complete)return new Error("Unexpected end of form")}var B=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,1,1,1,1,1,0,0,1,1,0,1,1,0,1,1,1,1,1,1,1,1,1,1,0,0,0,0,0,0,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,0,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,1,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],A=[0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1];a.exports=b}),qt=z((p,a)=>{"use strict";var{Writable:m}=require("stream"),{getDecoder:l}=ze(),v=class extends m{constructor(i){let u={autoDestroy:!0,emitClose:!0,highWaterMark:typeof i.highWaterMark=="number"?i.highWaterMark:void 0};super(u);let o=i.defCharset||"utf8";i.conType.params&&typeof i.conType.params.charset=="string"&&(o=i.conType.params.charset),this.charset=o;let c=i.limits;this.fieldSizeLimit=c&&typeof c.fieldSize=="number"?c.fieldSize:1*1024*1024,this.fieldsLimit=c&&typeof c.fields=="number"?c.fields:1/0,this.fieldNameSizeLimit=c&&typeof c.fieldNameSize=="number"?c.fieldNameSize:100,this._inKey=!0,this._keyTrunc=!1,this._valTrunc=!1,this._bytesKey=0,this._bytesVal=0,this._fields=0,this._key="",this._val="",this._byte=-2,this._lastPos=0,this._encode=0,this._decoder=l(o)}static detect(i){return i.type==="application"&&i.subtype==="x-www-form-urlencoded"}_write(i,u,o){if(this._fields>=this.fieldsLimit)return o();let c=0,k=i.length;if(this._lastPos=0,this._byte!==-2){if(c=y(this,i,c,k),c===-1)return o(new Error("Malformed urlencoded form"));if(c>=k)return o();this._inKey?++this._bytesKey:++this._bytesVal}e:for(;c<k;)if(this._inKey){for(c=s(this,i,c,k);c<k;){switch(i[c]){case 61:this._lastPos<c&&(this._key+=i.latin1Slice(this._lastPos,c)),this._lastPos=++c,this._key=this._decoder(this._key,this._encode),this._encode=0,this._inKey=!1;continue e;case 38:if(this._lastPos<c&&(this._key+=i.latin1Slice(this._lastPos,c)),this._lastPos=++c,this._key=this._decoder(this._key,this._encode),this._encode=0,this._bytesKey>0&&this.emit("field",this._key,"",{nameTruncated:this._keyTrunc,valueTruncated:!1,encoding:this.charset,mimeType:"text/plain"}),this._key="",this._val="",this._keyTrunc=!1,this._valTrunc=!1,this._bytesKey=0,this._bytesVal=0,++this._fields>=this.fieldsLimit)return this.emit("fieldsLimit"),o();continue;case 43:this._lastPos<c&&(this._key+=i.latin1Slice(this._lastPos,c)),this._key+=" ",this._lastPos=c+1;break;case 37:if(this._encode===0&&(this._encode=1),this._lastPos<c&&(this._key+=i.latin1Slice(this._lastPos,c)),this._lastPos=c+1,this._byte=-1,c=y(this,i,c+1,k),c===-1)return o(new Error("Malformed urlencoded form"));if(c>=k)return o();++this._bytesKey,c=s(this,i,c,k);continue}++c,++this._bytesKey,c=s(this,i,c,k)}this._lastPos<c&&(this._key+=i.latin1Slice(this._lastPos,c))}else{for(c=d(this,i,c,k);c<k;){switch(i[c]){case 38:if(this._lastPos<c&&(this._val+=i.latin1Slice(this._lastPos,c)),this._lastPos=++c,this._inKey=!0,this._val=this._decoder(this._val,this._encode),this._encode=0,(this._bytesKey>0||this._bytesVal>0)&&this.emit("field",this._key,this._val,{nameTruncated:this._keyTrunc,valueTruncated:this._valTrunc,encoding:this.charset,mimeType:"text/plain"}),this._key="",this._val="",this._keyTrunc=!1,this._valTrunc=!1,this._bytesKey=0,this._bytesVal=0,++this._fields>=this.fieldsLimit)return this.emit("fieldsLimit"),o();continue e;case 43:this._lastPos<c&&(this._val+=i.latin1Slice(this._lastPos,c)),this._val+=" ",this._lastPos=c+1;break;case 37:if(this._encode===0&&(this._encode=1),this._lastPos<c&&(this._val+=i.latin1Slice(this._lastPos,c)),this._lastPos=c+1,this._byte=-1,c=y(this,i,c+1,k),c===-1)return o(new Error("Malformed urlencoded form"));if(c>=k)return o();++this._bytesVal,c=d(this,i,c,k);continue}++c,++this._bytesVal,c=d(this,i,c,k)}this._lastPos<c&&(this._val+=i.latin1Slice(this._lastPos,c))}o()}_final(i){if(this._byte!==-2)return i(new Error("Malformed urlencoded form"));(!this._inKey||this._bytesKey>0||this._bytesVal>0)&&(this._inKey?this._key=this._decoder(this._key,this._encode):this._val=this._decoder(this._val,this._encode),this.emit("field",this._key,this._val,{nameTruncated:this._keyTrunc,valueTruncated:this._valTrunc,encoding:this.charset,mimeType:"text/plain"})),i()}};function y(i,u,o,c){if(o>=c)return c;if(i._byte===-1){let k=e[u[o++]];if(k===-1)return-1;if(k>=8&&(i._encode=2),o<c){let _=e[u[o++]];if(_===-1)return-1;i._inKey?i._key+=String.fromCharCode((k<<4)+_):i._val+=String.fromCharCode((k<<4)+_),i._byte=-2,i._lastPos=o}else i._byte=k}else{let k=e[u[o++]];if(k===-1)return-1;i._inKey?i._key+=String.fromCharCode((i._byte<<4)+k):i._val+=String.fromCharCode((i._byte<<4)+k),i._byte=-2,i._lastPos=o}return o}function s(i,u,o,c){if(i._bytesKey>i.fieldNameSizeLimit){for(i._keyTrunc||i._lastPos<o&&(i._key+=u.latin1Slice(i._lastPos,o-1)),i._keyTrunc=!0;o<c;++o){let k=u[o];if(k===61||k===38)break;++i._bytesKey}i._lastPos=o}return o}function d(i,u,o,c){if(i._bytesVal>i.fieldSizeLimit){for(i._valTrunc||i._lastPos<o&&(i._val+=u.latin1Slice(i._lastPos,o-1)),i._valTrunc=!0;o<c&&u[o]!==38;++o)++i._bytesVal;i._lastPos=o}return o}var e=[-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,0,1,2,3,4,5,6,7,8,9,-1,-1,-1,-1,-1,-1,-1,10,11,12,13,14,15,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,10,11,12,13,14,15,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1];a.exports=v}),Dt=z((p,a)=>{"use strict";var{parseContentType:m}=ze();function l(y){let s=y.headers,d=m(s["content-type"]);if(!d)throw new Error("Malformed content type");for(let e of v){if(!e.detect(d))continue;let i={limits:y.limits,headers:s,conType:d,highWaterMark:void 0,fileHwm:void 0,defCharset:void 0,defParamCharset:void 0,preservePath:!1};return y.highWaterMark&&(i.highWaterMark=y.highWaterMark),y.fileHwm&&(i.fileHwm=y.fileHwm),i.defCharset=y.defCharset,i.defParamCharset=y.defParamCharset,i.preservePath=y.preservePath,new e(i)}throw new Error(`Unsupported content type: ${s["content-type"]}`)}var v=[Wt(),qt()].filter(function(y){return typeof y.detect=="function"});a.exports=y=>{if((typeof y!="object"||y===null)&&(y={}),typeof y.headers!="object"||y.headers===null||typeof y.headers["content-type"]!="string")throw new Error("Missing Content-Type");return l(y)}}),Ft=z((p,a)=>{"use strict";var{Duplex:m}=require("stream");function l(d){d.emit("close")}function v(){!this.destroyed&&this._writableState.finished&&this.destroy()}function y(d){this.removeListener("error",y),this.destroy(),this.listenerCount("error")===0&&this.emit("error",d)}function s(d,e){let i=!0,u=new m({...e,autoDestroy:!1,emitClose:!1,objectMode:!1,writableObjectMode:!1});return d.on("message",function(o,c){let k=!c&&u._readableState.objectMode?o.toString():o;u.push(k)||d.pause()}),d.once("error",function(o){u.destroyed||(i=!1,u.destroy(o))}),d.once("close",function(){u.destroyed||u.push(null)}),u._destroy=function(o,c){if(d.readyState===d.CLOSED){c(o),process.nextTick(l,u);return}let k=!1;d.once("error",function(_){k=!0,c(_)}),d.once("close",function(){k||c(o),process.nextTick(l,u)}),i&&d.terminate()},u._final=function(o){if(d.readyState===d.CONNECTING){d.once("open",function(){u._final(o)});return}d._socket!==null&&(d._socket._writableState.finished?(o(),u._readableState.endEmitted&&u.destroy()):(d._socket.once("finish",function(){o()}),d.close()))},u._read=function(){d.isPaused&&d.resume()},u._write=function(o,c,k){if(d.readyState===d.CONNECTING){d.once("open",function(){u._write(o,c,k)});return}d.send(o,k)},u.on("end",v),u.on("error",y),u}a.exports=s}),_e=z((p,a)=>{"use strict";a.exports={BINARY_TYPES:["nodebuffer","arraybuffer","fragments"],EMPTY_BUFFER:Buffer.alloc(0),GUID:"258EAFA5-E914-47DA-95CA-C5AB0DC85B11",kForOnEventAttribute:Symbol("kIsForOnEventAttribute"),kListener:Symbol("kListener"),kStatusCode:Symbol("status-code"),kWebSocket:Symbol("websocket"),NOOP:()=>{}}}),Oe=z((p,a)=>{"use strict";var{EMPTY_BUFFER:m}=_e(),l=Buffer[Symbol.species];function v(i,u){if(i.length===0)return m;if(i.length===1)return i[0];let o=Buffer.allocUnsafe(u),c=0;for(let k=0;k<i.length;k++){let _=i[k];o.set(_,c),c+=_.length}return c<u?new l(o.buffer,o.byteOffset,c):o}function y(i,u,o,c,k){for(let _=0;_<k;_++)o[c+_]=i[_]^u[_&3]}function s(i,u){for(let o=0;o<i.length;o++)i[o]^=u[o&3]}function d(i){return i.length===i.buffer.byteLength?i.buffer:i.buffer.slice(i.byteOffset,i.byteOffset+i.length)}function e(i){if(e.readOnly=!0,Buffer.isBuffer(i))return i;let u;return i instanceof ArrayBuffer?u=new l(i):ArrayBuffer.isView(i)?u=new l(i.buffer,i.byteOffset,i.byteLength):(u=Buffer.from(i),e.readOnly=!1),u}if(a.exports={concat:v,mask:y,toArrayBuffer:d,toBuffer:e,unmask:s},!process.env.WS_NO_BUFFER_UTIL)try{let i=require("bufferutil");a.exports.mask=function(u,o,c,k,_){_<48?y(u,o,c,k,_):i.mask(u,o,c,k,_)},a.exports.unmask=function(u,o){u.length<32?s(u,o):i.unmask(u,o)}}catch{}}),zt=z((p,a)=>{"use strict";var m=Symbol("kDone"),l=Symbol("kRun"),v=class{constructor(y){this[m]=()=>{this.pending--,this[l]()},this.concurrency=y||1/0,this.jobs=[],this.pending=0}add(y){this.jobs.push(y),this[l]()}[l](){if(this.pending!==this.concurrency&&this.jobs.length){let y=this.jobs.shift();this.pending++,y(this[m])}}};a.exports=v}),Le=z((p,a)=>{"use strict";var m=require("zlib"),l=Oe(),v=zt(),{kStatusCode:y}=_e(),s=Buffer[Symbol.species],d=Buffer.from([0,0,255,255]),e=Symbol("permessage-deflate"),i=Symbol("total-length"),u=Symbol("callback"),o=Symbol("buffers"),c=Symbol("error"),k,_=class{constructor(f,h,w){if(this._maxPayload=w|0,this._options=f||{},this._threshold=this._options.threshold!==void 0?this._options.threshold:1024,this._isServer=!!h,this._deflate=null,this._inflate=null,this.params=null,!k){let g=this._options.concurrencyLimit!==void 0?this._options.concurrencyLimit:10;k=new v(g)}}static get extensionName(){return"permessage-deflate"}offer(){let f={};return this._options.serverNoContextTakeover&&(f.server_no_context_takeover=!0),this._options.clientNoContextTakeover&&(f.client_no_context_takeover=!0),this._options.serverMaxWindowBits&&(f.server_max_window_bits=this._options.serverMaxWindowBits),this._options.clientMaxWindowBits?f.client_max_window_bits=this._options.clientMaxWindowBits:this._options.clientMaxWindowBits==null&&(f.client_max_window_bits=!0),f}accept(f){return f=this.normalizeParams(f),this.params=this._isServer?this.acceptAsServer(f):this.acceptAsClient(f),this.params}cleanup(){if(this._inflate&&(this._inflate.close(),this._inflate=null),this._deflate){let f=this._deflate[u];this._deflate.close(),this._deflate=null,f&&f(new Error("The deflate stream was closed while data was being processed"))}}acceptAsServer(f){let h=this._options,w=f.find(g=>!(h.serverNoContextTakeover===!1&&g.server_no_context_takeover||g.server_max_window_bits&&(h.serverMaxWindowBits===!1||typeof h.serverMaxWindowBits=="number"&&h.serverMaxWindowBits>g.server_max_window_bits)||typeof h.clientMaxWindowBits=="number"&&!g.client_max_window_bits));if(!w)throw new Error("None of the extension offers can be accepted");return h.serverNoContextTakeover&&(w.server_no_context_takeover=!0),h.clientNoContextTakeover&&(w.client_no_context_takeover=!0),typeof h.serverMaxWindowBits=="number"&&(w.server_max_window_bits=h.serverMaxWindowBits),typeof h.clientMaxWindowBits=="number"?w.client_max_window_bits=h.clientMaxWindowBits:(w.client_max_window_bits===!0||h.clientMaxWindowBits===!1)&&delete w.client_max_window_bits,w}acceptAsClient(f){let h=f[0];if(this._options.clientNoContextTakeover===!1&&h.client_no_context_takeover)throw new Error('Unexpected parameter "client_no_context_takeover"');if(!h.client_max_window_bits)typeof this._options.clientMaxWindowBits=="number"&&(h.client_max_window_bits=this._options.clientMaxWindowBits);else if(this._options.clientMaxWindowBits===!1||typeof this._options.clientMaxWindowBits=="number"&&h.client_max_window_bits>this._options.clientMaxWindowBits)throw new Error('Unexpected or invalid parameter "client_max_window_bits"');return h}normalizeParams(f){return f.forEach(h=>{Object.keys(h).forEach(w=>{let g=h[w];if(g.length>1)throw new Error(`Parameter "${w}" must have only a single value`);if(g=g[0],w==="client_max_window_bits"){if(g!==!0){let n=+g;if(!Number.isInteger(n)||n<8||n>15)throw new TypeError(`Invalid value for parameter "${w}": ${g}`);g=n}else if(!this._isServer)throw new TypeError(`Invalid value for parameter "${w}": ${g}`)}else if(w==="server_max_window_bits"){let n=+g;if(!Number.isInteger(n)||n<8||n>15)throw new TypeError(`Invalid value for parameter "${w}": ${g}`);g=n}else if(w==="client_no_context_takeover"||w==="server_no_context_takeover"){if(g!==!0)throw new TypeError(`Invalid value for parameter "${w}": ${g}`)}else throw new Error(`Unknown parameter "${w}"`);h[w]=g})}),f}decompress(f,h,w){k.add(g=>{this._decompress(f,h,(n,C)=>{g(),w(n,C)})})}compress(f,h,w){k.add(g=>{this._compress(f,h,(n,C)=>{g(),w(n,C)})})}_decompress(f,h,w){let g=this._isServer?"client":"server";if(!this._inflate){let n=`${g}_max_window_bits`,C=typeof this.params[n]!="number"?m.Z_DEFAULT_WINDOWBITS:this.params[n];this._inflate=m.createInflateRaw({...this._options.zlibInflateOptions,windowBits:C}),this._inflate[e]=this,this._inflate[i]=0,this._inflate[o]=[],this._inflate.on("error",S),this._inflate.on("data",r)}this._inflate[u]=w,this._inflate.write(f),h&&this._inflate.write(d),this._inflate.flush(()=>{let n=this._inflate[c];if(n){this._inflate.close(),this._inflate=null,w(n);return}let C=l.concat(this._inflate[o],this._inflate[i]);this._inflate._readableState.endEmitted?(this._inflate.close(),this._inflate=null):(this._inflate[i]=0,this._inflate[o]=[],h&&this.params[`${g}_no_context_takeover`]&&this._inflate.reset()),w(null,C)})}_compress(f,h,w){let g=this._isServer?"server":"client";if(!this._deflate){let n=`${g}_max_window_bits`,C=typeof this.params[n]!="number"?m.Z_DEFAULT_WINDOWBITS:this.params[n];this._deflate=m.createDeflateRaw({...this._options.zlibDeflateOptions,windowBits:C}),this._deflate[i]=0,this._deflate[o]=[],this._deflate.on("data",t)}this._deflate[u]=w,this._deflate.write(f),this._deflate.flush(m.Z_SYNC_FLUSH,()=>{if(!this._deflate)return;let n=l.concat(this._deflate[o],this._deflate[i]);h&&(n=new s(n.buffer,n.byteOffset,n.length-4)),this._deflate[u]=null,this._deflate[i]=0,this._deflate[o]=[],h&&this.params[`${g}_no_context_takeover`]&&this._deflate.reset(),w(null,n)})}};a.exports=_;function t(f){this[o].push(f),this[i]+=f.length}function r(f){if(this[i]+=f.length,this[e]._maxPayload<1||this[i]<=this[e]._maxPayload){this[o].push(f);return}this[c]=new RangeError("Max payload size exceeded"),this[c].code="WS_ERR_UNSUPPORTED_MESSAGE_LENGTH",this[c][y]=1009,this.removeListener("data",r),this.reset()}function S(f){this[e]._inflate=null,f[y]=1007,this[u](f)}}),Ne=z((p,a)=>{"use strict";var{isUtf8:m}=require("buffer"),l=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,1,1,1,1,1,0,0,1,1,0,1,1,0,1,1,1,1,1,1,1,1,1,1,0,0,0,0,0,0,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,0,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,1,0,1,0];function v(s){return s>=1e3&&s<=1014&&s!==1004&&s!==1005&&s!==1006||s>=3e3&&s<=4999}function y(s){let d=s.length,e=0;for(;e<d;)if(!(s[e]&128))e++;else if((s[e]&224)===192){if(e+1===d||(s[e+1]&192)!==128||(s[e]&254)===192)return!1;e+=2}else if((s[e]&240)===224){if(e+2>=d||(s[e+1]&192)!==128||(s[e+2]&192)!==128||s[e]===224&&(s[e+1]&224)===128||s[e]===237&&(s[e+1]&224)===160)return!1;e+=3}else if((s[e]&248)===240){if(e+3>=d||(s[e+1]&192)!==128||(s[e+2]&192)!==128||(s[e+3]&192)!==128||s[e]===240&&(s[e+1]&240)===128||s[e]===244&&s[e+1]>143||s[e]>244)return!1;e+=4}else return!1;return!0}if(a.exports={isValidStatusCode:v,isValidUTF8:y,tokenChars:l},m)a.exports.isValidUTF8=function(s){return s.length<24?y(s):m(s)};else if(!process.env.WS_NO_UTF_8_VALIDATE)try{let s=require("utf-8-validate");a.exports.isValidUTF8=function(d){return d.length<32?y(d):s(d)}}catch{}}),et=z((p,a)=>{"use strict";var{Writable:m}=require("stream"),l=Le(),{BINARY_TYPES:v,EMPTY_BUFFER:y,kStatusCode:s,kWebSocket:d}=_e(),{concat:e,toArrayBuffer:i,unmask:u}=Oe(),{isValidStatusCode:o,isValidUTF8:c}=Ne(),k=Buffer[Symbol.species],_=0,t=1,r=2,S=3,f=4,h=5,w=class extends m{constructor(n={}){super(),this._binaryType=n.binaryType||v[0],this._extensions=n.extensions||{},this._isServer=!!n.isServer,this._maxPayload=n.maxPayload|0,this._skipUTF8Validation=!!n.skipUTF8Validation,this[d]=void 0,this._bufferedBytes=0,this._buffers=[],this._compressed=!1,this._payloadLength=0,this._mask=void 0,this._fragmented=0,this._masked=!1,this._fin=!1,this._opcode=0,this._totalPayloadLength=0,this._messageLength=0,this._fragments=[],this._state=_,this._loop=!1}_write(n,C,b){if(this._opcode===8&&this._state==_)return b();this._bufferedBytes+=n.length,this._buffers.push(n),this.startLoop(b)}consume(n){if(this._bufferedBytes-=n,n===this._buffers[0].length)return this._buffers.shift();if(n<this._buffers[0].length){let b=this._buffers[0];return this._buffers[0]=new k(b.buffer,b.byteOffset+n,b.length-n),new k(b.buffer,b.byteOffset,n)}let C=Buffer.allocUnsafe(n);do{let b=this._buffers[0],N=C.length-n;n>=b.length?C.set(this._buffers.shift(),N):(C.set(new Uint8Array(b.buffer,b.byteOffset,n),N),this._buffers[0]=new k(b.buffer,b.byteOffset+n,b.length-n)),n-=b.length}while(n>0);return C}startLoop(n){let C;this._loop=!0;do switch(this._state){case _:C=this.getInfo();break;case t:C=this.getPayloadLength16();break;case r:C=this.getPayloadLength64();break;case S:this.getMask();break;case f:C=this.getData(n);break;default:this._loop=!1;return}while(this._loop);n(C)}getInfo(){if(this._bufferedBytes<2){this._loop=!1;return}let n=this.consume(2);if(n[0]&48)return this._loop=!1,g(RangeError,"RSV2 and RSV3 must be clear",!0,1002,"WS_ERR_UNEXPECTED_RSV_2_3");let C=(n[0]&64)===64;if(C&&!this._extensions[l.extensionName])return this._loop=!1,g(RangeError,"RSV1 must be clear",!0,1002,"WS_ERR_UNEXPECTED_RSV_1");if(this._fin=(n[0]&128)===128,this._opcode=n[0]&15,this._payloadLength=n[1]&127,this._opcode===0){if(C)return this._loop=!1,g(RangeError,"RSV1 must be clear",!0,1002,"WS_ERR_UNEXPECTED_RSV_1");if(!this._fragmented)return this._loop=!1,g(RangeError,"invalid opcode 0",!0,1002,"WS_ERR_INVALID_OPCODE");this._opcode=this._fragmented}else if(this._opcode===1||this._opcode===2){if(this._fragmented)return this._loop=!1,g(RangeError,`invalid opcode ${this._opcode}`,!0,1002,"WS_ERR_INVALID_OPCODE");this._compressed=C}else if(this._opcode>7&&this._opcode<11){if(!this._fin)return this._loop=!1,g(RangeError,"FIN must be set",!0,1002,"WS_ERR_EXPECTED_FIN");if(C)return this._loop=!1,g(RangeError,"RSV1 must be clear",!0,1002,"WS_ERR_UNEXPECTED_RSV_1");if(this._payloadLength>125||this._opcode===8&&this._payloadLength===1)return this._loop=!1,g(RangeError,`invalid payload length ${this._payloadLength}`,!0,1002,"WS_ERR_INVALID_CONTROL_PAYLOAD_LENGTH")}else return this._loop=!1,g(RangeError,`invalid opcode ${this._opcode}`,!0,1002,"WS_ERR_INVALID_OPCODE");if(!this._fin&&!this._fragmented&&(this._fragmented=this._opcode),this._masked=(n[1]&128)===128,this._isServer){if(!this._masked)return this._loop=!1,g(RangeError,"MASK must be set",!0,1002,"WS_ERR_EXPECTED_MASK")}else if(this._masked)return this._loop=!1,g(RangeError,"MASK must be clear",!0,1002,"WS_ERR_UNEXPECTED_MASK");if(this._payloadLength===126)this._state=t;else if(this._payloadLength===127)this._state=r;else return this.haveLength()}getPayloadLength16(){if(this._bufferedBytes<2){this._loop=!1;return}return this._payloadLength=this.consume(2).readUInt16BE(0),this.haveLength()}getPayloadLength64(){if(this._bufferedBytes<8){this._loop=!1;return}let n=this.consume(8),C=n.readUInt32BE(0);return C>Math.pow(2,53-32)-1?(this._loop=!1,g(RangeError,"Unsupported WebSocket frame: payload length > 2^53 - 1",!1,1009,"WS_ERR_UNSUPPORTED_DATA_PAYLOAD_LENGTH")):(this._payloadLength=C*Math.pow(2,32)+n.readUInt32BE(4),this.haveLength())}haveLength(){if(this._payloadLength&&this._opcode<8&&(this._totalPayloadLength+=this._payloadLength,this._totalPayloadLength>this._maxPayload&&this._maxPayload>0))return this._loop=!1,g(RangeError,"Max payload size exceeded",!1,1009,"WS_ERR_UNSUPPORTED_MESSAGE_LENGTH");this._masked?this._state=S:this._state=f}getMask(){if(this._bufferedBytes<4){this._loop=!1;return}this._mask=this.consume(4),this._state=f}getData(n){let C=y;if(this._payloadLength){if(this._bufferedBytes<this._payloadLength){this._loop=!1;return}C=this.consume(this._payloadLength),this._masked&&this._mask[0]|this._mask[1]|this._mask[2]|this._mask[3]&&u(C,this._mask)}if(this._opcode>7)return this.controlMessage(C);if(this._compressed){this._state=h,this.decompress(C,n);return}return C.length&&(this._messageLength=this._totalPayloadLength,this._fragments.push(C)),this.dataMessage()}decompress(n,C){this._extensions[l.extensionName].decompress(n,this._fin,(b,N)=>{if(b)return C(b);if(N.length){if(this._messageLength+=N.length,this._messageLength>this._maxPayload&&this._maxPayload>0)return C(g(RangeError,"Max payload size exceeded",!1,1009,"WS_ERR_UNSUPPORTED_MESSAGE_LENGTH"));this._fragments.push(N)}let I=this.dataMessage();if(I)return C(I);this.startLoop(C)})}dataMessage(){if(this._fin){let n=this._messageLength,C=this._fragments;if(this._totalPayloadLength=0,this._messageLength=0,this._fragmented=0,this._fragments=[],this._opcode===2){let b;this._binaryType==="nodebuffer"?b=e(C,n):this._binaryType==="arraybuffer"?b=i(e(C,n)):b=C,this.emit("message",b,!0)}else{let b=e(C,n);if(!this._skipUTF8Validation&&!c(b))return this._loop=!1,g(Error,"invalid UTF-8 sequence",!0,1007,"WS_ERR_INVALID_UTF8");this.emit("message",b,!1)}}this._state=_}controlMessage(n){if(this._opcode===8)if(this._loop=!1,n.length===0)this.emit("conclude",1005,y),this.end();else{let C=n.readUInt16BE(0);if(!o(C))return g(RangeError,`invalid status code ${C}`,!0,1002,"WS_ERR_INVALID_CLOSE_CODE");let b=new k(n.buffer,n.byteOffset+2,n.length-2);if(!this._skipUTF8Validation&&!c(b))return g(Error,"invalid UTF-8 sequence",!0,1007,"WS_ERR_INVALID_UTF8");this.emit("conclude",C,b),this.end()}else this._opcode===9?this.emit("ping",n):this.emit("pong",n);this._state=_}};a.exports=w;function g(n,C,b,N,I){let B=new n(b?`Invalid WebSocket frame: ${C}`:C);return Error.captureStackTrace(B,g),B.code=I,B[s]=N,B}}),tt=z((p,a)=>{"use strict";var m=require("net"),l=require("tls"),{randomFillSync:v}=require("crypto"),y=Le(),{EMPTY_BUFFER:s}=_e(),{isValidStatusCode:d}=Ne(),{mask:e,toBuffer:i}=Oe(),u=Symbol("kByteLength"),o=Buffer.alloc(4),c=class ue{constructor(_,t,r){this._extensions=t||{},r&&(this._generateMask=r,this._maskBuffer=Buffer.alloc(4)),this._socket=_,this._firstFragment=!0,this._compress=!1,this._bufferedBytes=0,this._deflating=!1,this._queue=[]}static frame(_,t){let r,S=!1,f=2,h=!1;t.mask&&(r=t.maskBuffer||o,t.generateMask?t.generateMask(r):v(r,0,4),h=(r[0]|r[1]|r[2]|r[3])===0,f=6);let w;typeof _=="string"?(!t.mask||h)&&t[u]!==void 0?w=t[u]:(_=Buffer.from(_),w=_.length):(w=_.length,S=t.mask&&t.readOnly&&!h);let g=w;w>=65536?(f+=8,g=127):w>125&&(f+=2,g=126);let n=Buffer.allocUnsafe(S?w+f:f);return n[0]=t.fin?t.opcode|128:t.opcode,t.rsv1&&(n[0]|=64),n[1]=g,g===126?n.writeUInt16BE(w,2):g===127&&(n[2]=n[3]=0,n.writeUIntBE(w,4,6)),t.mask?(n[1]|=128,n[f-4]=r[0],n[f-3]=r[1],n[f-2]=r[2],n[f-1]=r[3],h?[n,_]:S?(e(_,r,n,f,w),[n]):(e(_,r,_,0,w),[n,_])):[n,_]}close(_,t,r,S){let f;if(_===void 0)f=s;else{if(typeof _!="number"||!d(_))throw new TypeError("First argument must be a valid error code number");if(t===void 0||!t.length)f=Buffer.allocUnsafe(2),f.writeUInt16BE(_,0);else{let w=Buffer.byteLength(t);if(w>123)throw new RangeError("The message must not be greater than 123 bytes");f=Buffer.allocUnsafe(2+w),f.writeUInt16BE(_,0),typeof t=="string"?f.write(t,2):f.set(t,2)}}let h={[u]:f.length,fin:!0,generateMask:this._generateMask,mask:r,maskBuffer:this._maskBuffer,opcode:8,readOnly:!1,rsv1:!1};this._deflating?this.enqueue([this.dispatch,f,!1,h,S]):this.sendFrame(ue.frame(f,h),S)}ping(_,t,r){let S,f;if(typeof _=="string"?(S=Buffer.byteLength(_),f=!1):(_=i(_),S=_.length,f=i.readOnly),S>125)throw new RangeError("The data size must not be greater than 125 bytes");let h={[u]:S,fin:!0,generateMask:this._generateMask,mask:t,maskBuffer:this._maskBuffer,opcode:9,readOnly:f,rsv1:!1};this._deflating?this.enqueue([this.dispatch,_,!1,h,r]):this.sendFrame(ue.frame(_,h),r)}pong(_,t,r){let S,f;if(typeof _=="string"?(S=Buffer.byteLength(_),f=!1):(_=i(_),S=_.length,f=i.readOnly),S>125)throw new RangeError("The data size must not be greater than 125 bytes");let h={[u]:S,fin:!0,generateMask:this._generateMask,mask:t,maskBuffer:this._maskBuffer,opcode:10,readOnly:f,rsv1:!1};this._deflating?this.enqueue([this.dispatch,_,!1,h,r]):this.sendFrame(ue.frame(_,h),r)}send(_,t,r){let S=this._extensions[y.extensionName],f=t.binary?2:1,h=t.compress,w,g;if(typeof _=="string"?(w=Buffer.byteLength(_),g=!1):(_=i(_),w=_.length,g=i.readOnly),this._firstFragment?(this._firstFragment=!1,h&&S&&S.params[S._isServer?"server_no_context_takeover":"client_no_context_takeover"]&&(h=w>=S._threshold),this._compress=h):(h=!1,f=0),t.fin&&(this._firstFragment=!0),S){let n={[u]:w,fin:t.fin,generateMask:this._generateMask,mask:t.mask,maskBuffer:this._maskBuffer,opcode:f,readOnly:g,rsv1:h};this._deflating?this.enqueue([this.dispatch,_,this._compress,n,r]):this.dispatch(_,this._compress,n,r)}else this.sendFrame(ue.frame(_,{[u]:w,fin:t.fin,generateMask:this._generateMask,mask:t.mask,maskBuffer:this._maskBuffer,opcode:f,readOnly:g,rsv1:!1}),r)}dispatch(_,t,r,S){if(!t){this.sendFrame(ue.frame(_,r),S);return}let f=this._extensions[y.extensionName];this._bufferedBytes+=r[u],this._deflating=!0,f.compress(_,r.fin,(h,w)=>{if(this._socket.destroyed){let g=new Error("The socket was closed while data was being compressed");typeof S=="function"&&S(g);for(let n=0;n<this._queue.length;n++){let C=this._queue[n],b=C[C.length-1];typeof b=="function"&&b(g)}return}this._bufferedBytes-=r[u],this._deflating=!1,r.readOnly=!1,this.sendFrame(ue.frame(w,r),S),this.dequeue()})}dequeue(){for(;!this._deflating&&this._queue.length;){let _=this._queue.shift();this._bufferedBytes-=_[3][u],Reflect.apply(_[0],this,_.slice(1))}}enqueue(_){this._bufferedBytes+=_[3][u],this._queue.push(_)}sendFrame(_,t){_.length===2?(this._socket.cork(),this._socket.write(_[0]),this._socket.write(_[1],t),this._socket.uncork()):this._socket.write(_[0],t)}};a.exports=c}),$t=z((p,a)=>{"use strict";var{kForOnEventAttribute:m,kListener:l}=_e(),v=Symbol("kCode"),y=Symbol("kData"),s=Symbol("kError"),d=Symbol("kMessage"),e=Symbol("kReason"),i=Symbol("kTarget"),u=Symbol("kType"),o=Symbol("kWasClean"),c=class{constructor(f){this[i]=null,this[u]=f}get target(){return this[i]}get type(){return this[u]}};Object.defineProperty(c.prototype,"target",{enumerable:!0}),Object.defineProperty(c.prototype,"type",{enumerable:!0});var k=class extends c{constructor(f,h={}){super(f),this[v]=h.code===void 0?0:h.code,this[e]=h.reason===void 0?"":h.reason,this[o]=h.wasClean===void 0?!1:h.wasClean}get code(){return this[v]}get reason(){return this[e]}get wasClean(){return this[o]}};Object.defineProperty(k.prototype,"code",{enumerable:!0}),Object.defineProperty(k.prototype,"reason",{enumerable:!0}),Object.defineProperty(k.prototype,"wasClean",{enumerable:!0});var _=class extends c{constructor(f,h={}){super(f),this[s]=h.error===void 0?null:h.error,this[d]=h.message===void 0?"":h.message}get error(){return this[s]}get message(){return this[d]}};Object.defineProperty(_.prototype,"error",{enumerable:!0}),Object.defineProperty(_.prototype,"message",{enumerable:!0});var t=class extends c{constructor(f,h={}){super(f),this[y]=h.data===void 0?null:h.data}get data(){return this[y]}};Object.defineProperty(t.prototype,"data",{enumerable:!0});var r={addEventListener(f,h,w={}){for(let n of this.listeners(f))if(!w[m]&&n[l]===h&&!n[m])return;let g;if(f==="message")g=function(n,C){let b=new t("message",{data:C?n:n.toString()});b[i]=this,S(h,this,b)};else if(f==="close")g=function(n,C){let b=new k("close",{code:n,reason:C.toString(),wasClean:this._closeFrameReceived&&this._closeFrameSent});b[i]=this,S(h,this,b)};else if(f==="error")g=function(n){let C=new _("error",{error:n,message:n.message});C[i]=this,S(h,this,C)};else if(f==="open")g=function(){let n=new c("open");n[i]=this,S(h,this,n)};else return;g[m]=!!w[m],g[l]=h,w.once?this.once(f,g):this.on(f,g)},removeEventListener(f,h){for(let w of this.listeners(f))if(w[l]===h&&!w[m]){this.removeListener(f,w);break}}};a.exports={CloseEvent:k,ErrorEvent:_,Event:c,EventTarget:r,MessageEvent:t};function S(f,h,w){typeof f=="object"&&f.handleEvent?f.handleEvent.call(f,w):f.call(h,w)}}),it=z((p,a)=>{"use strict";var{tokenChars:m}=Ne();function l(s,d,e){s[d]===void 0?s[d]=[e]:s[d].push(e)}function v(s){let d=Object.create(null),e=Object.create(null),i=!1,u=!1,o=!1,c,k,_=-1,t=-1,r=-1,S=0;for(;S<s.length;S++)if(t=s.charCodeAt(S),c===void 0)if(r===-1&&m[t]===1)_===-1&&(_=S);else if(S!==0&&(t===32||t===9))r===-1&&_!==-1&&(r=S);else if(t===59||t===44){if(_===-1)throw new SyntaxError(`Unexpected character at index ${S}`);r===-1&&(r=S);let h=s.slice(_,r);t===44?(l(d,h,e),e=Object.create(null)):c=h,_=r=-1}else throw new SyntaxError(`Unexpected character at index ${S}`);else if(k===void 0)if(r===-1&&m[t]===1)_===-1&&(_=S);else if(t===32||t===9)r===-1&&_!==-1&&(r=S);else if(t===59||t===44){if(_===-1)throw new SyntaxError(`Unexpected character at index ${S}`);r===-1&&(r=S),l(e,s.slice(_,r),!0),t===44&&(l(d,c,e),e=Object.create(null),c=void 0),_=r=-1}else if(t===61&&_!==-1&&r===-1)k=s.slice(_,S),_=r=-1;else throw new SyntaxError(`Unexpected character at index ${S}`);else if(u){if(m[t]!==1)throw new SyntaxError(`Unexpected character at index ${S}`);_===-1?_=S:i||(i=!0),u=!1}else if(o)if(m[t]===1)_===-1&&(_=S);else if(t===34&&_!==-1)o=!1,r=S;else if(t===92)u=!0;else throw new SyntaxError(`Unexpected character at index ${S}`);else if(t===34&&s.charCodeAt(S-1)===61)o=!0;else if(r===-1&&m[t]===1)_===-1&&(_=S);else if(_!==-1&&(t===32||t===9))r===-1&&(r=S);else if(t===59||t===44){if(_===-1)throw new SyntaxError(`Unexpected character at index ${S}`);r===-1&&(r=S);let h=s.slice(_,r);i&&(h=h.replace(/\\/g,""),i=!1),l(e,k,h),t===44&&(l(d,c,e),e=Object.create(null),c=void 0),k=void 0,_=r=-1}else throw new SyntaxError(`Unexpected character at index ${S}`);if(_===-1||o||t===32||t===9)throw new SyntaxError("Unexpected end of input");r===-1&&(r=S);let f=s.slice(_,r);return c===void 0?l(d,f,e):(k===void 0?l(e,f,!0):i?l(e,k,f.replace(/\\/g,"")):l(e,k,f),l(d,c,e)),d}function y(s){return Object.keys(s).map(d=>{let e=s[d];return Array.isArray(e)||(e=[e]),e.map(i=>[d].concat(Object.keys(i).map(u=>{let o=i[u];return Array.isArray(o)||(o=[o]),o.map(c=>c===!0?u:`${u}=${c}`).join("; ")})).join("; ")).join(", ")}).join(", ")}a.exports={format:y,parse:v}}),rt=z((p,a)=>{"use strict";var m=require("events"),l=require("https"),v=require("http"),y=require("net"),s=require("tls"),{randomBytes:d,createHash:e}=require("crypto"),{Readable:i}=require("stream"),{URL:u}=require("url"),o=Le(),c=et(),k=tt(),{BINARY_TYPES:_,EMPTY_BUFFER:t,GUID:r,kForOnEventAttribute:S,kListener:f,kStatusCode:h,kWebSocket:w,NOOP:g}=_e(),{EventTarget:{addEventListener:n,removeEventListener:C}}=$t(),{format:b,parse:N}=it(),{toBuffer:I}=Oe(),B=30*1e3,A=Symbol("kAborted"),P=[8,13],T=["CONNECTING","OPEN","CLOSING","CLOSED"],R=/^[!#$%&'*+\-.0-9A-Z^_`|a-z~]+$/,U=class G extends m{constructor(E,L,j){super(),this._binaryType=_[0],this._closeCode=1006,this._closeFrameReceived=!1,this._closeFrameSent=!1,this._closeMessage=t,this._closeTimer=null,this._extensions={},this._paused=!1,this._protocol="",this._readyState=G.CONNECTING,this._receiver=null,this._sender=null,this._socket=null,E!==null?(this._bufferedAmount=0,this._isServer=!1,this._redirects=0,L===void 0?L=[]:Array.isArray(L)||(typeof L=="object"&&L!==null?(j=L,L=[]):L=[L]),q(this,E,L,j)):this._isServer=!0}get binaryType(){return this._binaryType}set binaryType(E){_.includes(E)&&(this._binaryType=E,this._receiver&&(this._receiver._binaryType=E))}get bufferedAmount(){return this._socket?this._socket._writableState.length+this._sender._bufferedBytes:this._bufferedAmount}get extensions(){return Object.keys(this._extensions).join()}get isPaused(){return this._paused}get onclose(){return null}get onerror(){return null}get onopen(){return null}get onmessage(){return null}get protocol(){return this._protocol}get readyState(){return this._readyState}get url(){return this._url}setSocket(E,L,j){let O=new c({binaryType:this.binaryType,extensions:this._extensions,isServer:this._isServer,maxPayload:j.maxPayload,skipUTF8Validation:j.skipUTF8Validation});this._sender=new k(E,this._extensions,j.generateMask),this._receiver=O,this._socket=E,O[w]=this,E[w]=this,O.on("conclude",je),O.on("drain",Ie),O.on("error",ve),O.on("message",we),O.on("ping",Se),O.on("pong",te),E.setTimeout(0),E.setNoDelay(),L.length>0&&E.unshift(L),E.on("close",re),E.on("data",se),E.on("end",de),E.on("error",fe),this._readyState=G.OPEN,this.emit("open")}emitClose(){if(!this._socket){this._readyState=G.CLOSED,this.emit("close",this._closeCode,this._closeMessage);return}this._extensions[o.extensionName]&&this._extensions[o.extensionName].cleanup(),this._receiver.removeAllListeners(),this._readyState=G.CLOSED,this.emit("close",this._closeCode,this._closeMessage)}close(E,L){if(this.readyState!==G.CLOSED){if(this.readyState===G.CONNECTING){let j="WebSocket was closed before the connection was established";Y(this,this._req,j);return}if(this.readyState===G.CLOSING){this._closeFrameSent&&(this._closeFrameReceived||this._receiver._writableState.errorEmitted)&&this._socket.end();return}this._readyState=G.CLOSING,this._sender.close(E,L,!this._isServer,j=>{j||(this._closeFrameSent=!0,(this._closeFrameReceived||this._receiver._writableState.errorEmitted)&&this._socket.end())}),this._closeTimer=setTimeout(this._socket.destroy.bind(this._socket),B)}}pause(){this.readyState===G.CONNECTING||this.readyState===G.CLOSED||(this._paused=!0,this._socket.pause())}ping(E,L,j){if(this.readyState===G.CONNECTING)throw new Error("WebSocket is not open: readyState 0 (CONNECTING)");if(typeof E=="function"?(j=E,E=L=void 0):typeof L=="function"&&(j=L,L=void 0),typeof E=="number"&&(E=E.toString()),this.readyState!==G.OPEN){ce(this,E,j);return}L===void 0&&(L=!this._isServer),this._sender.ping(E||t,L,j)}pong(E,L,j){if(this.readyState===G.CONNECTING)throw new Error("WebSocket is not open: readyState 0 (CONNECTING)");if(typeof E=="function"?(j=E,E=L=void 0):typeof L=="function"&&(j=L,L=void 0),typeof E=="number"&&(E=E.toString()),this.readyState!==G.OPEN){ce(this,E,j);return}L===void 0&&(L=!this._isServer),this._sender.pong(E||t,L,j)}resume(){this.readyState===G.CONNECTING||this.readyState===G.CLOSED||(this._paused=!1,this._receiver._writableState.needDrain||this._socket.resume())}send(E,L,j){if(this.readyState===G.CONNECTING)throw new Error("WebSocket is not open: readyState 0 (CONNECTING)");if(typeof L=="function"&&(j=L,L={}),typeof E=="number"&&(E=E.toString()),this.readyState!==G.OPEN){ce(this,E,j);return}let O={binary:typeof E!="string",mask:!this._isServer,compress:!0,fin:!0,...L};this._extensions[o.extensionName]||(O.compress=!1),this._sender.send(E||t,O,j)}terminate(){if(this.readyState!==G.CLOSED){if(this.readyState===G.CONNECTING){let E="WebSocket was closed before the connection was established";Y(this,this._req,E);return}this._socket&&(this._readyState=G.CLOSING,this._socket.destroy())}}};Object.defineProperty(U,"CONNECTING",{enumerable:!0,value:T.indexOf("CONNECTING")}),Object.defineProperty(U.prototype,"CONNECTING",{enumerable:!0,value:T.indexOf("CONNECTING")}),Object.defineProperty(U,"OPEN",{enumerable:!0,value:T.indexOf("OPEN")}),Object.defineProperty(U.prototype,"OPEN",{enumerable:!0,value:T.indexOf("OPEN")}),Object.defineProperty(U,"CLOSING",{enumerable:!0,value:T.indexOf("CLOSING")}),Object.defineProperty(U.prototype,"CLOSING",{enumerable:!0,value:T.indexOf("CLOSING")}),Object.defineProperty(U,"CLOSED",{enumerable:!0,value:T.indexOf("CLOSED")}),Object.defineProperty(U.prototype,"CLOSED",{enumerable:!0,value:T.indexOf("CLOSED")}),["binaryType","bufferedAmount","extensions","isPaused","protocol","readyState","url"].forEach(x=>{Object.defineProperty(U.prototype,x,{enumerable:!0})}),["open","error","close","message"].forEach(x=>{Object.defineProperty(U.prototype,`on${x}`,{enumerable:!0,get(){for(let E of this.listeners(x))if(E[S])return E[f];return null},set(E){for(let L of this.listeners(x))if(L[S]){this.removeListener(x,L);break}typeof E=="function"&&this.addEventListener(x,E,{[S]:!0})}})}),U.prototype.addEventListener=n,U.prototype.removeEventListener=C,a.exports=U;function q(x,E,L,j){let O={protocolVersion:P[1],maxPayload:104857600,skipUTF8Validation:!1,perMessageDeflate:!0,followRedirects:!1,maxRedirects:10,...j,createConnection:void 0,socketPath:void 0,hostname:void 0,protocol:void 0,timeout:void 0,method:"GET",host:void 0,path:void 0,port:void 0};if(!P.includes(O.protocolVersion))throw new RangeError(`Unsupported protocol version: ${O.protocolVersion} (supported versions: ${P.join(", ")})`);let $;if(E instanceof u)$=E,x._url=E.href;else{try{$=new u(E)}catch{throw new SyntaxError(`Invalid URL: ${E}`)}x._url=E}let J=$.protocol==="wss:",oe=$.protocol==="ws+unix:",Q;if($.protocol!=="ws:"&&!J&&!oe?Q=`The URL's protocol must be one of "ws:", "wss:", or "ws+unix:"`:oe&&!$.pathname?Q="The URL's pathname is empty":$.hash&&(Q="The URL contains a fragment identifier"),Q){let D=new SyntaxError(Q);if(x._redirects===0)throw D;V(x,D);return}let K=J?443:80,M=d(16).toString("base64"),X=J?l.request:v.request,he=new Set,W;if(O.createConnection=J?H:le,O.defaultPort=O.defaultPort||K,O.port=$.port||K,O.host=$.hostname.startsWith("[")?$.hostname.slice(1,-1):$.hostname,O.headers={...O.headers,"Sec-WebSocket-Version":O.protocolVersion,"Sec-WebSocket-Key":M,Connection:"Upgrade",Upgrade:"websocket"},O.path=$.pathname+$.search,O.timeout=O.handshakeTimeout,O.perMessageDeflate&&(W=new o(O.perMessageDeflate!==!0?O.perMessageDeflate:{},!1,O.maxPayload),O.headers["Sec-WebSocket-Extensions"]=b({[o.extensionName]:W.offer()})),L.length){for(let D of L){if(typeof D!="string"||!R.test(D)||he.has(D))throw new SyntaxError("An invalid or duplicated subprotocol was specified");he.add(D)}O.headers["Sec-WebSocket-Protocol"]=L.join(",")}if(O.origin&&(O.protocolVersion<13?O.headers["Sec-WebSocket-Origin"]=O.origin:O.headers.Origin=O.origin),($.username||$.password)&&(O.auth=`${$.username}:${$.password}`),oe){let D=O.path.split(":");O.socketPath=D[0],O.path=D[1]}let F;if(O.followRedirects){if(x._redirects===0){x._originalIpc=oe,x._originalSecure=J,x._originalHostOrSocketPath=oe?O.socketPath:$.host;let D=j&&j.headers;if(j={...j,headers:{}},D)for(let[ee,ye]of Object.entries(D))j.headers[ee.toLowerCase()]=ye}else if(x.listenerCount("redirect")===0){let D=oe?x._originalIpc?O.socketPath===x._originalHostOrSocketPath:!1:x._originalIpc?!1:$.host===x._originalHostOrSocketPath;(!D||x._originalSecure&&!J)&&(delete O.headers.authorization,delete O.headers.cookie,D||delete O.headers.host,O.auth=void 0)}O.auth&&!j.headers.authorization&&(j.headers.authorization="Basic "+Buffer.from(O.auth).toString("base64")),F=x._req=X(O),x._redirects&&x.emit("redirect",x.url,F)}else F=x._req=X(O);O.timeout&&F.on("timeout",()=>{Y(x,F,"Opening handshake has timed out")}),F.on("error",D=>{F===null||F[A]||(F=x._req=null,V(x,D))}),F.on("response",D=>{let ee=D.headers.location,ye=D.statusCode;if(ee&&O.followRedirects&&ye>=300&&ye<400){if(++x._redirects>O.maxRedirects){Y(x,F,"Maximum redirects exceeded");return}F.abort();let ke;try{ke=new u(ee,E)}catch{let ge=new SyntaxError(`Invalid URL: ${ee}`);V(x,ge);return}q(x,ke,L,j)}else x.emit("unexpected-response",F,D)||Y(x,F,`Unexpected server response: ${D.statusCode}`)}),F.on("upgrade",(D,ee,ye)=>{if(x.emit("upgrade",D),x.readyState!==U.CONNECTING)return;if(F=x._req=null,D.headers.upgrade.toLowerCase()!=="websocket"){Y(x,ee,"Invalid Upgrade header");return}let ke=e("sha1").update(M+r).digest("base64");if(D.headers["sec-websocket-accept"]!==ke){Y(x,ee,"Invalid Sec-WebSocket-Accept header");return}let ge=D.headers["sec-websocket-protocol"],xe;if(ge!==void 0?he.size?he.has(ge)||(xe="Server sent an invalid subprotocol"):xe="Server sent a subprotocol but none was requested":he.size&&(xe="Server sent no subprotocol"),xe){Y(x,ee,xe);return}ge&&(x._protocol=ge);let $e=D.headers["sec-websocket-extensions"];if($e!==void 0){if(!W){Y(x,ee,"Server sent a Sec-WebSocket-Extensions header but no extension was requested");return}let Ue;try{Ue=N($e)}catch{Y(x,ee,"Invalid Sec-WebSocket-Extensions header");return}let Ge=Object.keys(Ue);if(Ge.length!==1||Ge[0]!==o.extensionName){Y(x,ee,"Server indicated an extension that was not requested");return}try{W.accept(Ue[o.extensionName])}catch{Y(x,ee,"Invalid Sec-WebSocket-Extensions header");return}x._extensions[o.extensionName]=W}x.setSocket(ee,ye,{generateMask:O.generateMask,maxPayload:O.maxPayload,skipUTF8Validation:O.skipUTF8Validation})}),O.finishRequest?O.finishRequest(F,x):F.end()}function V(x,E){x._readyState=U.CLOSING,x.emit("error",E),x.emitClose()}function le(x){return x.path=x.socketPath,y.connect(x)}function H(x){return x.path=void 0,!x.servername&&x.servername!==""&&(x.servername=y.isIP(x.host)?"":x.host),s.connect(x)}function Y(x,E,L){x._readyState=U.CLOSING;let j=new Error(L);Error.captureStackTrace(j,Y),E.setHeader?(E[A]=!0,E.abort(),E.socket&&!E.socket.destroyed&&E.socket.destroy(),process.nextTick(V,x,j)):(E.destroy(j),E.once("error",x.emit.bind(x,"error")),E.once("close",x.emitClose.bind(x)))}function ce(x,E,L){if(E){let j=I(E).length;x._socket?x._sender._bufferedBytes+=j:x._bufferedAmount+=j}if(L){let j=new Error(`WebSocket is not open: readyState ${x.readyState} (${T[x.readyState]})`);process.nextTick(L,j)}}function je(x,E){let L=this[w];L._closeFrameReceived=!0,L._closeMessage=E,L._closeCode=x,L._socket[w]!==void 0&&(L._socket.removeListener("data",se),process.nextTick(pe,L._socket),x===1005?L.close():L.close(x,E))}function Ie(){let x=this[w];x.isPaused||x._socket.resume()}function ve(x){let E=this[w];E._socket[w]!==void 0&&(E._socket.removeListener("data",se),process.nextTick(pe,E._socket),E.close(x[h])),E.emit("error",x)}function be(){this[w].emitClose()}function we(x,E){this[w].emit("message",x,E)}function Se(x){let E=this[w];E.pong(x,!E._isServer,g),E.emit("ping",x)}function te(x){this[w].emit("pong",x)}function pe(x){x.resume()}function re(){let x=this[w];this.removeListener("close",re),this.removeListener("data",se),this.removeListener("end",de),x._readyState=U.CLOSING;let E;!this._readableState.endEmitted&&!x._closeFrameReceived&&!x._receiver._writableState.errorEmitted&&(E=x._socket.read())!==null&&x._receiver.write(E),x._receiver.end(),this[w]=void 0,clearTimeout(x._closeTimer),x._receiver._writableState.finished||x._receiver._writableState.errorEmitted?x.emitClose():(x._receiver.on("error",be),x._receiver.on("finish",be))}function se(x){this[w]._receiver.write(x)||this.pause()}function de(){let x=this[w];x._readyState=U.CLOSING,x._receiver.end(),this.end()}function fe(){let x=this[w];this.removeListener("error",fe),this.on("error",g),x&&(x._readyState=U.CLOSING,this.destroy())}}),Gt=z((p,a)=>{"use strict";var{tokenChars:m}=Ne();function l(v){let y=new Set,s=-1,d=-1,e=0;for(e;e<v.length;e++){let u=v.charCodeAt(e);if(d===-1&&m[u]===1)s===-1&&(s=e);else if(e!==0&&(u===32||u===9))d===-1&&s!==-1&&(d=e);else if(u===44){if(s===-1)throw new SyntaxError(`Unexpected character at index ${e}`);d===-1&&(d=e);let o=v.slice(s,d);if(y.has(o))throw new SyntaxError(`The "${o}" subprotocol is duplicated`);y.add(o),s=d=-1}else throw new SyntaxError(`Unexpected character at index ${e}`)}if(s===-1||d!==-1)throw new SyntaxError("Unexpected end of input");let i=v.slice(s,e);if(y.has(i))throw new SyntaxError(`The "${i}" subprotocol is duplicated`);return y.add(i),y}a.exports={parse:l}}),Vt=z((p,a)=>{"use strict";var m=require("events"),l=require("http"),v=require("https"),y=require("net"),s=require("tls"),{createHash:d}=require("crypto"),e=it(),i=Le(),u=Gt(),o=rt(),{GUID:c,kWebSocket:k}=_e(),_=/^[+/0-9A-Za-z]{22}==$/,t=0,r=1,S=2,f=class extends m{constructor(b,N){if(super(),b={maxPayload:100*1024*1024,skipUTF8Validation:!1,perMessageDeflate:!1,handleProtocols:null,clientTracking:!0,verifyClient:null,noServer:!1,backlog:null,server:null,host:null,path:null,port:null,WebSocket:o,...b},b.port==null&&!b.server&&!b.noServer||b.port!=null&&(b.server||b.noServer)||b.server&&b.noServer)throw new TypeError('One and only one of the "port", "server", or "noServer" options must be specified');if(b.port!=null?(this._server=l.createServer((I,B)=>{let A=l.STATUS_CODES[426];B.writeHead(426,{"Content-Length":A.length,"Content-Type":"text/plain"}),B.end(A)}),this._server.listen(b.port,b.host,b.backlog,N)):b.server&&(this._server=b.server),this._server){let I=this.emit.bind(this,"connection");this._removeListeners=h(this._server,{listening:this.emit.bind(this,"listening"),error:this.emit.bind(this,"error"),upgrade:(B,A,P)=>{this.handleUpgrade(B,A,P,I)}})}b.perMessageDeflate===!0&&(b.perMessageDeflate={}),b.clientTracking&&(this.clients=new Set,this._shouldEmitClose=!1),this.options=b,this._state=t}address(){if(this.options.noServer)throw new Error('The server is operating in "noServer" mode');return this._server?this._server.address():null}close(b){if(this._state===S){b&&this.once("close",()=>{b(new Error("The server is not running"))}),process.nextTick(w,this);return}if(b&&this.once("close",b),this._state!==r)if(this._state=r,this.options.noServer||this.options.server)this._server&&(this._removeListeners(),this._removeListeners=this._server=null),this.clients?this.clients.size?this._shouldEmitClose=!0:process.nextTick(w,this):process.nextTick(w,this);else{let N=this._server;this._removeListeners(),this._removeListeners=this._server=null,N.close(()=>{w(this)})}}shouldHandle(b){if(this.options.path){let N=b.url.indexOf("?");if((N!==-1?b.url.slice(0,N):b.url)!==this.options.path)return!1}return!0}handleUpgrade(b,N,I,B){N.on("error",g);let A=b.headers["sec-websocket-key"],P=+b.headers["sec-websocket-version"];if(b.method!=="GET"){C(this,b,N,405,"Invalid HTTP method");return}if(b.headers.upgrade.toLowerCase()!=="websocket"){C(this,b,N,400,"Invalid Upgrade header");return}if(!A||!_.test(A)){C(this,b,N,400,"Missing or invalid Sec-WebSocket-Key header");return}if(P!==8&&P!==13){C(this,b,N,400,"Missing or invalid Sec-WebSocket-Version header");return}if(!this.shouldHandle(b)){n(N,400);return}let T=b.headers["sec-websocket-protocol"],R=new Set;if(T!==void 0)try{R=u.parse(T)}catch{C(this,b,N,400,"Invalid Sec-WebSocket-Protocol header");return}let U=b.headers["sec-websocket-extensions"],q={};if(this.options.perMessageDeflate&&U!==void 0){let V=new i(this.options.perMessageDeflate,!0,this.options.maxPayload);try{let le=e.parse(U);le[i.extensionName]&&(V.accept(le[i.extensionName]),q[i.extensionName]=V)}catch{C(this,b,N,400,"Invalid or unacceptable Sec-WebSocket-Extensions header");return}}if(this.options.verifyClient){let V={origin:b.headers[`${P===8?"sec-websocket-origin":"origin"}`],secure:!!(b.socket.authorized||b.socket.encrypted),req:b};if(this.options.verifyClient.length===2){this.options.verifyClient(V,(le,H,Y,ce)=>{if(!le)return n(N,H||401,Y,ce);this.completeUpgrade(q,A,R,b,N,I,B)});return}if(!this.options.verifyClient(V))return n(N,401)}this.completeUpgrade(q,A,R,b,N,I,B)}completeUpgrade(b,N,I,B,A,P,T){if(!A.readable||!A.writable)return A.destroy();if(A[k])throw new Error("server.handleUpgrade() was called more than once with the same socket, possibly due to a misconfiguration");if(this._state>t)return n(A,503);let R=["HTTP/1.1 101 Switching Protocols","Upgrade: websocket","Connection: Upgrade",`Sec-WebSocket-Accept: ${d("sha1").update(N+c).digest("base64")}`],U=new this.options.WebSocket(null);if(I.size){let q=this.options.handleProtocols?this.options.handleProtocols(I,B):I.values().next().value;q&&(R.push(`Sec-WebSocket-Protocol: ${q}`),U._protocol=q)}if(b[i.extensionName]){let q=b[i.extensionName].params,V=e.format({[i.extensionName]:[q]});R.push(`Sec-WebSocket-Extensions: ${V}`),U._extensions=b}this.emit("headers",R,B),A.write(R.concat(`\r
`).join(`\r
`)),A.removeListener("error",g),U.setSocket(A,P,{maxPayload:this.options.maxPayload,skipUTF8Validation:this.options.skipUTF8Validation}),this.clients&&(this.clients.add(U),U.on("close",()=>{this.clients.delete(U),this._shouldEmitClose&&!this.clients.size&&process.nextTick(w,this)})),T(U,B)}};a.exports=f;function h(b,N){for(let I of Object.keys(N))b.on(I,N[I]);return function(){for(let I of Object.keys(N))b.removeListener(I,N[I])}}function w(b){b._state=S,b.emit("close")}function g(){this.destroy()}function n(b,N,I,B){I=I||l.STATUS_CODES[N],B={Connection:"close","Content-Type":"text/html","Content-Length":Buffer.byteLength(I),...B},b.once("finish",b.destroy),b.end(`HTTP/1.1 ${N} ${l.STATUS_CODES[N]}\r
`+Object.keys(B).map(A=>`${A}: ${B[A]}`).join(`\r
`)+`\r
\r
`+I)}function C(b,N,I,B,A){if(b.listenerCount("wsClientError")){let P=new Error(A);Error.captureStackTrace(P,C),b.emit("wsClientError",P,I,N)}else n(I,B,A)}}),st={};Nt(st,{chronocat:()=>Bi});ut.exports=jt(st);var Pe={},Me={},Ae={},ot={},at={},Ce={},nt={},Re=require("electron"),Kt=p=>{let a=Re.ipcMain.emit;return Re.ipcMain.emit=function(m,...l){let v=l[0],y=l?.[1],s=l?.[2],d=v.sender;if(!d.__CHRONO_HOOKED__){let i=d.send;d.__CHRONO_HOOKED__=!0,d.send=function(u,o,c){if(p({Full:[u,o,c],EventName:o.eventName,CmdName:c?.[0]?.cmdName,Payload:c?.[0]?.payload,Request:Ae[o.callbackId]}),i.call(this,u,o,c),o.callbackId){let k=o.callbackId;Pe[k]&&Pe[k]?.call(o,c),Me[o.callbackId]&&(Me[o.callbackId].resolved=c)}delete Ae[o.callbackId]}}let e={Full:l,EventName:y?.eventName,Method:s?.[0],Args:s,Channel:m};return a.call(this,m,...l),y?.eventName?.includes("Log")||(Me[y?.callbackId]??={},Ae[y?.callbackId]=e),!1},()=>{Re.ipcMain.emit=a}},Ht={body:"none",httpOnly:!1,requireAuthorize:!0},lt=[],We=(p,a)=>new Proxy(()=>{},{get(m,l){if(typeof l=="symbol")throw Error("Symbol is not supported");return l.startsWith("$")?v=>We(p,{...a,[l.slice(1)]:v}):We([...p,l],a)},set(m,l,v,y){throw Error("Cannot set property on router")},apply(m,l,[v,y]){lt.push({path:p,options:{...a,...y},handler:v})}}),ie=We([],Ht),Ke=p=>lt.find(a=>!a.path.some((m,l)=>m!==p[l]));ie.bot.friends(async()=>Object.values(at));ie.bot.groups(async()=>Object.values(ot));ie.getSelfProfile(async()=>nt.value??{});var Yt=require("electron"),Jt=()=>{let p=new Date().getTime();return p+=performance.now(),"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,a=>{let m=(p+Math.random()*16)%16|0;return p=Math.floor(p/16),(a==="x"?m:m&3|8).toString(16)})},Xt=async(p,a,...m)=>{let l=Jt(),v=await Promise.race([new Promise((y,s)=>setTimeout(()=>s(),5e3)),new Promise(y=>{Pe[l]=y,Yt.ipcMain.emit(p,{sender:{send:(...s)=>{y(s)},__CHRONO_HOOKED__:!0}},{type:"request",callbackId:l,eventName:a},m)})]);return delete Pe[l],v};function Z(p,a,m){return(...l)=>Xt(p,a,m,...l)}var ct=Z("IPC_UP_2","ns-ntApi-2","nodeIKernelGroupService/createMemberListScene"),Zt=Z("IPC_UP_2","ns-ntApi-2","nodeIKernelGroupService/searchMember"),qe=Z("IPC_UP_2","ns-ntApi-2","nodeIKernelGroupService/destroyMemberListScene"),Qt=Z("IPC_UP_2","ns-ntApi-2","nodeIKernelGroupService/getNextMemberList"),ei=Z("IPC_UP_2","ns-ntApi-2","nodeIKernelGroupService/setMemberShutUp"),ti=Z("IPC_UP_2","ns-ntApi-2","nodeIKernelGroupService/setGroupShutUp"),ii=Z("IPC_UP_2","ns-ntApi-2","nodeIKernelGroupService/kickMember"),ht=p=>{};ie.group.getMemberList.$body("json")(async({body:p})=>{let{group:a,size:m}=p,l=await ct({groupCode:a,scene:"groupMemberList_MainWindow"}),v=await Qt({sceneId:l,lastId:void 0,num:m});return await qe({sceneId:l}),ht(qe({sceneId:l})),v.result?.ids?.map(({uid:y,index:s})=>({uid:y,index:s,detail:v.result.infos.get(y)}))});var ri=ne(It()),si=class{#e={};get(p,a){a(this.#e[p])}set(p,a,m){this.#e[p]=a,m()}clear(p){this.#e={},p()}};function oi(p){let a=Math.floor(Math.random()*1e8).toString(36),m=new si;function l(){return function(...v){let y=this,s=v.slice(),d=s.pop(),e=a+"="+(0,ri.default)(s);m.get(e,function(i){if(i&&(!i.expires||i.expires>=Date.now()))return d.apply(y,i.args);s.push(function(...u){let o=this,c=u.slice();m.set(e,{args:c,expires:Date.now()+3e4},function(){d.apply(o,c)})}),p.apply(p,s)})}}return l()}var me={},pt=p=>{let a=[],m=l=>{for(let v in l)l[v]instanceof Map||(l[v]instanceof Object?m(l[v]):a.push([v,l[v],l]))};return m(p),a},De=p=>{let a={uid:"uin",uin:"uid",Uid:"Uin",Uin:"Uid"};for(let m in a)if(p.endsWith(m))return p.slice(0,-m.length)+a[m]},dt=(p,a)=>{parseInt(p)===0||parseInt(a)===0||(me[p]=a,me[a]=p)},He=oi(async p=>{let a=await ct({groupCode:p,scene:"groupMemberList_MainWindow"});ht(Zt({sceneId:a,keyword:p})),await qe({sceneId:a})}),ai=p=>{for(let[a,m,l]of pt(p)){let v=De(a);if(v&&l[v]){if(parseInt(l[v])==0||!l[v]||l[v].includes("*")||me[m])continue;dt(m,l[v])}}},ni=async(p,{contextGroup:a=-1}={})=>{let m=pt(p);for(let[l,v,y]of m){let s=De(l);s&&!y[s]&&(l.toLocaleLowerCase().endsWith("uin")&&a!==-1&&He(a,v),l==="atNtUid"&&He(a,y.content.slice(1)))}await new Promise(l=>setTimeout(l,80));for(let[l,v,y]of m){let s=De(l);l==="peerUin"&&y.chatType===2&&(y.peerUid=v),l==="peerUid"&&!v.startsWith("u_")&&(y.peerUin=v),s&&!y[s]&&me[v]&&(y[s]=me[v])}return p},li=p=>p.map(a=>me[a]??a),ae={cacheObject:ai,preprocessObject:ni,addToMap:dt,preprocessArrayOfUix:li,map:me};ie.group.kick.$body("json")(async({body:p})=>{let{uidList:a,group:m,reason:l,refuseForever:v}=p;return await ii({groupCode:m,kickUids:ae.preprocessArrayOfUix(a),refuseForever:v,kickReason:l})});ie.group.muteEveryone.$body("json")(async({body:p})=>{let{group:a,enable:m}=p;return await ti({groupCode:a,shutUp:m})});ie.group.muteMember.$body("json")(async({body:p})=>{let{group:a,memList:m}=p;return await ei({groupCode:a,memList:await ae.preprocessObject(m,{contextGroup:Number(a)})})});var ci=ne(At()),hi=require("node:fs"),pi=Z("IPC_UP_2","ns-ntApi-2","nodeIKernelMsgService/recallMsg"),di=Z("IPC_UP_2","ns-ntApi-2","nodeIKernelMsgService/downloadRichMedia"),fi=Z("IPC_UP_2","ns-ntApi-2","nodeIKernelMsgService/getMsgsIncludeSelf"),ui=Z("IPC_UP_2","ns-ntApi-2","nodeIKernelMsgService/getRichMediaFilePath"),mi=Z("IPC_UP_2","ns-ntApi-2","nodeIKernelMsgService/sendMsg");ie.message.fetchRichMedia.$body("json").$httpOnly(!0)(async({body:p,http:a})=>{let{msgId:m,elementId:l,chatType:v,peerUid:y}=p,s=m+"::"+l;console.log("DownloadId:",s);let d=new Promise(i=>{Ce[s]=i});v===1&&!y.startsWith("u_")&&(y=ae.map[y]),await di({getReq:{msgId:m,chatType:v,peerUid:y,elementId:l,thumbSize:0,downloadType:2}});let e=await d;a.res.statusCode=200,a.res.setHeader("Content-Type",(0,ci.getType)(e)),(0,hi.createReadStream)(e).pipe(a.res)});ie.message.getHistory.$body("json")(async({body:p})=>{let{peer:a,offsetMsgId:m,count:l}=p;return await fi({peer:await ae.preprocessObject(a),msgId:m,cnt:l,queryOrder:!0})});ie.message.recall.$body("json")(async({body:p})=>{let{peer:a,msgIds:m}=p;return pi({peer:await ae.preprocessObject(a),msgIds:m})});var Ye=ne(Rt()),ft=p=>"peer"in p?!p.elements.some(a=>a.walletElement||a.arkElement):!(p.msgType===Ye.MsgType.Ark||p.msgType===Ye.MsgType.Wallet),Je={atTinyUid:"",elementId:"",msgId:"0",chatType:1,guildId:"",peerUid:"",peerUin:"",elementType:1,content:"",atUid:"",atNtUid:"",atType:0,extBufForUI:"",fileName:"",fileSize:"",fileSubId:"",fileUuid:"",md5HexStr:"",original:!0,picHeight:0,picWidth:0,picType:0,picSubType:0,sourcePath:"",summary:"",thumbFileSize:0},_i=p=>{let a=m=>{for(let l in m)if(typeof m[l]=="object"&&m[l]!==null)a(m[l]);else for(let v in Je)m[v]??=Je[v]};return a(p),p};ie.message.send.$body("json")(async({body:p})=>{let a=p;return ft(a)?(_i(a),await mi({msgId:"0",peer:await ae.preprocessObject(a.peer),msgElements:await ae.preprocessObject(a.elements,{contextGroup:a.peer.chatType===2?Number(a.peer.peerUin):void 0})}),{}):{}});var yi=ne(Dt()),gi=require("node:crypto"),bi=require("node:fs"),Xe=require("node:fs/promises"),Ze=require("node:path"),xi=Z("IPC_UP_2","ns-fsApi-2","getFileMd5"),vi=Z("IPC_UP_2","ns-fsApi-2","getImageSizeFromPath"),wi=Z("IPC_UP_2","ns-fsApi-2","getFileSize"),Si=Z("IPC_UP_2","ns-fsApi-2","getFileType"),ki=require("node:os"),Ei=require("node:path"),Fe=(0,Ei.join)(process.env.APPDATA||(0,ki.homedir)(),"BetterUniverse/QQNT");ie.upload.$body("binary").$httpOnly("POST")(async({http:{req:p,res:a}})=>{let m=(0,yi.default)({headers:p.headers}),l,v;m.on("file",(y,s,d)=>void(async()=>{let e=(0,Ze.join)(Fe,"redprotocol-upload");await(0,Xe.mkdir)(e,{recursive:!0}),l=(0,Ze.join)(e,`${(0,gi.randomFillSync)(Buffer.alloc(16)).toString("hex")}-${d.filename}`),v=d,s.pipe((0,bi.createWriteStream)(l))})()),m.on("close",()=>void(async()=>{if(!l){a.writeHead(400),a.end("400 bad request");return}let y=(await Si(l)).mime.split("/")[0],[s,d,e]=await Promise.all([xi(l),y==="image"?vi(l):void 0,wi(l)]),i=await ui({md5HexStr:s,fileName:v.filename,elementType:2,elementSubType:0,thumbSize:0,needCreate:!0,fileType:1});await(0,Xe.copyFile)(l,i),a.writeHead(200),a.end(JSON.stringify({md5:s,imageInfo:d,fileSize:e,filePath:l,ntFilePath:i}))})()),p.pipe(m)});var Ci=p=>a=>a.headers.authorization?.slice(0,7)==="Bearer "&&a.headers.authorization.slice(7)===p,Pi=p=>a=>a.token===p,Ti=require("node:http"),Oi=class{constructor(p,{authorizer:a,rootPath:m="/api/",port:l}){this.server=(0,Ti.createServer)(async(v,y)=>{if(!v.url){y.writeHead(400),y.end("404 bad request");return}let s=new URL(v.url,`http://${v.headers.host}`);if(!s.pathname.startsWith(m)){y.writeHead(404),y.end("404 not found");return}let d=s.pathname.slice(m.length).split("/").filter(i=>i),e=p(d);if(e){e.options.requireAuthorize&&!await a(v)&&(y.writeHead(401),y.end("401 unauthorized"));let i=k=>{let _=[];return new Promise((t,r)=>{k.on("data",S=>{_.push(S)}),k.on("end",()=>{t(Buffer.concat(_))}),k.on("error",()=>{r()})})},u=async k=>(await i(k)).toString("utf-8"),o;e.options.body==="binary"?o=await i(v):e.options.body==="json"?o=JSON.parse(await u(v)):e.options.body==="text"&&(o=await u(v));let c={http:e.options.httpOnly&&{req:v,res:y},body:o};y.writeHead(200),y.end(await e.handler(c))}else y.writeHead(404),y.end("404 not found")}),this.server.listen(l)}server;stop(){this.server.close()}},Li={createServer:(p,a)=>new Oi(p,a)},Fi=ne(Ft(),1),zi=ne(et(),1),$i=ne(tt(),1),Gi=ne(rt(),1),Ni=ne(Vt(),1),ji=class{constructor(p,{authorizer:a,rootPath:m="/",mountHTTPServer:l,port:v,connectPayload:y}){this.server=new Ni.default({server:l,port:v,path:m}),this.server.on("connection",async s=>{s.once("message",async d=>{try{let e=JSON.parse(d.toString()),{type:i,payload:u}=e;if(i==="meta::connect"){if(!await a(u)){s.close(401);return}this.wsAuthedClients.push(s),s.on("message",async o=>{let c=JSON.parse(o.toString());if(typeof i!="string")return;let k=c.type.split("::"),_=p(k);await this.handleRoute(_,s,c)}),s.on("disconnect",()=>this.wsAuthedClients.splice(this.wsAuthedClients.indexOf(s),1)),s.send(JSON.stringify({type:"meta::connect",payload:y()}))}else if(typeof i=="string"){let o=i.split("::"),c=p(o);if(c.options.requireAuthorize)throw Error("Authorize needed");await this.handleRoute(c,s,e)}else throw new Error("Invalid API type")}catch{s.close(401)}})})}server;wsAuthedClients=[];async handleRoute(p,a,m){let l=v=>a.send(JSON.stringify({type:`${p.path.join("::")}::reply`,payload:v,echo:m.echo}));if(p){let{payload:v}=m;if(p.options.httpOnly)return l({error:"route not supported",reason:"This route is http only"});if(p.options.body==="binary")return l({error:"route not supported",reason:"Binary body is not supported for websocket"});if(p.options.body==="json"&&typeof v!="object")return l({error:"invalid payload",reason:"Payload must be an object for this route"});if(p.options.body==="text"&&typeof v!="string")return l({error:"invalid payload",reason:"Payload must be a string for this route"});let y={body:v,http:void 0};try{let s=await p.handler(y);l(s)}catch(s){console.error(s),l({error:"internal error",reason:"Internal error occurred"})}}else l({error:"route error",reason:"Route not found"})}broadcast(p,a){this.wsAuthedClients.forEach(m=>m.send(JSON.stringify({type:p,payload:a})))}stop(){this.server.close()}},Ii={createServer:(p,a)=>new ji(p,a)},Ui=(p,a)=>{let m=Li.createServer(Ke,{authorizer:Ci(p),rootPath:"/api/",port:16530}),l=Ii.createServer(Ke,{authorizer:Pi(p),rootPath:"/",mountHTTPServer:m.server,connectPayload:a});return{binaryServer:m,broadcastAbleServer:l}},Mi=require("node:crypto"),Be=require("node:fs/promises"),Ai=require("node:path"),Ri=async()=>{let p=(0,Ai.join)(Fe,"RED_PROTOCOL_TOKEN");try{return(await(0,Be.readFile)(p,"utf-8")).trim()}catch{}let a=(0,Mi.randomBytes)(32).toString("hex");return await(0,Be.mkdir)(Fe,{recursive:!0}),await(0,Be.writeFile)(p,a),a},Bi=async()=>{let p=await Ri(),{broadcastAbleServer:a,binaryServer:m}=Ui(p,()=>({version:"0.0.37",name:"chronocat",authData})),l=(y,s)=>a.broadcast(y,s),v=Kt(async({CmdName:y,Payload:s})=>{try{ae.cacheObject(s)}catch{}switch(y){case"nodeIKernelMsgListener/onRecvMsg":{let d=s;l("message::recv",await Promise.all(d.msgList.filter(ft).map(async e=>await ae.preprocessObject(e))));return}case"nodeIKernelProfileListener/onProfileSimpleChanged":case"nodeIKernelGroupListener/onSearchMemberChange":case"nodeIKernelGroupService/getNextMemberList":{let d=s;d.profiles.get(authData.uid)&&(nt.value=d.profiles.get(authData.uid));let e=d.profiles??d.infos;for(let[i,{uin:u}]of e)ae.addToMap(i,u);return}case"nodeIKernelMsgListener/onRichMediaDownloadComplete":{let d=s,e=`${d.notifyInfo.msgId}::${d.notifyInfo.msgElementId}`;Ce[e]&&(Ce[e](d.notifyInfo.filePath),delete Ce[e]);return}case"nodeIKernelGroupListener/onGroupListUpdate":{let d=s;for(let e of d.groupList)ot[e.groupCode]=e;return}case"nodeIKernelBuddyListener/onBuddyListChange":{let d=s;for(let e of d.data)for(let i of e.buddyList)i.category=e.categoryName,at[i.uin]=i;return}}});return()=>{v(),m.stop(),a.stop()}}});var qi={};St(qi,{onLoad:()=>Wi});module.exports=Et(qi);var _t=kt(mt()),Wi=()=>(0,_t.chronocat)();0&&(module.exports={onLoad});
//# sourceMappingURL=index.js.map
