"use strict";var vt=Object.create;var Ee=Object.defineProperty;var xt=Object.getOwnPropertyDescriptor;var wt=Object.getOwnPropertyNames;var St=Object.getPrototypeOf,kt=Object.prototype.hasOwnProperty;var Ct=(f,a)=>()=>(a||f((a={exports:{}}).exports,a),a.exports),Et=(f,a)=>{for(var m in a)Ee(f,m,{get:a[m],enumerable:!0})},Ke=(f,a,m,l)=>{if(a&&typeof a=="object"||typeof a=="function")for(let x of wt(a))!kt.call(f,x)&&x!==m&&Ee(f,x,{get:()=>a[x],enumerable:!(l=xt(a,x))||l.enumerable});return f};var Pt=(f,a,m)=>(m=f!=null?vt(St(f)):{},Ke(a||!f||!f.__esModule?Ee(m,"default",{value:f,enumerable:!0}):m,f)),Tt=f=>Ke(Ee({},"__esModule",{value:!0}),f);var gt=Ct((Yi,yt)=>{"use strict";var Ot=Object.create,Oe=Object.defineProperty,Lt=Object.getOwnPropertyDescriptor,It=Object.getOwnPropertyNames,jt=Object.getPrototypeOf,Nt=Object.prototype.hasOwnProperty,F=(f,a)=>()=>(a||f((a={exports:{}}).exports,a),a.exports),Ut=(f,a)=>{for(var m in a)Oe(f,m,{get:a[m],enumerable:!0})},tt=(f,a,m,l)=>{if(a&&typeof a=="object"||typeof a=="function")for(let x of It(a))!Nt.call(f,x)&&x!==m&&Oe(f,x,{get:()=>a[x],enumerable:!(l=Lt(a,x))||l.enumerable});return f},ne=(f,a,m)=>(m=f!=null?Ot(jt(f)):{},tt(a||!f||!f.__esModule?Oe(m,"default",{value:f,enumerable:!0}):m,f)),Mt=f=>tt(Oe({},"__esModule",{value:!0}),f),it=F((f,a)=>{"use strict";var m=Object.create,l=Object.defineProperty,x=Object.getOwnPropertyDescriptor,y=Object.getOwnPropertyNames,r=Object.getPrototypeOf,h=Object.prototype.hasOwnProperty,e=(d,w)=>{for(var g in w)l(d,g,{get:w[g],enumerable:!0})},i=(d,w,g,n)=>{if(w&&typeof w=="object"||typeof w=="function")for(let E of y(w))!h.call(d,E)&&E!==g&&l(d,E,{get:()=>w[E],enumerable:!(n=x(w,E))||n.enumerable});return d},c=(d,w,g)=>(g=d!=null?m(r(d)):{},i(w||!d||!d.__esModule?l(g,"default",{value:d,enumerable:!0}):g,d)),o=d=>i(l({},"__esModule",{value:!0}),d),p={};e(p,{ChatType:()=>s,MsgType:()=>S,SendType:()=>u,r:()=>t}),a.exports=o(p);var k=c(require("node:path")),_=()=>{let d={"payload/sendMsg":{msgId:"0",elements:[]},"peer/private":{chatType:1,guildId:"",peerUid:"",peerUin:""},"peer/group":{chatType:2,guildId:"",peerUid:"",peerUin:""}},w=(g,n)=>Object.assign({},d[g],n);return Object.defineProperties(w,Object.fromEntries(Object.entries({reg:d,peerPrivate:g=>w("peer/private",{peerUin:g}),peerGroup:g=>w("peer/group",{peerUin:g}),text:g=>({elementId:"",elementType:1,textElement:{content:g,atUid:"",atNtUid:"",atTinyUid:"",atType:0}}),at:(g,n)=>({elementId:"",elementType:1,textElement:{content:`@${g}`,atUid:n==="all"?"all":"",atNtUin:n==="all"?void 0:n,atNtUid:n==="all"?"all":void 0,atTinyUid:"",atType:n==="all"?1:2}}),remoteImage:(g,n)=>({elementId:"",elementType:2,extBufForUI:"",picElement:{fileName:k.default.basename(g.ntFilePath),fileSize:String(g.fileSize),fileSubId:"",fileUuid:"",md5HexStr:g.md5,original:!0,picHeight:g.imageInfo.height,picWidth:g.imageInfo.width,picType:n,picSubType:0,sourcePath:g.ntFilePath,summary:"",thumbFileSize:0}})}).map(([g,n])=>[g,{value:n}])))},t=_(),s=(d=>(d[d.Private=1]="Private",d[d.Group=2]="Group",d))(s||{}),S=(d=>(d[d.Normal=2]="Normal",d[d.Value3=3]="Value3",d[d.System=5]="System",d[d.Ptt=6]="Ptt",d[d.Video=7]="Video",d[d.Value8=8]="Value8",d[d.WithRecords=9]="WithRecords",d[d.Wallet=10]="Wallet",d[d.Ark=11]="Ark",d[d.Vaule17=17]="Vaule17",d))(S||{}),u=(d=>(d[d.Normal=0]="Normal",d[d.System=3]="System",d))(u||{})}),At=F((f,a)=>{"use strict";function m(y,r,h="  ",e=""){return i(y,r,h===!1?"":h,e,[]);function i(c,o,p,k,_){let t=k+p;switch(c=o?o(c):c,typeof c){case"string":return JSON.stringify(c);case"number":return Object.is(c,-0)?"-0":String(c);case"boolean":case"undefined":return String(c);case"function":return c.toString()}if(c===null)return"null";if(c instanceof RegExp)return c.toString();if(c instanceof Date)return`new Date(${c.getTime()})`;if(c instanceof Set)return`new Set(${i(Array.from(c.values()),o,p,t,_)})`;if(c instanceof Map)return`new Map(${i(Array.from(c.entries()),o,p,t,_)})`;if(_.indexOf(c)>=0)return"{$circularReference:1}";_.push(c);function s(u){return p.slice(1)+u.join(","+(p&&`
`)+t)+(p?" ":"")}if(Array.isArray(c))return`[${s(c.map(u=>i(u,o,p,t,_.slice())))}]`;let S=Object.keys(c);return S.length?`{${s(S.map(u=>(x(u)?u:JSON.stringify(u))+":"+i(c[u],o,p,t,_.slice())))}}`:"{}"}}var l=/^(abstract|boolean|break|byte|case|catch|char|class|const|continue|debugger|default|delete|do|double|else|enum|export|extends|false|final|finally|float|for|function|goto|if|implements|import|in|instanceof|int|interface|long|native|new|null|package|private|protected|public|return|short|static|super|switch|synchronized|this|throw|throws|transient|true|try|typeof|undefined|var|void|volatile|while|with)$/;function x(y){return/^([a-z_$][0-9a-z_$]*|[0-9]+)$/gi.test(y)&&!l.test(y)}a.exports=m}),Rt=F((f,a)=>{"use strict";function m(){this._types=Object.create(null),this._extensions=Object.create(null);for(let l=0;l<arguments.length;l++)this.define(arguments[l]);this.define=this.define.bind(this),this.getType=this.getType.bind(this),this.getExtension=this.getExtension.bind(this)}m.prototype.define=function(l,x){for(let y in l){let r=l[y].map(function(h){return h.toLowerCase()});y=y.toLowerCase();for(let h=0;h<r.length;h++){let e=r[h];if(e[0]!=="*"){if(!x&&e in this._types)throw new Error('Attempt to change mapping for "'+e+'" extension from "'+this._types[e]+'" to "'+y+'". Pass `force=true` to allow this, otherwise remove "'+e+'" from the list of extensions for "'+y+'".');this._types[e]=y}}if(x||!this._extensions[y]){let h=r[0];this._extensions[y]=h[0]!=="*"?h:h.substr(1)}}},m.prototype.getType=function(l){l=String(l);let x=l.replace(/^.*[/\\]/,"").toLowerCase(),y=x.replace(/^.*\./,"").toLowerCase(),r=x.length<l.length;return(y.length<x.length-1||!r)&&this._types[y]||null},m.prototype.getExtension=function(l){return l=/^\s*([^;\s]*)/.test(l)&&RegExp.$1,l&&this._extensions[l.toLowerCase()]||null},a.exports=m}),Bt=F((f,a)=>{a.exports={"application/andrew-inset":["ez"],"application/applixware":["aw"],"application/atom+xml":["atom"],"application/atomcat+xml":["atomcat"],"application/atomdeleted+xml":["atomdeleted"],"application/atomsvc+xml":["atomsvc"],"application/atsc-dwd+xml":["dwd"],"application/atsc-held+xml":["held"],"application/atsc-rsat+xml":["rsat"],"application/bdoc":["bdoc"],"application/calendar+xml":["xcs"],"application/ccxml+xml":["ccxml"],"application/cdfx+xml":["cdfx"],"application/cdmi-capability":["cdmia"],"application/cdmi-container":["cdmic"],"application/cdmi-domain":["cdmid"],"application/cdmi-object":["cdmio"],"application/cdmi-queue":["cdmiq"],"application/cu-seeme":["cu"],"application/dash+xml":["mpd"],"application/davmount+xml":["davmount"],"application/docbook+xml":["dbk"],"application/dssc+der":["dssc"],"application/dssc+xml":["xdssc"],"application/ecmascript":["es","ecma"],"application/emma+xml":["emma"],"application/emotionml+xml":["emotionml"],"application/epub+zip":["epub"],"application/exi":["exi"],"application/express":["exp"],"application/fdt+xml":["fdt"],"application/font-tdpfr":["pfr"],"application/geo+json":["geojson"],"application/gml+xml":["gml"],"application/gpx+xml":["gpx"],"application/gxf":["gxf"],"application/gzip":["gz"],"application/hjson":["hjson"],"application/hyperstudio":["stk"],"application/inkml+xml":["ink","inkml"],"application/ipfix":["ipfix"],"application/its+xml":["its"],"application/java-archive":["jar","war","ear"],"application/java-serialized-object":["ser"],"application/java-vm":["class"],"application/javascript":["js","mjs"],"application/json":["json","map"],"application/json5":["json5"],"application/jsonml+json":["jsonml"],"application/ld+json":["jsonld"],"application/lgr+xml":["lgr"],"application/lost+xml":["lostxml"],"application/mac-binhex40":["hqx"],"application/mac-compactpro":["cpt"],"application/mads+xml":["mads"],"application/manifest+json":["webmanifest"],"application/marc":["mrc"],"application/marcxml+xml":["mrcx"],"application/mathematica":["ma","nb","mb"],"application/mathml+xml":["mathml"],"application/mbox":["mbox"],"application/mediaservercontrol+xml":["mscml"],"application/metalink+xml":["metalink"],"application/metalink4+xml":["meta4"],"application/mets+xml":["mets"],"application/mmt-aei+xml":["maei"],"application/mmt-usd+xml":["musd"],"application/mods+xml":["mods"],"application/mp21":["m21","mp21"],"application/mp4":["mp4s","m4p"],"application/msword":["doc","dot"],"application/mxf":["mxf"],"application/n-quads":["nq"],"application/n-triples":["nt"],"application/node":["cjs"],"application/octet-stream":["bin","dms","lrf","mar","so","dist","distz","pkg","bpk","dump","elc","deploy","exe","dll","deb","dmg","iso","img","msi","msp","msm","buffer"],"application/oda":["oda"],"application/oebps-package+xml":["opf"],"application/ogg":["ogx"],"application/omdoc+xml":["omdoc"],"application/onenote":["onetoc","onetoc2","onetmp","onepkg"],"application/oxps":["oxps"],"application/p2p-overlay+xml":["relo"],"application/patch-ops-error+xml":["xer"],"application/pdf":["pdf"],"application/pgp-encrypted":["pgp"],"application/pgp-signature":["asc","sig"],"application/pics-rules":["prf"],"application/pkcs10":["p10"],"application/pkcs7-mime":["p7m","p7c"],"application/pkcs7-signature":["p7s"],"application/pkcs8":["p8"],"application/pkix-attr-cert":["ac"],"application/pkix-cert":["cer"],"application/pkix-crl":["crl"],"application/pkix-pkipath":["pkipath"],"application/pkixcmp":["pki"],"application/pls+xml":["pls"],"application/postscript":["ai","eps","ps"],"application/provenance+xml":["provx"],"application/pskc+xml":["pskcxml"],"application/raml+yaml":["raml"],"application/rdf+xml":["rdf","owl"],"application/reginfo+xml":["rif"],"application/relax-ng-compact-syntax":["rnc"],"application/resource-lists+xml":["rl"],"application/resource-lists-diff+xml":["rld"],"application/rls-services+xml":["rs"],"application/route-apd+xml":["rapd"],"application/route-s-tsid+xml":["sls"],"application/route-usd+xml":["rusd"],"application/rpki-ghostbusters":["gbr"],"application/rpki-manifest":["mft"],"application/rpki-roa":["roa"],"application/rsd+xml":["rsd"],"application/rss+xml":["rss"],"application/rtf":["rtf"],"application/sbml+xml":["sbml"],"application/scvp-cv-request":["scq"],"application/scvp-cv-response":["scs"],"application/scvp-vp-request":["spq"],"application/scvp-vp-response":["spp"],"application/sdp":["sdp"],"application/senml+xml":["senmlx"],"application/sensml+xml":["sensmlx"],"application/set-payment-initiation":["setpay"],"application/set-registration-initiation":["setreg"],"application/shf+xml":["shf"],"application/sieve":["siv","sieve"],"application/smil+xml":["smi","smil"],"application/sparql-query":["rq"],"application/sparql-results+xml":["srx"],"application/srgs":["gram"],"application/srgs+xml":["grxml"],"application/sru+xml":["sru"],"application/ssdl+xml":["ssdl"],"application/ssml+xml":["ssml"],"application/swid+xml":["swidtag"],"application/tei+xml":["tei","teicorpus"],"application/thraud+xml":["tfi"],"application/timestamped-data":["tsd"],"application/toml":["toml"],"application/trig":["trig"],"application/ttml+xml":["ttml"],"application/ubjson":["ubj"],"application/urc-ressheet+xml":["rsheet"],"application/urc-targetdesc+xml":["td"],"application/voicexml+xml":["vxml"],"application/wasm":["wasm"],"application/widget":["wgt"],"application/winhlp":["hlp"],"application/wsdl+xml":["wsdl"],"application/wspolicy+xml":["wspolicy"],"application/xaml+xml":["xaml"],"application/xcap-att+xml":["xav"],"application/xcap-caps+xml":["xca"],"application/xcap-diff+xml":["xdf"],"application/xcap-el+xml":["xel"],"application/xcap-ns+xml":["xns"],"application/xenc+xml":["xenc"],"application/xhtml+xml":["xhtml","xht"],"application/xliff+xml":["xlf"],"application/xml":["xml","xsl","xsd","rng"],"application/xml-dtd":["dtd"],"application/xop+xml":["xop"],"application/xproc+xml":["xpl"],"application/xslt+xml":["*xsl","xslt"],"application/xspf+xml":["xspf"],"application/xv+xml":["mxml","xhvml","xvml","xvm"],"application/yang":["yang"],"application/yin+xml":["yin"],"application/zip":["zip"],"audio/3gpp":["*3gpp"],"audio/adpcm":["adp"],"audio/amr":["amr"],"audio/basic":["au","snd"],"audio/midi":["mid","midi","kar","rmi"],"audio/mobile-xmf":["mxmf"],"audio/mp3":["*mp3"],"audio/mp4":["m4a","mp4a"],"audio/mpeg":["mpga","mp2","mp2a","mp3","m2a","m3a"],"audio/ogg":["oga","ogg","spx","opus"],"audio/s3m":["s3m"],"audio/silk":["sil"],"audio/wav":["wav"],"audio/wave":["*wav"],"audio/webm":["weba"],"audio/xm":["xm"],"font/collection":["ttc"],"font/otf":["otf"],"font/ttf":["ttf"],"font/woff":["woff"],"font/woff2":["woff2"],"image/aces":["exr"],"image/apng":["apng"],"image/avif":["avif"],"image/bmp":["bmp"],"image/cgm":["cgm"],"image/dicom-rle":["drle"],"image/emf":["emf"],"image/fits":["fits"],"image/g3fax":["g3"],"image/gif":["gif"],"image/heic":["heic"],"image/heic-sequence":["heics"],"image/heif":["heif"],"image/heif-sequence":["heifs"],"image/hej2k":["hej2"],"image/hsj2":["hsj2"],"image/ief":["ief"],"image/jls":["jls"],"image/jp2":["jp2","jpg2"],"image/jpeg":["jpeg","jpg","jpe"],"image/jph":["jph"],"image/jphc":["jhc"],"image/jpm":["jpm"],"image/jpx":["jpx","jpf"],"image/jxr":["jxr"],"image/jxra":["jxra"],"image/jxrs":["jxrs"],"image/jxs":["jxs"],"image/jxsc":["jxsc"],"image/jxsi":["jxsi"],"image/jxss":["jxss"],"image/ktx":["ktx"],"image/ktx2":["ktx2"],"image/png":["png"],"image/sgi":["sgi"],"image/svg+xml":["svg","svgz"],"image/t38":["t38"],"image/tiff":["tif","tiff"],"image/tiff-fx":["tfx"],"image/webp":["webp"],"image/wmf":["wmf"],"message/disposition-notification":["disposition-notification"],"message/global":["u8msg"],"message/global-delivery-status":["u8dsn"],"message/global-disposition-notification":["u8mdn"],"message/global-headers":["u8hdr"],"message/rfc822":["eml","mime"],"model/3mf":["3mf"],"model/gltf+json":["gltf"],"model/gltf-binary":["glb"],"model/iges":["igs","iges"],"model/mesh":["msh","mesh","silo"],"model/mtl":["mtl"],"model/obj":["obj"],"model/step+xml":["stpx"],"model/step+zip":["stpz"],"model/step-xml+zip":["stpxz"],"model/stl":["stl"],"model/vrml":["wrl","vrml"],"model/x3d+binary":["*x3db","x3dbz"],"model/x3d+fastinfoset":["x3db"],"model/x3d+vrml":["*x3dv","x3dvz"],"model/x3d+xml":["x3d","x3dz"],"model/x3d-vrml":["x3dv"],"text/cache-manifest":["appcache","manifest"],"text/calendar":["ics","ifb"],"text/coffeescript":["coffee","litcoffee"],"text/css":["css"],"text/csv":["csv"],"text/html":["html","htm","shtml"],"text/jade":["jade"],"text/jsx":["jsx"],"text/less":["less"],"text/markdown":["markdown","md"],"text/mathml":["mml"],"text/mdx":["mdx"],"text/n3":["n3"],"text/plain":["txt","text","conf","def","list","log","in","ini"],"text/richtext":["rtx"],"text/rtf":["*rtf"],"text/sgml":["sgml","sgm"],"text/shex":["shex"],"text/slim":["slim","slm"],"text/spdx":["spdx"],"text/stylus":["stylus","styl"],"text/tab-separated-values":["tsv"],"text/troff":["t","tr","roff","man","me","ms"],"text/turtle":["ttl"],"text/uri-list":["uri","uris","urls"],"text/vcard":["vcard"],"text/vtt":["vtt"],"text/xml":["*xml"],"text/yaml":["yaml","yml"],"video/3gpp":["3gp","3gpp"],"video/3gpp2":["3g2"],"video/h261":["h261"],"video/h263":["h263"],"video/h264":["h264"],"video/iso.segment":["m4s"],"video/jpeg":["jpgv"],"video/jpm":["*jpm","jpgm"],"video/mj2":["mj2","mjp2"],"video/mp2t":["ts"],"video/mp4":["mp4","mp4v","mpg4"],"video/mpeg":["mpeg","mpg","mpe","m1v","m2v"],"video/ogg":["ogv"],"video/quicktime":["qt","mov"],"video/webm":["webm"]}}),Wt=F((f,a)=>{"use strict";var m=Rt();a.exports=new m(Bt())}),$e=F((f,a)=>{"use strict";function m(t){if(t.length===0)return;let s=Object.create(null),S=0;for(;S<t.length;++S){let g=t.charCodeAt(S);if(c[g]!==1){if(g!==47||S===0)return;break}}if(S===t.length)return;let u=t.slice(0,S).toLowerCase(),d=++S;for(;S<t.length;++S){let g=t.charCodeAt(S);if(c[g]!==1){if(S===d||l(t,S,s)===void 0)return;break}}if(S===d)return;let w=t.slice(d,S).toLowerCase();return{type:u,subtype:w,params:s}}function l(t,s,S){for(;s<t.length;){for(;s<t.length;++s){let n=t.charCodeAt(s);if(n!==32&&n!==9)break}if(s===t.length)break;if(t.charCodeAt(s++)!==59)return;for(;s<t.length;++s){let n=t.charCodeAt(s);if(n!==32&&n!==9)break}if(s===t.length)return;let u,d=s;for(;s<t.length;++s){let n=t.charCodeAt(s);if(c[n]!==1){if(n!==61)return;break}}if(s===t.length||(u=t.slice(d,s),++s,s===t.length))return;let w="",g;if(t.charCodeAt(s)===34){g=++s;let n=!1;for(;s<t.length;++s){let E=t.charCodeAt(s);if(E===92){n?(g=s,n=!1):(w+=t.slice(g,s),n=!0);continue}if(E===34){if(n){g=s,n=!1;continue}w+=t.slice(g,s);break}if(n&&(g=s-1,n=!1),o[E]!==1)return}if(s===t.length)return;++s}else{for(g=s;s<t.length;++s){let n=t.charCodeAt(s);if(c[n]!==1){if(s===g)return;break}}w=t.slice(g,s)}u=u.toLowerCase(),S[u]===void 0&&(S[u]=w)}return S}function x(t,s){if(t.length===0)return;let S=Object.create(null),u=0;for(;u<t.length;++u){let d=t.charCodeAt(u);if(c[d]!==1){if(y(t,u,S,s)===void 0)return;break}}return{type:t.slice(0,u).toLowerCase(),params:S}}function y(t,s,S,u){for(;s<t.length;){for(;s<t.length;++s){let b=t.charCodeAt(s);if(b!==32&&b!==9)break}if(s===t.length)break;if(t.charCodeAt(s++)!==59)return;for(;s<t.length;++s){let b=t.charCodeAt(s);if(b!==32&&b!==9)break}if(s===t.length)return;let d,w=s;for(;s<t.length;++s){let b=t.charCodeAt(s);if(c[b]!==1){if(b===61)break;return}}if(s===t.length)return;let g="",n,E;if(d=t.slice(w,s),d.charCodeAt(d.length-1)===42){let b=++s;for(;s<t.length;++s){let N=t.charCodeAt(s);if(p[N]!==1){if(N!==39)return;break}}if(s===t.length)return;for(E=t.slice(b,s),++s;s<t.length&&t.charCodeAt(s)!==39;++s);if(s===t.length||(++s,s===t.length))return;n=s;let I=0;for(;s<t.length;++s){let N=t.charCodeAt(s);if(k[N]!==1){if(N===37){let B,A;if(s+2<t.length&&(B=_[t.charCodeAt(s+1)])!==-1&&(A=_[t.charCodeAt(s+2)])!==-1){let P=(B<<4)+A;g+=t.slice(n,s),g+=String.fromCharCode(P),s+=2,n=s+1,P>=128?I=2:I===0&&(I=1);continue}return}break}}if(g+=t.slice(n,s),g=e(g,E,I),g===void 0)return}else{if(++s,s===t.length)return;if(t.charCodeAt(s)===34){n=++s;let b=!1;for(;s<t.length;++s){let I=t.charCodeAt(s);if(I===92){b?(n=s,b=!1):(g+=t.slice(n,s),b=!0);continue}if(I===34){if(b){n=s,b=!1;continue}g+=t.slice(n,s);break}if(b&&(n=s-1,b=!1),o[I]!==1)return}if(s===t.length)return;++s}else{for(n=s;s<t.length;++s){let b=t.charCodeAt(s);if(c[b]!==1){if(s===n)return;break}}g=t.slice(n,s)}if(g=u(g,2),g===void 0)return}d=d.toLowerCase(),S[d]===void 0&&(S[d]=g)}return S}function r(t){let s;for(;;)switch(t){case"utf-8":case"utf8":return h.utf8;case"latin1":case"ascii":case"us-ascii":case"iso-8859-1":case"iso8859-1":case"iso88591":case"iso_8859-1":case"windows-1252":case"iso_8859-1:1987":case"cp1252":case"x-cp1252":return h.latin1;case"utf16le":case"utf-16le":case"ucs2":case"ucs-2":return h.utf16le;case"base64":return h.base64;default:if(s===void 0){s=!0,t=t.toLowerCase();continue}return h.other.bind(t)}}var h={utf8:(t,s)=>{if(t.length===0)return"";if(typeof t=="string"){if(s<2)return t;t=Buffer.from(t,"latin1")}return t.utf8Slice(0,t.length)},latin1:(t,s)=>t.length===0?"":typeof t=="string"?t:t.latin1Slice(0,t.length),utf16le:(t,s)=>t.length===0?"":(typeof t=="string"&&(t=Buffer.from(t,"latin1")),t.ucs2Slice(0,t.length)),base64:(t,s)=>t.length===0?"":(typeof t=="string"&&(t=Buffer.from(t,"latin1")),t.base64Slice(0,t.length)),other:(t,s)=>{if(t.length===0)return"";typeof t=="string"&&(t=Buffer.from(t,"latin1"));try{return new TextDecoder(f).decode(t)}catch{}}};function e(t,s,S){let u=r(s);if(u)return u(t,S)}function i(t){if(typeof t!="string")return"";for(let s=t.length-1;s>=0;--s)switch(t.charCodeAt(s)){case 47:case 92:return t=t.slice(s+1),t===".."||t==="."?"":t}return t===".."||t==="."?"":t}var c=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,1,1,1,1,1,0,0,1,1,0,1,1,0,1,1,1,1,1,1,1,1,1,1,0,0,0,0,0,0,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,0,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,1,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],o=[0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],p=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,1,1,1,1,0,0,0,0,1,0,1,0,0,1,1,1,1,1,1,1,1,1,1,0,0,0,0,0,0,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,0,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],k=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,1,1,0,1,0,0,0,0,1,0,1,1,0,1,1,1,1,1,1,1,1,1,1,0,0,0,0,0,0,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,0,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,1,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],_=[-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,0,1,2,3,4,5,6,7,8,9,-1,-1,-1,-1,-1,-1,-1,10,11,12,13,14,15,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,10,11,12,13,14,15,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1];a.exports={basename:i,convertToUTF8:e,getDecoder:r,parseContentType:m,parseDisposition:x}}),Dt=F((f,a)=>{"use strict";function m(r,h,e,i,c){for(let o=0;o<c;++o)if(r[h+o]!==e[i+o])return!1;return!0}var l=class{constructor(r,h){if(typeof h!="function")throw new Error("Missing match callback");if(typeof r=="string")r=Buffer.from(r);else if(!Buffer.isBuffer(r))throw new Error(`Expected Buffer for needle, got ${typeof r}`);let e=r.length;if(this.maxMatches=1/0,this.matches=0,this._cb=h,this._lookbehindSize=0,this._needle=r,this._bufPos=0,this._lookbehind=Buffer.allocUnsafe(e),this._occ=[e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e],e>1)for(let i=0;i<e-1;++i)this._occ[r[i]]=e-1-i}reset(){this.matches=0,this._lookbehindSize=0,this._bufPos=0}push(r,h){let e;Buffer.isBuffer(r)||(r=Buffer.from(r,"latin1"));let i=r.length;for(this._bufPos=h||0;e!==i&&this.matches<this.maxMatches;)e=x(this,r);return e}destroy(){let r=this._lookbehindSize;r&&this._cb(!1,this._lookbehind,0,r,!1),this.reset()}};function x(r,h){let e=h.length,i=r._needle,c=i.length,o=-r._lookbehindSize,p=c-1,k=i[p],_=e-c,t=r._occ,s=r._lookbehind;if(o<0){for(;o<0&&o<=_;){let u=o+p,d=u<0?s[r._lookbehindSize+u]:h[u];if(d===k&&y(r,h,o,p))return r._lookbehindSize=0,++r.matches,o>-r._lookbehindSize?r._cb(!0,s,0,r._lookbehindSize+o,!1):r._cb(!0,void 0,0,0,!0),r._bufPos=o+c;o+=t[d]}for(;o<0&&!y(r,h,o,e-o);)++o;if(o<0){let u=r._lookbehindSize+o;return u>0&&r._cb(!1,s,0,u,!1),r._lookbehindSize-=u,s.copy(s,0,u,r._lookbehindSize),s.set(h,r._lookbehindSize),r._lookbehindSize+=e,r._bufPos=e,e}r._cb(!1,s,0,r._lookbehindSize,!1),r._lookbehindSize=0}o+=r._bufPos;let S=i[0];for(;o<=_;){let u=h[o+p];if(u===k&&h[o]===S&&m(i,0,h,o,p))return++r.matches,o>0?r._cb(!0,h,r._bufPos,o,!0):r._cb(!0,void 0,0,0,!0),r._bufPos=o+c;o+=t[u]}for(;o<e;){if(h[o]!==S||!m(h,o,i,0,e-o)){++o;continue}h.copy(s,0,o,e),r._lookbehindSize=e-o;break}return o>0&&r._cb(!1,h,r._bufPos,o<e?o:e,!0),r._bufPos=e,e}function y(r,h,e,i){let c=r._lookbehind,o=r._lookbehindSize,p=r._needle;for(let k=0;k<i;++k,++e)if((e<0?c[o+e]:h[e])!==p[k])return!1;return!0}a.exports=l}),qt=F((f,a)=>{"use strict";var{Readable:m,Writable:l}=require("stream"),x=Dt(),{basename:y,convertToUTF8:r,getDecoder:h,parseContentType:e,parseDisposition:i}=$e(),c=Buffer.from(`\r
`),o=Buffer.from("\r"),p=Buffer.from("-");function k(){}var _=2e3,t=16*1024,s=0,S=1,u=2,d=class{constructor(P){this.header=Object.create(null),this.pairCount=0,this.byteCount=0,this.state=s,this.name="",this.value="",this.crlf=0,this.cb=P}reset(){this.header=Object.create(null),this.pairCount=0,this.byteCount=0,this.state=s,this.name="",this.value="",this.crlf=0}push(P,T,R){let U=T;for(;T<R;)switch(this.state){case s:{let D=!1;for(;T<R;++T){if(this.byteCount===t)return-1;++this.byteCount;let V=P[T];if(B[V]!==1){if(V!==58||(this.name+=P.latin1Slice(U,T),this.name.length===0))return-1;++T,D=!0,this.state=S;break}}if(!D){this.name+=P.latin1Slice(U,T);break}}case S:{let D=!1;for(;T<R;++T){if(this.byteCount===t)return-1;++this.byteCount;let V=P[T];if(V!==32&&V!==9){U=T,D=!0,this.state=u;break}}if(!D)break}case u:switch(this.crlf){case 0:for(;T<R;++T){if(this.byteCount===t)return-1;++this.byteCount;let D=P[T];if(A[D]!==1){if(D!==13)return-1;++this.crlf;break}}this.value+=P.latin1Slice(U,T++);break;case 1:if(this.byteCount===t||(++this.byteCount,P[T++]!==10))return-1;++this.crlf;break;case 2:{if(this.byteCount===t)return-1;++this.byteCount;let D=P[T];D===32||D===9?(U=T,this.crlf=0):(++this.pairCount<_&&(this.name=this.name.toLowerCase(),this.header[this.name]===void 0?this.header[this.name]=[this.value]:this.header[this.name].push(this.value)),D===13?(++this.crlf,++T):(U=T,this.crlf=0,this.state=s,this.name="",this.value=""));break}case 3:{if(this.byteCount===t||(++this.byteCount,P[T++]!==10))return-1;let D=this.header;return this.reset(),this.cb(D),T}}break}return T}},w=class extends m{constructor(P,T){super(P),this.truncated=!1,this._readcb=null,this.once("end",()=>{if(this._read(),--T._fileEndsLeft===0&&T._finalcb){let R=T._finalcb;T._finalcb=null,process.nextTick(R)}})}_read(P){let T=this._readcb;T&&(this._readcb=null,T())}},g={push:(P,T)=>{},destroy:()=>{}};function n(P,T){let R=P._writecb;P._writecb=null,T?P.destroy(T):R&&R()}function E(P,T){return P}var b=class extends l{constructor(P){let T={autoDestroy:!0,emitClose:!0,highWaterMark:typeof P.highWaterMark=="number"?P.highWaterMark:void 0};if(super(T),!P.conType.params||typeof P.conType.params.boundary!="string")throw new Error("Multipart: Boundary not found");let R=P.conType.params.boundary,U=typeof P.defParamCharset=="string"&&P.defParamCharset?h(P.defParamCharset):E,D=P.defCharset||"utf8",V=P.preservePath,le={autoDestroy:!0,emitClose:!0,highWaterMark:typeof P.fileHwm=="number"?P.fileHwm:void 0},H=P.limits,Y=H&&typeof H.fieldSize=="number"?H.fieldSize:1*1024*1024,ce=H&&typeof H.fileSize=="number"?H.fileSize:1/0,Ne=H&&typeof H.files=="number"?H.files:1/0,Ue=H&&typeof H.fields=="number"?H.fields:1/0,we=H&&typeof H.parts=="number"?H.parts:1/0,ve=-1,Se=0,ke=0,te=!1;this._fileEndsLeft=0,this._fileStream=void 0,this._complete=!1;let pe=0,se,oe=0,de,fe,v,C,L=!1,j=!1,O=!1;this._hparser=null;let $=new d(Q=>{this._hparser=null,te=!1,v="text/plain",de=D,fe="7bit",C=void 0,L=!1;let K;if(!Q["content-disposition"]){te=!0;return}let M=i(Q["content-disposition"][0],U);if(!M||M.type!=="form-data"){te=!0;return}if(M.params&&(M.params.name&&(C=M.params.name),M.params["filename*"]?K=M.params["filename*"]:M.params.filename&&(K=M.params.filename),K!==void 0&&!V&&(K=y(K))),Q["content-type"]){let Z=e(Q["content-type"][0]);Z&&(v=`${Z.type}/${Z.subtype}`,Z.params&&typeof Z.params.charset=="string"&&(de=Z.params.charset.toLowerCase()))}if(Q["content-transfer-encoding"]&&(fe=Q["content-transfer-encoding"][0].toLowerCase()),v==="application/octet-stream"||K!==void 0){if(ke===Ne){j||(j=!0,this.emit("filesLimit")),te=!0;return}if(++ke,this.listenerCount("file")===0){te=!0;return}pe=0,this._fileStream=new w(le,this),++this._fileEndsLeft,this.emit("file",C,this._fileStream,{filename:K,encoding:fe,mimeType:v})}else{if(Se===Ue){O||(O=!0,this.emit("fieldsLimit")),te=!0;return}if(++Se,this.listenerCount("field")===0){te=!0;return}se=[],oe=0}}),J=0,ae=(Q,K,M,Z,he)=>{e:for(;K;){if(this._hparser!==null){let W=this._hparser.push(K,M,Z);if(W===-1){this._hparser=null,$.reset(),this.emit("error",new Error("Malformed part header"));break}M=W}if(M===Z)break;if(J!==0){if(J===1){switch(K[M]){case 45:J=2,++M;break;case 13:J=3,++M;break;default:J=0}if(M===Z)return}if(J===2){if(J=0,K[M]===45){this._complete=!0,this._bparser=g;return}let W=this._writecb;this._writecb=k,ae(!1,p,0,1,!1),this._writecb=W}else if(J===3)if(J=0,K[M]===10){if(++M,ve>=we||(this._hparser=$,M===Z))break;continue e}else{let W=this._writecb;this._writecb=k,ae(!1,o,0,1,!1),this._writecb=W}}if(!te){if(this._fileStream){let W,z=Math.min(Z-M,ce-pe);he?W=K.slice(M,M+z):(W=Buffer.allocUnsafe(z),K.copy(W,0,M,M+z)),pe+=W.length,pe===ce?(W.length>0&&this._fileStream.push(W),this._fileStream.emit("limit"),this._fileStream.truncated=!0,te=!0):this._fileStream.push(W)||(this._writecb&&(this._fileStream._readcb=this._writecb),this._writecb=null)}else if(se!==void 0){let W,z=Math.min(Z-M,Y-oe);he?W=K.slice(M,M+z):(W=Buffer.allocUnsafe(z),K.copy(W,0,M,M+z)),oe+=z,se.push(W),oe===Y&&(te=!0,L=!0)}}break}if(Q){if(J=1,this._fileStream)this._fileStream.push(null),this._fileStream=null;else if(se!==void 0){let W;switch(se.length){case 0:W="";break;case 1:W=r(se[0],de,0);break;default:W=r(Buffer.concat(se,oe),de,0)}se=void 0,oe=0,this.emit("field",C,W,{nameTruncated:!1,valueTruncated:L,encoding:fe,mimeType:v})}++ve===we&&this.emit("partsLimit")}};this._bparser=new x(`\r
--${R}`,ae),this._writecb=null,this._finalcb=null,this.write(c)}static detect(P){return P.type==="multipart"&&P.subtype==="form-data"}_write(P,T,R){this._writecb=R,this._bparser.push(P,0),this._writecb&&n(this)}_destroy(P,T){this._hparser=null,this._bparser=g,P||(P=N(this));let R=this._fileStream;R&&(this._fileStream=null,R.destroy(P)),T(P)}_final(P){if(this._bparser.destroy(),!this._complete)return P(new Error("Unexpected end of form"));this._fileEndsLeft?this._finalcb=I.bind(null,this,P):I(this,P)}};function I(P,T,R){if(R)return T(R);R=N(P),T(R)}function N(P){if(P._hparser)return new Error("Malformed part header");let T=P._fileStream;if(T&&(P._fileStream=null,T.destroy(new Error("Unexpected end of file"))),!P._complete)return new Error("Unexpected end of form")}var B=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,1,1,1,1,1,0,0,1,1,0,1,1,0,1,1,1,1,1,1,1,1,1,1,0,0,0,0,0,0,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,0,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,1,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],A=[0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1];a.exports=b}),zt=F((f,a)=>{"use strict";var{Writable:m}=require("stream"),{getDecoder:l}=$e(),x=class extends m{constructor(i){let c={autoDestroy:!0,emitClose:!0,highWaterMark:typeof i.highWaterMark=="number"?i.highWaterMark:void 0};super(c);let o=i.defCharset||"utf8";i.conType.params&&typeof i.conType.params.charset=="string"&&(o=i.conType.params.charset),this.charset=o;let p=i.limits;this.fieldSizeLimit=p&&typeof p.fieldSize=="number"?p.fieldSize:1*1024*1024,this.fieldsLimit=p&&typeof p.fields=="number"?p.fields:1/0,this.fieldNameSizeLimit=p&&typeof p.fieldNameSize=="number"?p.fieldNameSize:100,this._inKey=!0,this._keyTrunc=!1,this._valTrunc=!1,this._bytesKey=0,this._bytesVal=0,this._fields=0,this._key="",this._val="",this._byte=-2,this._lastPos=0,this._encode=0,this._decoder=l(o)}static detect(i){return i.type==="application"&&i.subtype==="x-www-form-urlencoded"}_write(i,c,o){if(this._fields>=this.fieldsLimit)return o();let p=0,k=i.length;if(this._lastPos=0,this._byte!==-2){if(p=y(this,i,p,k),p===-1)return o(new Error("Malformed urlencoded form"));if(p>=k)return o();this._inKey?++this._bytesKey:++this._bytesVal}e:for(;p<k;)if(this._inKey){for(p=r(this,i,p,k);p<k;){switch(i[p]){case 61:this._lastPos<p&&(this._key+=i.latin1Slice(this._lastPos,p)),this._lastPos=++p,this._key=this._decoder(this._key,this._encode),this._encode=0,this._inKey=!1;continue e;case 38:if(this._lastPos<p&&(this._key+=i.latin1Slice(this._lastPos,p)),this._lastPos=++p,this._key=this._decoder(this._key,this._encode),this._encode=0,this._bytesKey>0&&this.emit("field",this._key,"",{nameTruncated:this._keyTrunc,valueTruncated:!1,encoding:this.charset,mimeType:"text/plain"}),this._key="",this._val="",this._keyTrunc=!1,this._valTrunc=!1,this._bytesKey=0,this._bytesVal=0,++this._fields>=this.fieldsLimit)return this.emit("fieldsLimit"),o();continue;case 43:this._lastPos<p&&(this._key+=i.latin1Slice(this._lastPos,p)),this._key+=" ",this._lastPos=p+1;break;case 37:if(this._encode===0&&(this._encode=1),this._lastPos<p&&(this._key+=i.latin1Slice(this._lastPos,p)),this._lastPos=p+1,this._byte=-1,p=y(this,i,p+1,k),p===-1)return o(new Error("Malformed urlencoded form"));if(p>=k)return o();++this._bytesKey,p=r(this,i,p,k);continue}++p,++this._bytesKey,p=r(this,i,p,k)}this._lastPos<p&&(this._key+=i.latin1Slice(this._lastPos,p))}else{for(p=h(this,i,p,k);p<k;){switch(i[p]){case 38:if(this._lastPos<p&&(this._val+=i.latin1Slice(this._lastPos,p)),this._lastPos=++p,this._inKey=!0,this._val=this._decoder(this._val,this._encode),this._encode=0,(this._bytesKey>0||this._bytesVal>0)&&this.emit("field",this._key,this._val,{nameTruncated:this._keyTrunc,valueTruncated:this._valTrunc,encoding:this.charset,mimeType:"text/plain"}),this._key="",this._val="",this._keyTrunc=!1,this._valTrunc=!1,this._bytesKey=0,this._bytesVal=0,++this._fields>=this.fieldsLimit)return this.emit("fieldsLimit"),o();continue e;case 43:this._lastPos<p&&(this._val+=i.latin1Slice(this._lastPos,p)),this._val+=" ",this._lastPos=p+1;break;case 37:if(this._encode===0&&(this._encode=1),this._lastPos<p&&(this._val+=i.latin1Slice(this._lastPos,p)),this._lastPos=p+1,this._byte=-1,p=y(this,i,p+1,k),p===-1)return o(new Error("Malformed urlencoded form"));if(p>=k)return o();++this._bytesVal,p=h(this,i,p,k);continue}++p,++this._bytesVal,p=h(this,i,p,k)}this._lastPos<p&&(this._val+=i.latin1Slice(this._lastPos,p))}o()}_final(i){if(this._byte!==-2)return i(new Error("Malformed urlencoded form"));(!this._inKey||this._bytesKey>0||this._bytesVal>0)&&(this._inKey?this._key=this._decoder(this._key,this._encode):this._val=this._decoder(this._val,this._encode),this.emit("field",this._key,this._val,{nameTruncated:this._keyTrunc,valueTruncated:this._valTrunc,encoding:this.charset,mimeType:"text/plain"})),i()}};function y(i,c,o,p){if(o>=p)return p;if(i._byte===-1){let k=e[c[o++]];if(k===-1)return-1;if(k>=8&&(i._encode=2),o<p){let _=e[c[o++]];if(_===-1)return-1;i._inKey?i._key+=String.fromCharCode((k<<4)+_):i._val+=String.fromCharCode((k<<4)+_),i._byte=-2,i._lastPos=o}else i._byte=k}else{let k=e[c[o++]];if(k===-1)return-1;i._inKey?i._key+=String.fromCharCode((i._byte<<4)+k):i._val+=String.fromCharCode((i._byte<<4)+k),i._byte=-2,i._lastPos=o}return o}function r(i,c,o,p){if(i._bytesKey>i.fieldNameSizeLimit){for(i._keyTrunc||i._lastPos<o&&(i._key+=c.latin1Slice(i._lastPos,o-1)),i._keyTrunc=!0;o<p;++o){let k=c[o];if(k===61||k===38)break;++i._bytesKey}i._lastPos=o}return o}function h(i,c,o,p){if(i._bytesVal>i.fieldSizeLimit){for(i._valTrunc||i._lastPos<o&&(i._val+=c.latin1Slice(i._lastPos,o-1)),i._valTrunc=!0;o<p&&c[o]!==38;++o)++i._bytesVal;i._lastPos=o}return o}var e=[-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,0,1,2,3,4,5,6,7,8,9,-1,-1,-1,-1,-1,-1,-1,10,11,12,13,14,15,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,10,11,12,13,14,15,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1];a.exports=x}),Ft=F((f,a)=>{"use strict";var{parseContentType:m}=$e();function l(y){let r=y.headers,h=m(r["content-type"]);if(!h)throw new Error("Malformed content type");for(let e of x){if(!e.detect(h))continue;let i={limits:y.limits,headers:r,conType:h,highWaterMark:void 0,fileHwm:void 0,defCharset:void 0,defParamCharset:void 0,preservePath:!1};return y.highWaterMark&&(i.highWaterMark=y.highWaterMark),y.fileHwm&&(i.fileHwm=y.fileHwm),i.defCharset=y.defCharset,i.defParamCharset=y.defParamCharset,i.preservePath=y.preservePath,new e(i)}throw new Error(`Unsupported content type: ${r["content-type"]}`)}var x=[qt(),zt()].filter(function(y){return typeof y.detect=="function"});a.exports=y=>{if((typeof y!="object"||y===null)&&(y={}),typeof y.headers!="object"||y.headers===null||typeof y.headers["content-type"]!="string")throw new Error("Missing Content-Type");return l(y)}}),$t=F((f,a)=>{"use strict";var{Duplex:m}=require("stream");function l(h){h.emit("close")}function x(){!this.destroyed&&this._writableState.finished&&this.destroy()}function y(h){this.removeListener("error",y),this.destroy(),this.listenerCount("error")===0&&this.emit("error",h)}function r(h,e){let i=!0,c=new m({...e,autoDestroy:!1,emitClose:!1,objectMode:!1,writableObjectMode:!1});return h.on("message",function(o,p){let k=!p&&c._readableState.objectMode?o.toString():o;c.push(k)||h.pause()}),h.once("error",function(o){c.destroyed||(i=!1,c.destroy(o))}),h.once("close",function(){c.destroyed||c.push(null)}),c._destroy=function(o,p){if(h.readyState===h.CLOSED){p(o),process.nextTick(l,c);return}let k=!1;h.once("error",function(_){k=!0,p(_)}),h.once("close",function(){k||p(o),process.nextTick(l,c)}),i&&h.terminate()},c._final=function(o){if(h.readyState===h.CONNECTING){h.once("open",function(){c._final(o)});return}h._socket!==null&&(h._socket._writableState.finished?(o(),c._readableState.endEmitted&&c.destroy()):(h._socket.once("finish",function(){o()}),h.close()))},c._read=function(){h.isPaused&&h.resume()},c._write=function(o,p,k){if(h.readyState===h.CONNECTING){h.once("open",function(){c._write(o,p,k)});return}h.send(o,k)},c.on("end",x),c.on("error",y),c}a.exports=r}),ye=F((f,a)=>{"use strict";a.exports={BINARY_TYPES:["nodebuffer","arraybuffer","fragments"],EMPTY_BUFFER:Buffer.alloc(0),GUID:"258EAFA5-E914-47DA-95CA-C5AB0DC85B11",kForOnEventAttribute:Symbol("kIsForOnEventAttribute"),kListener:Symbol("kListener"),kStatusCode:Symbol("status-code"),kWebSocket:Symbol("websocket"),NOOP:()=>{}}}),Le=F((f,a)=>{"use strict";var{EMPTY_BUFFER:m}=ye(),l=Buffer[Symbol.species];function x(i,c){if(i.length===0)return m;if(i.length===1)return i[0];let o=Buffer.allocUnsafe(c),p=0;for(let k=0;k<i.length;k++){let _=i[k];o.set(_,p),p+=_.length}return p<c?new l(o.buffer,o.byteOffset,p):o}function y(i,c,o,p,k){for(let _=0;_<k;_++)o[p+_]=i[_]^c[_&3]}function r(i,c){for(let o=0;o<i.length;o++)i[o]^=c[o&3]}function h(i){return i.length===i.buffer.byteLength?i.buffer:i.buffer.slice(i.byteOffset,i.byteOffset+i.length)}function e(i){if(e.readOnly=!0,Buffer.isBuffer(i))return i;let c;return i instanceof ArrayBuffer?c=new l(i):ArrayBuffer.isView(i)?c=new l(i.buffer,i.byteOffset,i.byteLength):(c=Buffer.from(i),e.readOnly=!1),c}if(a.exports={concat:x,mask:y,toArrayBuffer:h,toBuffer:e,unmask:r},!process.env.WS_NO_BUFFER_UTIL)try{let i=require("bufferutil");a.exports.mask=function(c,o,p,k,_){_<48?y(c,o,p,k,_):i.mask(c,o,p,k,_)},a.exports.unmask=function(c,o){c.length<32?r(c,o):i.unmask(c,o)}}catch{}}),Gt=F((f,a)=>{"use strict";var m=Symbol("kDone"),l=Symbol("kRun"),x=class{constructor(y){this[m]=()=>{this.pending--,this[l]()},this.concurrency=y||1/0,this.jobs=[],this.pending=0}add(y){this.jobs.push(y),this[l]()}[l](){if(this.pending!==this.concurrency&&this.jobs.length){let y=this.jobs.shift();this.pending++,y(this[m])}}};a.exports=x}),Ie=F((f,a)=>{"use strict";var m=require("zlib"),l=Le(),x=Gt(),{kStatusCode:y}=ye(),r=Buffer[Symbol.species],h=Buffer.from([0,0,255,255]),e=Symbol("permessage-deflate"),i=Symbol("total-length"),c=Symbol("callback"),o=Symbol("buffers"),p=Symbol("error"),k,_=class{constructor(u,d,w){if(this._maxPayload=w|0,this._options=u||{},this._threshold=this._options.threshold!==void 0?this._options.threshold:1024,this._isServer=!!d,this._deflate=null,this._inflate=null,this.params=null,!k){let g=this._options.concurrencyLimit!==void 0?this._options.concurrencyLimit:10;k=new x(g)}}static get extensionName(){return"permessage-deflate"}offer(){let u={};return this._options.serverNoContextTakeover&&(u.server_no_context_takeover=!0),this._options.clientNoContextTakeover&&(u.client_no_context_takeover=!0),this._options.serverMaxWindowBits&&(u.server_max_window_bits=this._options.serverMaxWindowBits),this._options.clientMaxWindowBits?u.client_max_window_bits=this._options.clientMaxWindowBits:this._options.clientMaxWindowBits==null&&(u.client_max_window_bits=!0),u}accept(u){return u=this.normalizeParams(u),this.params=this._isServer?this.acceptAsServer(u):this.acceptAsClient(u),this.params}cleanup(){if(this._inflate&&(this._inflate.close(),this._inflate=null),this._deflate){let u=this._deflate[c];this._deflate.close(),this._deflate=null,u&&u(new Error("The deflate stream was closed while data was being processed"))}}acceptAsServer(u){let d=this._options,w=u.find(g=>!(d.serverNoContextTakeover===!1&&g.server_no_context_takeover||g.server_max_window_bits&&(d.serverMaxWindowBits===!1||typeof d.serverMaxWindowBits=="number"&&d.serverMaxWindowBits>g.server_max_window_bits)||typeof d.clientMaxWindowBits=="number"&&!g.client_max_window_bits));if(!w)throw new Error("None of the extension offers can be accepted");return d.serverNoContextTakeover&&(w.server_no_context_takeover=!0),d.clientNoContextTakeover&&(w.client_no_context_takeover=!0),typeof d.serverMaxWindowBits=="number"&&(w.server_max_window_bits=d.serverMaxWindowBits),typeof d.clientMaxWindowBits=="number"?w.client_max_window_bits=d.clientMaxWindowBits:(w.client_max_window_bits===!0||d.clientMaxWindowBits===!1)&&delete w.client_max_window_bits,w}acceptAsClient(u){let d=u[0];if(this._options.clientNoContextTakeover===!1&&d.client_no_context_takeover)throw new Error('Unexpected parameter "client_no_context_takeover"');if(!d.client_max_window_bits)typeof this._options.clientMaxWindowBits=="number"&&(d.client_max_window_bits=this._options.clientMaxWindowBits);else if(this._options.clientMaxWindowBits===!1||typeof this._options.clientMaxWindowBits=="number"&&d.client_max_window_bits>this._options.clientMaxWindowBits)throw new Error('Unexpected or invalid parameter "client_max_window_bits"');return d}normalizeParams(u){return u.forEach(d=>{Object.keys(d).forEach(w=>{let g=d[w];if(g.length>1)throw new Error(`Parameter "${w}" must have only a single value`);if(g=g[0],w==="client_max_window_bits"){if(g!==!0){let n=+g;if(!Number.isInteger(n)||n<8||n>15)throw new TypeError(`Invalid value for parameter "${w}": ${g}`);g=n}else if(!this._isServer)throw new TypeError(`Invalid value for parameter "${w}": ${g}`)}else if(w==="server_max_window_bits"){let n=+g;if(!Number.isInteger(n)||n<8||n>15)throw new TypeError(`Invalid value for parameter "${w}": ${g}`);g=n}else if(w==="client_no_context_takeover"||w==="server_no_context_takeover"){if(g!==!0)throw new TypeError(`Invalid value for parameter "${w}": ${g}`)}else throw new Error(`Unknown parameter "${w}"`);d[w]=g})}),u}decompress(u,d,w){k.add(g=>{this._decompress(u,d,(n,E)=>{g(),w(n,E)})})}compress(u,d,w){k.add(g=>{this._compress(u,d,(n,E)=>{g(),w(n,E)})})}_decompress(u,d,w){let g=this._isServer?"client":"server";if(!this._inflate){let n=`${g}_max_window_bits`,E=typeof this.params[n]!="number"?m.Z_DEFAULT_WINDOWBITS:this.params[n];this._inflate=m.createInflateRaw({...this._options.zlibInflateOptions,windowBits:E}),this._inflate[e]=this,this._inflate[i]=0,this._inflate[o]=[],this._inflate.on("error",S),this._inflate.on("data",s)}this._inflate[c]=w,this._inflate.write(u),d&&this._inflate.write(h),this._inflate.flush(()=>{let n=this._inflate[p];if(n){this._inflate.close(),this._inflate=null,w(n);return}let E=l.concat(this._inflate[o],this._inflate[i]);this._inflate._readableState.endEmitted?(this._inflate.close(),this._inflate=null):(this._inflate[i]=0,this._inflate[o]=[],d&&this.params[`${g}_no_context_takeover`]&&this._inflate.reset()),w(null,E)})}_compress(u,d,w){let g=this._isServer?"server":"client";if(!this._deflate){let n=`${g}_max_window_bits`,E=typeof this.params[n]!="number"?m.Z_DEFAULT_WINDOWBITS:this.params[n];this._deflate=m.createDeflateRaw({...this._options.zlibDeflateOptions,windowBits:E}),this._deflate[i]=0,this._deflate[o]=[],this._deflate.on("data",t)}this._deflate[c]=w,this._deflate.write(u),this._deflate.flush(m.Z_SYNC_FLUSH,()=>{if(!this._deflate)return;let n=l.concat(this._deflate[o],this._deflate[i]);d&&(n=new r(n.buffer,n.byteOffset,n.length-4)),this._deflate[c]=null,this._deflate[i]=0,this._deflate[o]=[],d&&this.params[`${g}_no_context_takeover`]&&this._deflate.reset(),w(null,n)})}};a.exports=_;function t(u){this[o].push(u),this[i]+=u.length}function s(u){if(this[i]+=u.length,this[e]._maxPayload<1||this[i]<=this[e]._maxPayload){this[o].push(u);return}this[p]=new RangeError("Max payload size exceeded"),this[p].code="WS_ERR_UNSUPPORTED_MESSAGE_LENGTH",this[p][y]=1009,this.removeListener("data",s),this.reset()}function S(u){this[e]._inflate=null,u[y]=1007,this[c](u)}}),je=F((f,a)=>{"use strict";var{isUtf8:m}=require("buffer"),l=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,1,1,1,1,1,0,0,1,1,0,1,1,0,1,1,1,1,1,1,1,1,1,1,0,0,0,0,0,0,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,0,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,1,0,1,0];function x(r){return r>=1e3&&r<=1014&&r!==1004&&r!==1005&&r!==1006||r>=3e3&&r<=4999}function y(r){let h=r.length,e=0;for(;e<h;)if(!(r[e]&128))e++;else if((r[e]&224)===192){if(e+1===h||(r[e+1]&192)!==128||(r[e]&254)===192)return!1;e+=2}else if((r[e]&240)===224){if(e+2>=h||(r[e+1]&192)!==128||(r[e+2]&192)!==128||r[e]===224&&(r[e+1]&224)===128||r[e]===237&&(r[e+1]&224)===160)return!1;e+=3}else if((r[e]&248)===240){if(e+3>=h||(r[e+1]&192)!==128||(r[e+2]&192)!==128||(r[e+3]&192)!==128||r[e]===240&&(r[e+1]&240)===128||r[e]===244&&r[e+1]>143||r[e]>244)return!1;e+=4}else return!1;return!0}if(a.exports={isValidStatusCode:x,isValidUTF8:y,tokenChars:l},m)a.exports.isValidUTF8=function(r){return r.length<24?y(r):m(r)};else if(!process.env.WS_NO_UTF_8_VALIDATE)try{let r=require("utf-8-validate");a.exports.isValidUTF8=function(h){return h.length<32?y(h):r(h)}}catch{}}),rt=F((f,a)=>{"use strict";var{Writable:m}=require("stream"),l=Ie(),{BINARY_TYPES:x,EMPTY_BUFFER:y,kStatusCode:r,kWebSocket:h}=ye(),{concat:e,toArrayBuffer:i,unmask:c}=Le(),{isValidStatusCode:o,isValidUTF8:p}=je(),k=Buffer[Symbol.species],_=0,t=1,s=2,S=3,u=4,d=5,w=class extends m{constructor(n={}){super(),this._binaryType=n.binaryType||x[0],this._extensions=n.extensions||{},this._isServer=!!n.isServer,this._maxPayload=n.maxPayload|0,this._skipUTF8Validation=!!n.skipUTF8Validation,this[h]=void 0,this._bufferedBytes=0,this._buffers=[],this._compressed=!1,this._payloadLength=0,this._mask=void 0,this._fragmented=0,this._masked=!1,this._fin=!1,this._opcode=0,this._totalPayloadLength=0,this._messageLength=0,this._fragments=[],this._state=_,this._loop=!1}_write(n,E,b){if(this._opcode===8&&this._state==_)return b();this._bufferedBytes+=n.length,this._buffers.push(n),this.startLoop(b)}consume(n){if(this._bufferedBytes-=n,n===this._buffers[0].length)return this._buffers.shift();if(n<this._buffers[0].length){let b=this._buffers[0];return this._buffers[0]=new k(b.buffer,b.byteOffset+n,b.length-n),new k(b.buffer,b.byteOffset,n)}let E=Buffer.allocUnsafe(n);do{let b=this._buffers[0],I=E.length-n;n>=b.length?E.set(this._buffers.shift(),I):(E.set(new Uint8Array(b.buffer,b.byteOffset,n),I),this._buffers[0]=new k(b.buffer,b.byteOffset+n,b.length-n)),n-=b.length}while(n>0);return E}startLoop(n){let E;this._loop=!0;do switch(this._state){case _:E=this.getInfo();break;case t:E=this.getPayloadLength16();break;case s:E=this.getPayloadLength64();break;case S:this.getMask();break;case u:E=this.getData(n);break;default:this._loop=!1;return}while(this._loop);n(E)}getInfo(){if(this._bufferedBytes<2){this._loop=!1;return}let n=this.consume(2);if(n[0]&48)return this._loop=!1,g(RangeError,"RSV2 and RSV3 must be clear",!0,1002,"WS_ERR_UNEXPECTED_RSV_2_3");let E=(n[0]&64)===64;if(E&&!this._extensions[l.extensionName])return this._loop=!1,g(RangeError,"RSV1 must be clear",!0,1002,"WS_ERR_UNEXPECTED_RSV_1");if(this._fin=(n[0]&128)===128,this._opcode=n[0]&15,this._payloadLength=n[1]&127,this._opcode===0){if(E)return this._loop=!1,g(RangeError,"RSV1 must be clear",!0,1002,"WS_ERR_UNEXPECTED_RSV_1");if(!this._fragmented)return this._loop=!1,g(RangeError,"invalid opcode 0",!0,1002,"WS_ERR_INVALID_OPCODE");this._opcode=this._fragmented}else if(this._opcode===1||this._opcode===2){if(this._fragmented)return this._loop=!1,g(RangeError,`invalid opcode ${this._opcode}`,!0,1002,"WS_ERR_INVALID_OPCODE");this._compressed=E}else if(this._opcode>7&&this._opcode<11){if(!this._fin)return this._loop=!1,g(RangeError,"FIN must be set",!0,1002,"WS_ERR_EXPECTED_FIN");if(E)return this._loop=!1,g(RangeError,"RSV1 must be clear",!0,1002,"WS_ERR_UNEXPECTED_RSV_1");if(this._payloadLength>125||this._opcode===8&&this._payloadLength===1)return this._loop=!1,g(RangeError,`invalid payload length ${this._payloadLength}`,!0,1002,"WS_ERR_INVALID_CONTROL_PAYLOAD_LENGTH")}else return this._loop=!1,g(RangeError,`invalid opcode ${this._opcode}`,!0,1002,"WS_ERR_INVALID_OPCODE");if(!this._fin&&!this._fragmented&&(this._fragmented=this._opcode),this._masked=(n[1]&128)===128,this._isServer){if(!this._masked)return this._loop=!1,g(RangeError,"MASK must be set",!0,1002,"WS_ERR_EXPECTED_MASK")}else if(this._masked)return this._loop=!1,g(RangeError,"MASK must be clear",!0,1002,"WS_ERR_UNEXPECTED_MASK");if(this._payloadLength===126)this._state=t;else if(this._payloadLength===127)this._state=s;else return this.haveLength()}getPayloadLength16(){if(this._bufferedBytes<2){this._loop=!1;return}return this._payloadLength=this.consume(2).readUInt16BE(0),this.haveLength()}getPayloadLength64(){if(this._bufferedBytes<8){this._loop=!1;return}let n=this.consume(8),E=n.readUInt32BE(0);return E>Math.pow(2,53-32)-1?(this._loop=!1,g(RangeError,"Unsupported WebSocket frame: payload length > 2^53 - 1",!1,1009,"WS_ERR_UNSUPPORTED_DATA_PAYLOAD_LENGTH")):(this._payloadLength=E*Math.pow(2,32)+n.readUInt32BE(4),this.haveLength())}haveLength(){if(this._payloadLength&&this._opcode<8&&(this._totalPayloadLength+=this._payloadLength,this._totalPayloadLength>this._maxPayload&&this._maxPayload>0))return this._loop=!1,g(RangeError,"Max payload size exceeded",!1,1009,"WS_ERR_UNSUPPORTED_MESSAGE_LENGTH");this._masked?this._state=S:this._state=u}getMask(){if(this._bufferedBytes<4){this._loop=!1;return}this._mask=this.consume(4),this._state=u}getData(n){let E=y;if(this._payloadLength){if(this._bufferedBytes<this._payloadLength){this._loop=!1;return}E=this.consume(this._payloadLength),this._masked&&this._mask[0]|this._mask[1]|this._mask[2]|this._mask[3]&&c(E,this._mask)}if(this._opcode>7)return this.controlMessage(E);if(this._compressed){this._state=d,this.decompress(E,n);return}return E.length&&(this._messageLength=this._totalPayloadLength,this._fragments.push(E)),this.dataMessage()}decompress(n,E){this._extensions[l.extensionName].decompress(n,this._fin,(b,I)=>{if(b)return E(b);if(I.length){if(this._messageLength+=I.length,this._messageLength>this._maxPayload&&this._maxPayload>0)return E(g(RangeError,"Max payload size exceeded",!1,1009,"WS_ERR_UNSUPPORTED_MESSAGE_LENGTH"));this._fragments.push(I)}let N=this.dataMessage();if(N)return E(N);this.startLoop(E)})}dataMessage(){if(this._fin){let n=this._messageLength,E=this._fragments;if(this._totalPayloadLength=0,this._messageLength=0,this._fragmented=0,this._fragments=[],this._opcode===2){let b;this._binaryType==="nodebuffer"?b=e(E,n):this._binaryType==="arraybuffer"?b=i(e(E,n)):b=E,this.emit("message",b,!0)}else{let b=e(E,n);if(!this._skipUTF8Validation&&!p(b))return this._loop=!1,g(Error,"invalid UTF-8 sequence",!0,1007,"WS_ERR_INVALID_UTF8");this.emit("message",b,!1)}}this._state=_}controlMessage(n){if(this._opcode===8)if(this._loop=!1,n.length===0)this.emit("conclude",1005,y),this.end();else{let E=n.readUInt16BE(0);if(!o(E))return g(RangeError,`invalid status code ${E}`,!0,1002,"WS_ERR_INVALID_CLOSE_CODE");let b=new k(n.buffer,n.byteOffset+2,n.length-2);if(!this._skipUTF8Validation&&!p(b))return g(Error,"invalid UTF-8 sequence",!0,1007,"WS_ERR_INVALID_UTF8");this.emit("conclude",E,b),this.end()}else this._opcode===9?this.emit("ping",n):this.emit("pong",n);this._state=_}};a.exports=w;function g(n,E,b,I,N){let B=new n(b?`Invalid WebSocket frame: ${E}`:E);return Error.captureStackTrace(B,g),B.code=N,B[r]=I,B}}),st=F((f,a)=>{"use strict";var m=require("net"),l=require("tls"),{randomFillSync:x}=require("crypto"),y=Ie(),{EMPTY_BUFFER:r}=ye(),{isValidStatusCode:h}=je(),{mask:e,toBuffer:i}=Le(),c=Symbol("kByteLength"),o=Buffer.alloc(4),p=class me{constructor(_,t,s){this._extensions=t||{},s&&(this._generateMask=s,this._maskBuffer=Buffer.alloc(4)),this._socket=_,this._firstFragment=!0,this._compress=!1,this._bufferedBytes=0,this._deflating=!1,this._queue=[]}static frame(_,t){let s,S=!1,u=2,d=!1;t.mask&&(s=t.maskBuffer||o,t.generateMask?t.generateMask(s):x(s,0,4),d=(s[0]|s[1]|s[2]|s[3])===0,u=6);let w;typeof _=="string"?(!t.mask||d)&&t[c]!==void 0?w=t[c]:(_=Buffer.from(_),w=_.length):(w=_.length,S=t.mask&&t.readOnly&&!d);let g=w;w>=65536?(u+=8,g=127):w>125&&(u+=2,g=126);let n=Buffer.allocUnsafe(S?w+u:u);return n[0]=t.fin?t.opcode|128:t.opcode,t.rsv1&&(n[0]|=64),n[1]=g,g===126?n.writeUInt16BE(w,2):g===127&&(n[2]=n[3]=0,n.writeUIntBE(w,4,6)),t.mask?(n[1]|=128,n[u-4]=s[0],n[u-3]=s[1],n[u-2]=s[2],n[u-1]=s[3],d?[n,_]:S?(e(_,s,n,u,w),[n]):(e(_,s,_,0,w),[n,_])):[n,_]}close(_,t,s,S){let u;if(_===void 0)u=r;else{if(typeof _!="number"||!h(_))throw new TypeError("First argument must be a valid error code number");if(t===void 0||!t.length)u=Buffer.allocUnsafe(2),u.writeUInt16BE(_,0);else{let w=Buffer.byteLength(t);if(w>123)throw new RangeError("The message must not be greater than 123 bytes");u=Buffer.allocUnsafe(2+w),u.writeUInt16BE(_,0),typeof t=="string"?u.write(t,2):u.set(t,2)}}let d={[c]:u.length,fin:!0,generateMask:this._generateMask,mask:s,maskBuffer:this._maskBuffer,opcode:8,readOnly:!1,rsv1:!1};this._deflating?this.enqueue([this.dispatch,u,!1,d,S]):this.sendFrame(me.frame(u,d),S)}ping(_,t,s){let S,u;if(typeof _=="string"?(S=Buffer.byteLength(_),u=!1):(_=i(_),S=_.length,u=i.readOnly),S>125)throw new RangeError("The data size must not be greater than 125 bytes");let d={[c]:S,fin:!0,generateMask:this._generateMask,mask:t,maskBuffer:this._maskBuffer,opcode:9,readOnly:u,rsv1:!1};this._deflating?this.enqueue([this.dispatch,_,!1,d,s]):this.sendFrame(me.frame(_,d),s)}pong(_,t,s){let S,u;if(typeof _=="string"?(S=Buffer.byteLength(_),u=!1):(_=i(_),S=_.length,u=i.readOnly),S>125)throw new RangeError("The data size must not be greater than 125 bytes");let d={[c]:S,fin:!0,generateMask:this._generateMask,mask:t,maskBuffer:this._maskBuffer,opcode:10,readOnly:u,rsv1:!1};this._deflating?this.enqueue([this.dispatch,_,!1,d,s]):this.sendFrame(me.frame(_,d),s)}send(_,t,s){let S=this._extensions[y.extensionName],u=t.binary?2:1,d=t.compress,w,g;if(typeof _=="string"?(w=Buffer.byteLength(_),g=!1):(_=i(_),w=_.length,g=i.readOnly),this._firstFragment?(this._firstFragment=!1,d&&S&&S.params[S._isServer?"server_no_context_takeover":"client_no_context_takeover"]&&(d=w>=S._threshold),this._compress=d):(d=!1,u=0),t.fin&&(this._firstFragment=!0),S){let n={[c]:w,fin:t.fin,generateMask:this._generateMask,mask:t.mask,maskBuffer:this._maskBuffer,opcode:u,readOnly:g,rsv1:d};this._deflating?this.enqueue([this.dispatch,_,this._compress,n,s]):this.dispatch(_,this._compress,n,s)}else this.sendFrame(me.frame(_,{[c]:w,fin:t.fin,generateMask:this._generateMask,mask:t.mask,maskBuffer:this._maskBuffer,opcode:u,readOnly:g,rsv1:!1}),s)}dispatch(_,t,s,S){if(!t){this.sendFrame(me.frame(_,s),S);return}let u=this._extensions[y.extensionName];this._bufferedBytes+=s[c],this._deflating=!0,u.compress(_,s.fin,(d,w)=>{if(this._socket.destroyed){let g=new Error("The socket was closed while data was being compressed");typeof S=="function"&&S(g);for(let n=0;n<this._queue.length;n++){let E=this._queue[n],b=E[E.length-1];typeof b=="function"&&b(g)}return}this._bufferedBytes-=s[c],this._deflating=!1,s.readOnly=!1,this.sendFrame(me.frame(w,s),S),this.dequeue()})}dequeue(){for(;!this._deflating&&this._queue.length;){let _=this._queue.shift();this._bufferedBytes-=_[3][c],Reflect.apply(_[0],this,_.slice(1))}}enqueue(_){this._bufferedBytes+=_[3][c],this._queue.push(_)}sendFrame(_,t){_.length===2?(this._socket.cork(),this._socket.write(_[0]),this._socket.write(_[1],t),this._socket.uncork()):this._socket.write(_[0],t)}};a.exports=p}),Vt=F((f,a)=>{"use strict";var{kForOnEventAttribute:m,kListener:l}=ye(),x=Symbol("kCode"),y=Symbol("kData"),r=Symbol("kError"),h=Symbol("kMessage"),e=Symbol("kReason"),i=Symbol("kTarget"),c=Symbol("kType"),o=Symbol("kWasClean"),p=class{constructor(u){this[i]=null,this[c]=u}get target(){return this[i]}get type(){return this[c]}};Object.defineProperty(p.prototype,"target",{enumerable:!0}),Object.defineProperty(p.prototype,"type",{enumerable:!0});var k=class extends p{constructor(u,d={}){super(u),this[x]=d.code===void 0?0:d.code,this[e]=d.reason===void 0?"":d.reason,this[o]=d.wasClean===void 0?!1:d.wasClean}get code(){return this[x]}get reason(){return this[e]}get wasClean(){return this[o]}};Object.defineProperty(k.prototype,"code",{enumerable:!0}),Object.defineProperty(k.prototype,"reason",{enumerable:!0}),Object.defineProperty(k.prototype,"wasClean",{enumerable:!0});var _=class extends p{constructor(u,d={}){super(u),this[r]=d.error===void 0?null:d.error,this[h]=d.message===void 0?"":d.message}get error(){return this[r]}get message(){return this[h]}};Object.defineProperty(_.prototype,"error",{enumerable:!0}),Object.defineProperty(_.prototype,"message",{enumerable:!0});var t=class extends p{constructor(u,d={}){super(u),this[y]=d.data===void 0?null:d.data}get data(){return this[y]}};Object.defineProperty(t.prototype,"data",{enumerable:!0});var s={addEventListener(u,d,w={}){for(let n of this.listeners(u))if(!w[m]&&n[l]===d&&!n[m])return;let g;if(u==="message")g=function(n,E){let b=new t("message",{data:E?n:n.toString()});b[i]=this,S(d,this,b)};else if(u==="close")g=function(n,E){let b=new k("close",{code:n,reason:E.toString(),wasClean:this._closeFrameReceived&&this._closeFrameSent});b[i]=this,S(d,this,b)};else if(u==="error")g=function(n){let E=new _("error",{error:n,message:n.message});E[i]=this,S(d,this,E)};else if(u==="open")g=function(){let n=new p("open");n[i]=this,S(d,this,n)};else return;g[m]=!!w[m],g[l]=d,w.once?this.once(u,g):this.on(u,g)},removeEventListener(u,d){for(let w of this.listeners(u))if(w[l]===d&&!w[m]){this.removeListener(u,w);break}}};a.exports={CloseEvent:k,ErrorEvent:_,Event:p,EventTarget:s,MessageEvent:t};function S(u,d,w){typeof u=="object"&&u.handleEvent?u.handleEvent.call(u,w):u.call(d,w)}}),ot=F((f,a)=>{"use strict";var{tokenChars:m}=je();function l(r,h,e){r[h]===void 0?r[h]=[e]:r[h].push(e)}function x(r){let h=Object.create(null),e=Object.create(null),i=!1,c=!1,o=!1,p,k,_=-1,t=-1,s=-1,S=0;for(;S<r.length;S++)if(t=r.charCodeAt(S),p===void 0)if(s===-1&&m[t]===1)_===-1&&(_=S);else if(S!==0&&(t===32||t===9))s===-1&&_!==-1&&(s=S);else if(t===59||t===44){if(_===-1)throw new SyntaxError(`Unexpected character at index ${S}`);s===-1&&(s=S);let d=r.slice(_,s);t===44?(l(h,d,e),e=Object.create(null)):p=d,_=s=-1}else throw new SyntaxError(`Unexpected character at index ${S}`);else if(k===void 0)if(s===-1&&m[t]===1)_===-1&&(_=S);else if(t===32||t===9)s===-1&&_!==-1&&(s=S);else if(t===59||t===44){if(_===-1)throw new SyntaxError(`Unexpected character at index ${S}`);s===-1&&(s=S),l(e,r.slice(_,s),!0),t===44&&(l(h,p,e),e=Object.create(null),p=void 0),_=s=-1}else if(t===61&&_!==-1&&s===-1)k=r.slice(_,S),_=s=-1;else throw new SyntaxError(`Unexpected character at index ${S}`);else if(c){if(m[t]!==1)throw new SyntaxError(`Unexpected character at index ${S}`);_===-1?_=S:i||(i=!0),c=!1}else if(o)if(m[t]===1)_===-1&&(_=S);else if(t===34&&_!==-1)o=!1,s=S;else if(t===92)c=!0;else throw new SyntaxError(`Unexpected character at index ${S}`);else if(t===34&&r.charCodeAt(S-1)===61)o=!0;else if(s===-1&&m[t]===1)_===-1&&(_=S);else if(_!==-1&&(t===32||t===9))s===-1&&(s=S);else if(t===59||t===44){if(_===-1)throw new SyntaxError(`Unexpected character at index ${S}`);s===-1&&(s=S);let d=r.slice(_,s);i&&(d=d.replace(/\\/g,""),i=!1),l(e,k,d),t===44&&(l(h,p,e),e=Object.create(null),p=void 0),k=void 0,_=s=-1}else throw new SyntaxError(`Unexpected character at index ${S}`);if(_===-1||o||t===32||t===9)throw new SyntaxError("Unexpected end of input");s===-1&&(s=S);let u=r.slice(_,s);return p===void 0?l(h,u,e):(k===void 0?l(e,u,!0):i?l(e,k,u.replace(/\\/g,"")):l(e,k,u),l(h,p,e)),h}function y(r){return Object.keys(r).map(h=>{let e=r[h];return Array.isArray(e)||(e=[e]),e.map(i=>[h].concat(Object.keys(i).map(c=>{let o=i[c];return Array.isArray(o)||(o=[o]),o.map(p=>p===!0?c:`${c}=${p}`).join("; ")})).join("; ")).join(", ")}).join(", ")}a.exports={format:y,parse:x}}),at=F((f,a)=>{"use strict";var m=require("events"),l=require("https"),x=require("http"),y=require("net"),r=require("tls"),{randomBytes:h,createHash:e}=require("crypto"),{Readable:i}=require("stream"),{URL:c}=require("url"),o=Ie(),p=rt(),k=st(),{BINARY_TYPES:_,EMPTY_BUFFER:t,GUID:s,kForOnEventAttribute:S,kListener:u,kStatusCode:d,kWebSocket:w,NOOP:g}=ye(),{EventTarget:{addEventListener:n,removeEventListener:E}}=Vt(),{format:b,parse:I}=ot(),{toBuffer:N}=Le(),B=30*1e3,A=Symbol("kAborted"),P=[8,13],T=["CONNECTING","OPEN","CLOSING","CLOSED"],R=/^[!#$%&'*+\-.0-9A-Z^_`|a-z~]+$/,U=class G extends m{constructor(C,L,j){super(),this._binaryType=_[0],this._closeCode=1006,this._closeFrameReceived=!1,this._closeFrameSent=!1,this._closeMessage=t,this._closeTimer=null,this._extensions={},this._paused=!1,this._protocol="",this._readyState=G.CONNECTING,this._receiver=null,this._sender=null,this._socket=null,C!==null?(this._bufferedAmount=0,this._isServer=!1,this._redirects=0,L===void 0?L=[]:Array.isArray(L)||(typeof L=="object"&&L!==null?(j=L,L=[]):L=[L]),D(this,C,L,j)):this._isServer=!0}get binaryType(){return this._binaryType}set binaryType(C){_.includes(C)&&(this._binaryType=C,this._receiver&&(this._receiver._binaryType=C))}get bufferedAmount(){return this._socket?this._socket._writableState.length+this._sender._bufferedBytes:this._bufferedAmount}get extensions(){return Object.keys(this._extensions).join()}get isPaused(){return this._paused}get onclose(){return null}get onerror(){return null}get onopen(){return null}get onmessage(){return null}get protocol(){return this._protocol}get readyState(){return this._readyState}get url(){return this._url}setSocket(C,L,j){let O=new p({binaryType:this.binaryType,extensions:this._extensions,isServer:this._isServer,maxPayload:j.maxPayload,skipUTF8Validation:j.skipUTF8Validation});this._sender=new k(C,this._extensions,j.generateMask),this._receiver=O,this._socket=C,O[w]=this,C[w]=this,O.on("conclude",Ne),O.on("drain",Ue),O.on("error",we),O.on("message",Se),O.on("ping",ke),O.on("pong",te),C.setTimeout(0),C.setNoDelay(),L.length>0&&C.unshift(L),C.on("close",se),C.on("data",oe),C.on("end",de),C.on("error",fe),this._readyState=G.OPEN,this.emit("open")}emitClose(){if(!this._socket){this._readyState=G.CLOSED,this.emit("close",this._closeCode,this._closeMessage);return}this._extensions[o.extensionName]&&this._extensions[o.extensionName].cleanup(),this._receiver.removeAllListeners(),this._readyState=G.CLOSED,this.emit("close",this._closeCode,this._closeMessage)}close(C,L){if(this.readyState!==G.CLOSED){if(this.readyState===G.CONNECTING){let j="WebSocket was closed before the connection was established";Y(this,this._req,j);return}if(this.readyState===G.CLOSING){this._closeFrameSent&&(this._closeFrameReceived||this._receiver._writableState.errorEmitted)&&this._socket.end();return}this._readyState=G.CLOSING,this._sender.close(C,L,!this._isServer,j=>{j||(this._closeFrameSent=!0,(this._closeFrameReceived||this._receiver._writableState.errorEmitted)&&this._socket.end())}),this._closeTimer=setTimeout(this._socket.destroy.bind(this._socket),B)}}pause(){this.readyState===G.CONNECTING||this.readyState===G.CLOSED||(this._paused=!0,this._socket.pause())}ping(C,L,j){if(this.readyState===G.CONNECTING)throw new Error("WebSocket is not open: readyState 0 (CONNECTING)");if(typeof C=="function"?(j=C,C=L=void 0):typeof L=="function"&&(j=L,L=void 0),typeof C=="number"&&(C=C.toString()),this.readyState!==G.OPEN){ce(this,C,j);return}L===void 0&&(L=!this._isServer),this._sender.ping(C||t,L,j)}pong(C,L,j){if(this.readyState===G.CONNECTING)throw new Error("WebSocket is not open: readyState 0 (CONNECTING)");if(typeof C=="function"?(j=C,C=L=void 0):typeof L=="function"&&(j=L,L=void 0),typeof C=="number"&&(C=C.toString()),this.readyState!==G.OPEN){ce(this,C,j);return}L===void 0&&(L=!this._isServer),this._sender.pong(C||t,L,j)}resume(){this.readyState===G.CONNECTING||this.readyState===G.CLOSED||(this._paused=!1,this._receiver._writableState.needDrain||this._socket.resume())}send(C,L,j){if(this.readyState===G.CONNECTING)throw new Error("WebSocket is not open: readyState 0 (CONNECTING)");if(typeof L=="function"&&(j=L,L={}),typeof C=="number"&&(C=C.toString()),this.readyState!==G.OPEN){ce(this,C,j);return}let O={binary:typeof C!="string",mask:!this._isServer,compress:!0,fin:!0,...L};this._extensions[o.extensionName]||(O.compress=!1),this._sender.send(C||t,O,j)}terminate(){if(this.readyState!==G.CLOSED){if(this.readyState===G.CONNECTING){let C="WebSocket was closed before the connection was established";Y(this,this._req,C);return}this._socket&&(this._readyState=G.CLOSING,this._socket.destroy())}}};Object.defineProperty(U,"CONNECTING",{enumerable:!0,value:T.indexOf("CONNECTING")}),Object.defineProperty(U.prototype,"CONNECTING",{enumerable:!0,value:T.indexOf("CONNECTING")}),Object.defineProperty(U,"OPEN",{enumerable:!0,value:T.indexOf("OPEN")}),Object.defineProperty(U.prototype,"OPEN",{enumerable:!0,value:T.indexOf("OPEN")}),Object.defineProperty(U,"CLOSING",{enumerable:!0,value:T.indexOf("CLOSING")}),Object.defineProperty(U.prototype,"CLOSING",{enumerable:!0,value:T.indexOf("CLOSING")}),Object.defineProperty(U,"CLOSED",{enumerable:!0,value:T.indexOf("CLOSED")}),Object.defineProperty(U.prototype,"CLOSED",{enumerable:!0,value:T.indexOf("CLOSED")}),["binaryType","bufferedAmount","extensions","isPaused","protocol","readyState","url"].forEach(v=>{Object.defineProperty(U.prototype,v,{enumerable:!0})}),["open","error","close","message"].forEach(v=>{Object.defineProperty(U.prototype,`on${v}`,{enumerable:!0,get(){for(let C of this.listeners(v))if(C[S])return C[u];return null},set(C){for(let L of this.listeners(v))if(L[S]){this.removeListener(v,L);break}typeof C=="function"&&this.addEventListener(v,C,{[S]:!0})}})}),U.prototype.addEventListener=n,U.prototype.removeEventListener=E,a.exports=U;function D(v,C,L,j){let O={protocolVersion:P[1],maxPayload:104857600,skipUTF8Validation:!1,perMessageDeflate:!0,followRedirects:!1,maxRedirects:10,...j,createConnection:void 0,socketPath:void 0,hostname:void 0,protocol:void 0,timeout:void 0,method:"GET",host:void 0,path:void 0,port:void 0};if(!P.includes(O.protocolVersion))throw new RangeError(`Unsupported protocol version: ${O.protocolVersion} (supported versions: ${P.join(", ")})`);let $;if(C instanceof c)$=C,v._url=C.href;else{try{$=new c(C)}catch{throw new SyntaxError(`Invalid URL: ${C}`)}v._url=C}let J=$.protocol==="wss:",ae=$.protocol==="ws+unix:",Q;if($.protocol!=="ws:"&&!J&&!ae?Q=`The URL's protocol must be one of "ws:", "wss:", or "ws+unix:"`:ae&&!$.pathname?Q="The URL's pathname is empty":$.hash&&(Q="The URL contains a fragment identifier"),Q){let q=new SyntaxError(Q);if(v._redirects===0)throw q;V(v,q);return}let K=J?443:80,M=h(16).toString("base64"),Z=J?l.request:x.request,he=new Set,W;if(O.createConnection=J?H:le,O.defaultPort=O.defaultPort||K,O.port=$.port||K,O.host=$.hostname.startsWith("[")?$.hostname.slice(1,-1):$.hostname,O.headers={...O.headers,"Sec-WebSocket-Version":O.protocolVersion,"Sec-WebSocket-Key":M,Connection:"Upgrade",Upgrade:"websocket"},O.path=$.pathname+$.search,O.timeout=O.handshakeTimeout,O.perMessageDeflate&&(W=new o(O.perMessageDeflate!==!0?O.perMessageDeflate:{},!1,O.maxPayload),O.headers["Sec-WebSocket-Extensions"]=b({[o.extensionName]:W.offer()})),L.length){for(let q of L){if(typeof q!="string"||!R.test(q)||he.has(q))throw new SyntaxError("An invalid or duplicated subprotocol was specified");he.add(q)}O.headers["Sec-WebSocket-Protocol"]=L.join(",")}if(O.origin&&(O.protocolVersion<13?O.headers["Sec-WebSocket-Origin"]=O.origin:O.headers.Origin=O.origin),($.username||$.password)&&(O.auth=`${$.username}:${$.password}`),ae){let q=O.path.split(":");O.socketPath=q[0],O.path=q[1]}let z;if(O.followRedirects){if(v._redirects===0){v._originalIpc=ae,v._originalSecure=J,v._originalHostOrSocketPath=ae?O.socketPath:$.host;let q=j&&j.headers;if(j={...j,headers:{}},q)for(let[ee,ge]of Object.entries(q))j.headers[ee.toLowerCase()]=ge}else if(v.listenerCount("redirect")===0){let q=ae?v._originalIpc?O.socketPath===v._originalHostOrSocketPath:!1:v._originalIpc?!1:$.host===v._originalHostOrSocketPath;(!q||v._originalSecure&&!J)&&(delete O.headers.authorization,delete O.headers.cookie,q||delete O.headers.host,O.auth=void 0)}O.auth&&!j.headers.authorization&&(j.headers.authorization="Basic "+Buffer.from(O.auth).toString("base64")),z=v._req=Z(O),v._redirects&&v.emit("redirect",v.url,z)}else z=v._req=Z(O);O.timeout&&z.on("timeout",()=>{Y(v,z,"Opening handshake has timed out")}),z.on("error",q=>{z===null||z[A]||(z=v._req=null,V(v,q))}),z.on("response",q=>{let ee=q.headers.location,ge=q.statusCode;if(ee&&O.followRedirects&&ge>=300&&ge<400){if(++v._redirects>O.maxRedirects){Y(v,z,"Maximum redirects exceeded");return}z.abort();let Ce;try{Ce=new c(ee,C)}catch{let be=new SyntaxError(`Invalid URL: ${ee}`);V(v,be);return}D(v,Ce,L,j)}else v.emit("unexpected-response",z,q)||Y(v,z,`Unexpected server response: ${q.statusCode}`)}),z.on("upgrade",(q,ee,ge)=>{if(v.emit("upgrade",q),v.readyState!==U.CONNECTING)return;if(z=v._req=null,q.headers.upgrade.toLowerCase()!=="websocket"){Y(v,ee,"Invalid Upgrade header");return}let Ce=e("sha1").update(M+s).digest("base64");if(q.headers["sec-websocket-accept"]!==Ce){Y(v,ee,"Invalid Sec-WebSocket-Accept header");return}let be=q.headers["sec-websocket-protocol"],xe;if(be!==void 0?he.size?he.has(be)||(xe="Server sent an invalid subprotocol"):xe="Server sent a subprotocol but none was requested":he.size&&(xe="Server sent no subprotocol"),xe){Y(v,ee,xe);return}be&&(v._protocol=be);let Ge=q.headers["sec-websocket-extensions"];if(Ge!==void 0){if(!W){Y(v,ee,"Server sent a Sec-WebSocket-Extensions header but no extension was requested");return}let Me;try{Me=I(Ge)}catch{Y(v,ee,"Invalid Sec-WebSocket-Extensions header");return}let Ve=Object.keys(Me);if(Ve.length!==1||Ve[0]!==o.extensionName){Y(v,ee,"Server indicated an extension that was not requested");return}try{W.accept(Me[o.extensionName])}catch{Y(v,ee,"Invalid Sec-WebSocket-Extensions header");return}v._extensions[o.extensionName]=W}v.setSocket(ee,ge,{generateMask:O.generateMask,maxPayload:O.maxPayload,skipUTF8Validation:O.skipUTF8Validation})}),O.finishRequest?O.finishRequest(z,v):z.end()}function V(v,C){v._readyState=U.CLOSING,v.emit("error",C),v.emitClose()}function le(v){return v.path=v.socketPath,y.connect(v)}function H(v){return v.path=void 0,!v.servername&&v.servername!==""&&(v.servername=y.isIP(v.host)?"":v.host),r.connect(v)}function Y(v,C,L){v._readyState=U.CLOSING;let j=new Error(L);Error.captureStackTrace(j,Y),C.setHeader?(C[A]=!0,C.abort(),C.socket&&!C.socket.destroyed&&C.socket.destroy(),process.nextTick(V,v,j)):(C.destroy(j),C.once("error",v.emit.bind(v,"error")),C.once("close",v.emitClose.bind(v)))}function ce(v,C,L){if(C){let j=N(C).length;v._socket?v._sender._bufferedBytes+=j:v._bufferedAmount+=j}if(L){let j=new Error(`WebSocket is not open: readyState ${v.readyState} (${T[v.readyState]})`);process.nextTick(L,j)}}function Ne(v,C){let L=this[w];L._closeFrameReceived=!0,L._closeMessage=C,L._closeCode=v,L._socket[w]!==void 0&&(L._socket.removeListener("data",oe),process.nextTick(pe,L._socket),v===1005?L.close():L.close(v,C))}function Ue(){let v=this[w];v.isPaused||v._socket.resume()}function we(v){let C=this[w];C._socket[w]!==void 0&&(C._socket.removeListener("data",oe),process.nextTick(pe,C._socket),C.close(v[d])),C.emit("error",v)}function ve(){this[w].emitClose()}function Se(v,C){this[w].emit("message",v,C)}function ke(v){let C=this[w];C.pong(v,!C._isServer,g),C.emit("ping",v)}function te(v){this[w].emit("pong",v)}function pe(v){v.resume()}function se(){let v=this[w];this.removeListener("close",se),this.removeListener("data",oe),this.removeListener("end",de),v._readyState=U.CLOSING;let C;!this._readableState.endEmitted&&!v._closeFrameReceived&&!v._receiver._writableState.errorEmitted&&(C=v._socket.read())!==null&&v._receiver.write(C),v._receiver.end(),this[w]=void 0,clearTimeout(v._closeTimer),v._receiver._writableState.finished||v._receiver._writableState.errorEmitted?v.emitClose():(v._receiver.on("error",ve),v._receiver.on("finish",ve))}function oe(v){this[w]._receiver.write(v)||this.pause()}function de(){let v=this[w];v._readyState=U.CLOSING,v._receiver.end(),this.end()}function fe(){let v=this[w];this.removeListener("error",fe),this.on("error",g),v&&(v._readyState=U.CLOSING,this.destroy())}}),Kt=F((f,a)=>{"use strict";var{tokenChars:m}=je();function l(x){let y=new Set,r=-1,h=-1,e=0;for(e;e<x.length;e++){let c=x.charCodeAt(e);if(h===-1&&m[c]===1)r===-1&&(r=e);else if(e!==0&&(c===32||c===9))h===-1&&r!==-1&&(h=e);else if(c===44){if(r===-1)throw new SyntaxError(`Unexpected character at index ${e}`);h===-1&&(h=e);let o=x.slice(r,h);if(y.has(o))throw new SyntaxError(`The "${o}" subprotocol is duplicated`);y.add(o),r=h=-1}else throw new SyntaxError(`Unexpected character at index ${e}`)}if(r===-1||h!==-1)throw new SyntaxError("Unexpected end of input");let i=x.slice(r,e);if(y.has(i))throw new SyntaxError(`The "${i}" subprotocol is duplicated`);return y.add(i),y}a.exports={parse:l}}),Ht=F((f,a)=>{"use strict";var m=require("events"),l=require("http"),x=require("https"),y=require("net"),r=require("tls"),{createHash:h}=require("crypto"),e=ot(),i=Ie(),c=Kt(),o=at(),{GUID:p,kWebSocket:k}=ye(),_=/^[+/0-9A-Za-z]{22}==$/,t=0,s=1,S=2,u=class extends m{constructor(b,I){if(super(),b={maxPayload:100*1024*1024,skipUTF8Validation:!1,perMessageDeflate:!1,handleProtocols:null,clientTracking:!0,verifyClient:null,noServer:!1,backlog:null,server:null,host:null,path:null,port:null,WebSocket:o,...b},b.port==null&&!b.server&&!b.noServer||b.port!=null&&(b.server||b.noServer)||b.server&&b.noServer)throw new TypeError('One and only one of the "port", "server", or "noServer" options must be specified');if(b.port!=null?(this._server=l.createServer((N,B)=>{let A=l.STATUS_CODES[426];B.writeHead(426,{"Content-Length":A.length,"Content-Type":"text/plain"}),B.end(A)}),this._server.listen(b.port,b.host,b.backlog,I)):b.server&&(this._server=b.server),this._server){let N=this.emit.bind(this,"connection");this._removeListeners=d(this._server,{listening:this.emit.bind(this,"listening"),error:this.emit.bind(this,"error"),upgrade:(B,A,P)=>{this.handleUpgrade(B,A,P,N)}})}b.perMessageDeflate===!0&&(b.perMessageDeflate={}),b.clientTracking&&(this.clients=new Set,this._shouldEmitClose=!1),this.options=b,this._state=t}address(){if(this.options.noServer)throw new Error('The server is operating in "noServer" mode');return this._server?this._server.address():null}close(b){if(this._state===S){b&&this.once("close",()=>{b(new Error("The server is not running"))}),process.nextTick(w,this);return}if(b&&this.once("close",b),this._state!==s)if(this._state=s,this.options.noServer||this.options.server)this._server&&(this._removeListeners(),this._removeListeners=this._server=null),this.clients?this.clients.size?this._shouldEmitClose=!0:process.nextTick(w,this):process.nextTick(w,this);else{let I=this._server;this._removeListeners(),this._removeListeners=this._server=null,I.close(()=>{w(this)})}}shouldHandle(b){if(this.options.path){let I=b.url.indexOf("?");if((I!==-1?b.url.slice(0,I):b.url)!==this.options.path)return!1}return!0}handleUpgrade(b,I,N,B){I.on("error",g);let A=b.headers["sec-websocket-key"],P=+b.headers["sec-websocket-version"];if(b.method!=="GET"){E(this,b,I,405,"Invalid HTTP method");return}if(b.headers.upgrade.toLowerCase()!=="websocket"){E(this,b,I,400,"Invalid Upgrade header");return}if(!A||!_.test(A)){E(this,b,I,400,"Missing or invalid Sec-WebSocket-Key header");return}if(P!==8&&P!==13){E(this,b,I,400,"Missing or invalid Sec-WebSocket-Version header");return}if(!this.shouldHandle(b)){n(I,400);return}let T=b.headers["sec-websocket-protocol"],R=new Set;if(T!==void 0)try{R=c.parse(T)}catch{E(this,b,I,400,"Invalid Sec-WebSocket-Protocol header");return}let U=b.headers["sec-websocket-extensions"],D={};if(this.options.perMessageDeflate&&U!==void 0){let V=new i(this.options.perMessageDeflate,!0,this.options.maxPayload);try{let le=e.parse(U);le[i.extensionName]&&(V.accept(le[i.extensionName]),D[i.extensionName]=V)}catch{E(this,b,I,400,"Invalid or unacceptable Sec-WebSocket-Extensions header");return}}if(this.options.verifyClient){let V={origin:b.headers[`${P===8?"sec-websocket-origin":"origin"}`],secure:!!(b.socket.authorized||b.socket.encrypted),req:b};if(this.options.verifyClient.length===2){this.options.verifyClient(V,(le,H,Y,ce)=>{if(!le)return n(I,H||401,Y,ce);this.completeUpgrade(D,A,R,b,I,N,B)});return}if(!this.options.verifyClient(V))return n(I,401)}this.completeUpgrade(D,A,R,b,I,N,B)}completeUpgrade(b,I,N,B,A,P,T){if(!A.readable||!A.writable)return A.destroy();if(A[k])throw new Error("server.handleUpgrade() was called more than once with the same socket, possibly due to a misconfiguration");if(this._state>t)return n(A,503);let R=["HTTP/1.1 101 Switching Protocols","Upgrade: websocket","Connection: Upgrade",`Sec-WebSocket-Accept: ${h("sha1").update(I+p).digest("base64")}`],U=new this.options.WebSocket(null);if(N.size){let D=this.options.handleProtocols?this.options.handleProtocols(N,B):N.values().next().value;D&&(R.push(`Sec-WebSocket-Protocol: ${D}`),U._protocol=D)}if(b[i.extensionName]){let D=b[i.extensionName].params,V=e.format({[i.extensionName]:[D]});R.push(`Sec-WebSocket-Extensions: ${V}`),U._extensions=b}this.emit("headers",R,B),A.write(R.concat(`\r
`).join(`\r
`)),A.removeListener("error",g),U.setSocket(A,P,{maxPayload:this.options.maxPayload,skipUTF8Validation:this.options.skipUTF8Validation}),this.clients&&(this.clients.add(U),U.on("close",()=>{this.clients.delete(U),this._shouldEmitClose&&!this.clients.size&&process.nextTick(w,this)})),T(U,B)}};a.exports=u;function d(b,I){for(let N of Object.keys(I))b.on(N,I[N]);return function(){for(let N of Object.keys(I))b.removeListener(N,I[N])}}function w(b){b._state=S,b.emit("close")}function g(){this.destroy()}function n(b,I,N,B){N=N||l.STATUS_CODES[I],B={Connection:"close","Content-Type":"text/html","Content-Length":Buffer.byteLength(N),...B},b.once("finish",b.destroy),b.end(`HTTP/1.1 ${I} ${l.STATUS_CODES[I]}\r
`+Object.keys(B).map(A=>`${A}: ${B[A]}`).join(`\r
`)+`\r
\r
`+N)}function E(b,I,N,B,A){if(b.listenerCount("wsClientError")){let P=new Error(A);Error.captureStackTrace(P,E),b.emit("wsClientError",P,N,I)}else n(N,B,A)}}),nt={};Ut(nt,{chronocat:()=>qi});yt.exports=Mt(nt);var He=ne(it()),Te={},Ae={},Re={},lt={},ue={},ct={},Pe={},ht={},Yt=require("electron"),Jt=()=>{let f=new Date().getTime();return f+=performance.now(),"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,a=>{let m=(f+Math.random()*16)%16|0;return f=Math.floor(f/16),(a==="x"?m:m&3|8).toString(16)})},Xt=async(f,a,...m)=>{let l=Jt(),x=await Promise.race([new Promise((y,r)=>setTimeout(()=>r(),5e3)),new Promise(y=>{Te[l]=y,Yt.ipcMain.emit(f,{sender:{send:(...r)=>{y(r)},__CHRONO_HOOKED__:!0}},{type:"request",callbackId:l,eventName:a},m)})]);return delete Te[l],x};function X(f,a,m){return(...l)=>Xt(f,a,m,...l)}var Zt=X("IPC_UP_2","ns-ntApi-2","nodeIKernelGroupService/getMemberInfo"),pt=X("IPC_UP_2","ns-ntApi-2","nodeIKernelGroupService/createMemberListScene"),Qt=X("IPC_UP_2","ns-ntApi-2","nodeIKernelGroupService/searchMember"),De=X("IPC_UP_2","ns-ntApi-2","nodeIKernelGroupService/destroyMemberListScene"),ei=X("IPC_UP_2","ns-ntApi-2","nodeIKernelGroupService/getNextMemberList"),ti=X("IPC_UP_2","ns-ntApi-2","nodeIKernelGroupService/setMemberShutUp"),ii=X("IPC_UP_2","ns-ntApi-2","nodeIKernelGroupService/setGroupShutUp"),ri=X("IPC_UP_2","ns-ntApi-2","nodeIKernelGroupService/kickMember"),Be=require("electron"),si=f=>{let a=Be.ipcMain.emit;return Be.ipcMain.emit=function(m,...l){let x=l[0],y=l?.[1],r=l?.[2],h=x.sender;if(!h.__CHRONO_HOOKED__){let i=h.send;h.__CHRONO_HOOKED__=!0,h.send=function(c,o,p){if(f({Full:[c,o,p],EventName:o.eventName,CmdName:p?.[0]?.cmdName,Payload:p?.[0]?.payload,Request:Re[o.callbackId]}),i.call(this,c,o,p),o.callbackId){let k=o.callbackId;Te[k]&&Te[k]?.call(o,p),Ae[o.callbackId]&&(Ae[o.callbackId].resolved=p)}delete Re[o.callbackId]}}let e={Full:l,EventName:y?.eventName,Method:r?.[0],Args:r,Channel:m};return a.call(this,m,...l),y?.eventName?.includes("Log")||(Ae[y?.callbackId]??={},Re[y?.callbackId]=e),!1},()=>{Be.ipcMain.emit=a}},oi={body:"none",httpOnly:!1,requireAuthorize:!0},dt=[],qe=(f,a)=>new Proxy(()=>{},{get(m,l){if(typeof l=="symbol")throw Error("Symbol is not supported");return l.startsWith("$")?x=>qe(f,{...a,[l.slice(1)]:x}):qe([...f,l],a)},set(m,l,x,y){throw Error("Cannot set property on router")},apply(m,l,[x,y]){dt.push({path:f,options:{...a,...y},handler:x})}}),re=qe([],oi),Ye=f=>dt.find(a=>!a.path.some((m,l)=>m!==f[l]));re.bot.friends(async()=>Object.values(ct));re.bot.groups(async()=>Object.values(lt));re.getSelfProfile(async()=>ht.value??{});var ft=f=>{};re.group.getMemberList.$body("json")(async({body:f})=>{let{group:a,size:m}=f,l=await pt({groupCode:a,scene:"groupMemberList_MainWindow"}),x=await ei({sceneId:l,lastId:void 0,num:m});return await De({sceneId:l}),ft(De({sceneId:l})),x.result?.ids?.map(({uid:y,index:r})=>({uid:y,index:r,detail:x.result.infos.get(y)}))});var ai=ne(At()),ni=class{#e={};get(f,a){a(this.#e[f])}set(f,a,m){this.#e[f]=a,m()}clear(f){this.#e={},f()}};function li(f){let a=Math.floor(Math.random()*1e8).toString(36),m=new ni;function l(){return function(...x){let y=this,r=x.slice(),h=r.pop(),e=a+"="+(0,ai.default)(r);m.get(e,function(i){if(i&&(!i.expires||i.expires>=Date.now()))return h.apply(y,i.args);r.push(function(...c){let o=this,p=c.slice();m.set(e,{args:p,expires:Date.now()+3e4},function(){h.apply(o,p)})}),f.apply(f,r)})}}return l()}var _e={},ut=f=>{let a=[],m=l=>{for(let x in l)l[x]instanceof Map||(l[x]instanceof Object?m(l[x]):a.push([x,l[x],l]))};return m(f),a},ze=f=>{let a={uid:"uin",uin:"uid",Uid:"Uin",Uin:"Uid"};for(let m in a)if(f.endsWith(m))return f.slice(0,-m.length)+a[m]},mt=(f,a)=>{parseInt(f)===0||parseInt(a)===0||(_e[f]=a,_e[a]=f)},Je=li(async f=>{let a=await pt({groupCode:f,scene:"groupMemberList_MainWindow"});ft(Qt({sceneId:a,keyword:f})),await De({sceneId:a})}),ci=f=>{for(let[a,m,l]of ut(f)){let x=ze(a);if(x&&l[x]){if(parseInt(l[x])==0||!l[x]||l[x].includes("*")||_e[m])continue;mt(m,l[x])}}},hi=async(f,{contextGroup:a=-1}={})=>{let m=ut(f);for(let[l,x,y]of m){let r=ze(l);r&&!y[r]&&(l.toLocaleLowerCase().endsWith("uin")&&a!==-1&&Je(a,x),l==="atNtUid"&&Je(a,y.content.slice(1)))}await new Promise(l=>setTimeout(l,80));for(let[l,x,y]of m){let r=ze(l);l==="peerUin"&&y.chatType===2&&(y.peerUid=x),l==="peerUid"&&!x.startsWith("u_")&&(y.peerUin=x),r&&!y[r]&&_e[x]&&(y[r]=_e[x])}return f},pi=f=>f.map(a=>_e[a]??a),ie={cacheObject:ci,preprocessObject:hi,addToMap:mt,preprocessArrayOfUix:pi,map:_e};re.group.kick.$body("json")(async({body:f})=>{let{uidList:a,group:m,reason:l,refuseForever:x}=f;return await ri({groupCode:m,kickUids:ie.preprocessArrayOfUix(a),refuseForever:x,kickReason:l})});re.group.muteEveryone.$body("json")(async({body:f})=>{let{group:a,enable:m}=f;return await ii({groupCode:a,shutUp:m})});re.group.muteMember.$body("json")(async({body:f})=>{let{group:a,memList:m}=f;return await ti({groupCode:a,memList:await ie.preprocessObject(m,{contextGroup:Number(a)})})});var di=ne(Wt()),fi=require("node:fs"),ui=X("IPC_UP_2","ns-ntApi-2","nodeIKernelMsgService/recallMsg"),mi=X("IPC_UP_2","ns-ntApi-2","nodeIKernelMsgService/downloadRichMedia"),_i=X("IPC_UP_2","ns-ntApi-2","nodeIKernelMsgService/getMsgsIncludeSelf"),yi=X("IPC_UP_2","ns-ntApi-2","nodeIKernelMsgService/getRichMediaFilePath"),gi=X("IPC_UP_2","ns-ntApi-2","nodeIKernelMsgService/sendMsg");re.message.fetchRichMedia.$body("json").$httpOnly(!0)(async({body:f,http:a})=>{let{msgId:m,elementId:l,chatType:x,peerUid:y}=f,r=m+"::"+l;console.log("DownloadId:",r);let h=new Promise(i=>{Pe[r]=i});x===1&&!y.startsWith("u_")&&(y=ie.map[y]),await mi({getReq:{msgId:m,chatType:x,peerUid:y,elementId:l,thumbSize:0,downloadType:2}});let e=await h;a.res.statusCode=200,a.res.setHeader("Content-Type",(0,di.getType)(e)),(0,fi.createReadStream)(e).pipe(a.res)});re.message.getHistory.$body("json")(async({body:f})=>{let{peer:a,offsetMsgId:m,count:l}=f;return await _i({peer:await ie.preprocessObject(a),msgId:m,cnt:l,queryOrder:!0})});re.message.recall.$body("json")(async({body:f})=>{let{peer:a,msgIds:m}=f;return ui({peer:await ie.preprocessObject(a),msgIds:m})});var Xe=ne(it()),_t=f=>"peer"in f?!f.elements.some(a=>a.walletElement||a.arkElement):!(f.msgType===Xe.MsgType.Ark||f.msgType===Xe.MsgType.Wallet),Ze={atTinyUid:"",elementId:"",msgId:"0",chatType:1,guildId:"",peerUid:"",peerUin:"",elementType:1,content:"",atUid:"",atNtUid:"",atType:0,extBufForUI:"",fileName:"",fileSize:"",fileSubId:"",fileUuid:"",md5HexStr:"",original:!0,picHeight:0,picWidth:0,picType:0,picSubType:0,sourcePath:"",summary:"",thumbFileSize:0},bi=f=>{let a=m=>{for(let l in m)if(typeof m[l]=="object"&&m[l]!==null)a(m[l]);else for(let x in Ze)m[x]??=Ze[x]};return a(f),f};re.message.send.$body("json")(async({body:f})=>{let a=f;return _t(a)?(bi(a),gi({msgId:"0",peer:await ie.preprocessObject(a.peer),msgElements:await ie.preprocessObject(a.elements,{contextGroup:a.peer.chatType===2?Number(a.peer.peerUin):void 0})})):{}});var vi=ne(Ft()),xi=require("node:crypto"),wi=require("node:fs"),Qe=require("node:fs/promises"),et=require("node:path"),Si=X("IPC_UP_2","ns-fsApi-2","getFileMd5"),ki=X("IPC_UP_2","ns-fsApi-2","getImageSizeFromPath"),Ci=X("IPC_UP_2","ns-fsApi-2","getFileSize"),Ei=X("IPC_UP_2","ns-fsApi-2","getFileType"),Pi=require("node:os"),Ti=require("node:path"),Fe=(0,Ti.join)(process.env.APPDATA||(0,Pi.homedir)(),"BetterUniverse/QQNT");re.upload.$body("binary").$httpOnly("POST")(async({http:{req:f,res:a}})=>{let m=(0,vi.default)({headers:f.headers}),l,x;m.on("file",(y,r,h)=>void(async()=>{let e=(0,et.join)(Fe,"redprotocol-upload");await(0,Qe.mkdir)(e,{recursive:!0}),l=(0,et.join)(e,`${(0,xi.randomFillSync)(Buffer.alloc(16)).toString("hex")}-${h.filename}`),x=h,r.pipe((0,wi.createWriteStream)(l))})()),m.on("close",()=>void(async()=>{if(!l){a.writeHead(400),a.end("400 bad request");return}let y=(await Ei(l)).mime.split("/")[0],[r,h,e]=await Promise.all([Si(l),y==="image"?ki(l):void 0,Ci(l)]),i=await yi({md5HexStr:r,fileName:x.filename,elementType:2,elementSubType:0,thumbSize:0,needCreate:!0,fileType:1});await(0,Qe.copyFile)(l,i),a.writeHead(200),a.end(JSON.stringify({md5:r,imageInfo:h,fileSize:e,filePath:l,ntFilePath:i}))})()),f.pipe(m)});var Oi=f=>a=>a.headers.authorization?.slice(0,7)==="Bearer "&&a.headers.authorization.slice(7)===f,Li=f=>a=>a.token===f,Ii=require("node:http"),ji=class{constructor(f,{authorizer:a,rootPath:m="/api/",port:l}){this.server=(0,Ii.createServer)(async(x,y)=>{if(!x.url){y.writeHead(400),y.end("404 bad request");return}let r=new URL(x.url,`http://${x.headers.host}`);if(!r.pathname.startsWith(m)){y.writeHead(404),y.end("404 not found");return}let h=r.pathname.slice(m.length).split("/").filter(i=>i),e=f(h);if(e){e.options.requireAuthorize&&!await a(x)&&(y.writeHead(401),y.end("401 unauthorized"));let i=k=>{let _=[];return new Promise((t,s)=>{k.on("data",S=>{_.push(S)}),k.on("end",()=>{t(Buffer.concat(_))}),k.on("error",()=>{s()})})},c=async k=>(await i(k)).toString("utf-8"),o;e.options.body==="binary"?o=await i(x):e.options.body==="json"?o=JSON.parse(await c(x)):e.options.body==="text"&&(o=await c(x));let p={http:e.options.httpOnly&&{req:x,res:y},body:o};y.writableEnded||(y.setHeader("Content-Type","application/json"),y.writeHead(200),y.end(JSON.stringify(await e.handler(p))))}else y.writeHead(404),y.end("404 not found")}),this.server.listen(l)}server;stop(){this.server.close()}},Ni={createServer:(f,a)=>new ji(f,a)},Gi=ne($t(),1),Vi=ne(rt(),1),Ki=ne(st(),1),Hi=ne(at(),1),Ui=ne(Ht(),1),Mi=class{constructor(f,{authorizer:a,rootPath:m="/",mountHTTPServer:l,port:x,connectPayload:y}){this.server=new Ui.default({server:l,port:x,path:m}),this.server.on("connection",async r=>{r.once("message",async h=>{try{let e=JSON.parse(h.toString()),{type:i,payload:c}=e;if(i==="meta::connect"){if(!await a(c)){r.close(401);return}this.wsAuthedClients.push(r),r.on("message",async o=>{let p=JSON.parse(o.toString());if(typeof i!="string")return;let k=p.type.split("::"),_=f(k);await this.handleRoute(_,r,p)}),r.on("disconnect",()=>this.wsAuthedClients.splice(this.wsAuthedClients.indexOf(r),1)),r.send(JSON.stringify({type:"meta::connect",payload:y()}))}else if(typeof i=="string"){let o=i.split("::"),p=f(o);if(p.options.requireAuthorize)throw Error("Authorize needed");await this.handleRoute(p,r,e)}else throw new Error("Invalid API type")}catch{r.close(401)}})})}server;wsAuthedClients=[];async handleRoute(f,a,m){let l=x=>a.send(JSON.stringify({type:`${f.path.join("::")}::reply`,payload:x,echo:m.echo}));if(f){let{payload:x}=m;if(f.options.httpOnly)return l({error:"route not supported",reason:"This route is http only"});if(f.options.body==="binary")return l({error:"route not supported",reason:"Binary body is not supported for websocket"});if(f.options.body==="json"&&typeof x!="object")return l({error:"invalid payload",reason:"Payload must be an object for this route"});if(f.options.body==="text"&&typeof x!="string")return l({error:"invalid payload",reason:"Payload must be a string for this route"});let y={body:x,http:void 0};try{let r=await f.handler(y);l(r)}catch(r){console.error(r),l({error:"internal error",reason:"Internal error occurred"})}}else l({error:"route error",reason:"Route not found"})}broadcast(f,a){this.wsAuthedClients.forEach(m=>m.send(JSON.stringify({type:f,payload:a})))}stop(){this.server.close()}},Ai={createServer:(f,a)=>new Mi(f,a)},Ri=(f,a)=>{let m=Ni.createServer(Ye,{authorizer:Oi(f),rootPath:"/api/",port:16530}),l=Ai.createServer(Ye,{authorizer:Li(f),rootPath:"/",mountHTTPServer:m.server,connectPayload:a});return{binaryServer:m,broadcastAbleServer:l}},Bi=require("node:crypto"),We=require("node:fs/promises"),Wi=require("node:path"),Di=async()=>{let f=(0,Wi.join)(Fe,"RED_PROTOCOL_TOKEN");try{return(await(0,We.readFile)(f,"utf-8")).trim()}catch{}let a=(0,Bi.randomBytes)(32).toString("hex");return await(0,We.mkdir)(Fe,{recursive:!0}),await(0,We.writeFile)(f,a),a},qi=async()=>{let f=await Di(),{broadcastAbleServer:a,binaryServer:m}=Ri(f,()=>({version:"0.0.37",name:"chronocat",authData})),l=(y,r)=>a.broadcast(y,r),x=si(async({CmdName:y,Payload:r})=>{try{ie.cacheObject(r)}catch{}switch(y){case"nodeIKernelMsgListener/onRecvMsg":{let h=r,e=async c=>{c.chatType===He.ChatType.Group&&await Zt({forceUpdate:!1,groupCode:+c.peerUid,uids:[c.senderUid]})},i=c=>{c.chatType===He.ChatType.Group&&(c.roleType=ue[c.peerUid]?.[c.senderUid])};l("message::recv",await Promise.all(h.msgList.filter(_t).map(async c=>(await e(c),c=await ie.preprocessObject(c),i(c),c))));return}case"nodeIKernelProfileListener/onProfileSimpleChanged":case"nodeIKernelGroupListener/onSearchMemberChange":case"nodeIKernelGroupService/getNextMemberList":{let h=r;h.profiles.get(authData.uid)&&(ht.value=h.profiles.get(authData.uid));let e=h.profiles??h.infos;for(let[i,{uin:c}]of e)ie.addToMap(i,c);return}case"nodeIKernelGroupListener/onMemberInfoChange":{let{groupCode:h,members:e}=r;for(let[i,{uin:c,role:o}]of e)ie.addToMap(i,c),h in ue||(ue[h]={}),ue[h][i]=o;break}case"nodeIKernelGroupListener/onMemberListChange":{let h=r,e=h.info.sceneId.split("_")[0];if(!e)break;for(let[i,{uin:c,role:o}]of h.info.infos)ie.addToMap(i,c),e in ue||(ue[e]={}),ue[e][i]=o;break}case"nodeIKernelMsgListener/onRichMediaDownloadComplete":{let h=r,e=`${h.notifyInfo.msgId}::${h.notifyInfo.msgElementId}`;Pe[e]&&(Pe[e](h.notifyInfo.filePath),delete Pe[e]);return}case"nodeIKernelGroupListener/onGroupListUpdate":{let h=r;for(let e of h.groupList)lt[e.groupCode]=e;return}case"nodeIKernelBuddyListener/onBuddyListChange":{let h=r;for(let e of h.data)for(let i of e.buddyList)i.category=e.categoryName,ct[i.uin]=i;return}}});return()=>{x(),m.stop(),a.stop()}}});var Fi={};Et(Fi,{onLoad:()=>zi});module.exports=Tt(Fi);var bt=Pt(gt()),zi=()=>(0,bt.chronocat)();0&&(module.exports={onLoad});
//# sourceMappingURL=index.js.map
